<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitMeal - AI ì‹ë‹¨ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        /* ê¹œë¹¡ì„ ë°©ì§€ë¥¼ ìœ„í•´ ì´ˆê¸°ì— ìˆ¨ê¹€ */
        body { visibility: hidden; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">

    <div id="app-container">
        <!-- ì´ˆê¸° ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. -->
    </div>

    <!-- Firebase SDK ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        // Firebase v9+ ëª¨ë“ˆëŸ¬ SDK ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserSessionPersistence,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot,
            doc,
            deleteDoc,
            setDoc,
            getDoc,
            writeBatch,
            getDocs
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // ===================================================================================
        // Firebase í”„ë¡œì íŠ¸ ì„¤ì • ê°’
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCRax6rd1rlBIc3kVgg5OkHmSIQyzJmC8A",
            authDomain: "fitmeal-app-d1a97.firebaseapp.com",
            projectId: "fitmeal-app-d1a97",
            storageBucket: "fitmeal-app-d1a97.appspot.com",
            messagingSenderId: "968711774677",
            appId: "1:968711774677:web:b3d3cb9ccc2388c3ba5d5c"
        };

        // ===================================================================================
        // Gemini API í‚¤
        // ===================================================================================
        const GEMINI_API_KEY = "AIzaSyATtInpyR0qJRe2RU5FWiUvMddl36-ZI2E";

        // ===================================================================================
        // !!! ì¤‘ìš”: Firestore ë° Storage ë³´ì•ˆ ê·œì¹™ ì—…ë°ì´íŠ¸ í•„ìš” !!!
        // 1. Firebase ì½˜ì†” > Firestore Database > ê·œì¹™(Rules) íƒ­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì•„ë˜ ê·œì¹™ ë¶™ì—¬ë„£ê¸°
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /users/{userId} {
              allow read, write: if request.auth != null && request.auth.uid == userId;
            }
            match /foodEntries/{entryId} {
              allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
              allow read, delete: if request.auth != null && resource.data.uid == request.auth.uid;
            }
          }
        }
        */
        // 2. Firebase ì½˜ì†” > Storage > ê·œì¹™(Rules) íƒ­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì•„ë˜ ê·œì¹™ ë¶™ì—¬ë„£ê¸°
        /*
        rules_version = '2';
        service firebase.storage {
          match /b/{bucket}/o {
            match /food_images/{userId}/{allPaths=**} {
              allow read, write: if request.auth != null && request.auth.uid == userId;
            }
          }
        }
        */
        // ===================================================================================


        // Firebase ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ ì„¤ì • ---
        setPersistence(auth, browserSessionPersistence)
            .catch((error) => {
                console.error("ì¸ì¦ ìƒíƒœ ì„¤ì • ì‹¤íŒ¨:", error);
            });

        // --- ë‚ ì§œ ê´€ë ¨ í—¬í¼ í•¨ìˆ˜ ---
        const getLocalDateString = (date) => {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- ì•± ìƒíƒœ ê´€ë¦¬ ---
        let state = {
            authReady: false, // ì¸ì¦ ìƒíƒœ í™•ì¸ ì™„ë£Œ ì—¬ë¶€
            currentPage: 'login',
            isLoggedIn: false,
            user: null, 
            userInfo: null, 
            foodEntries: {},
            currentDate: getLocalDateString(new Date()),
            unsubscribeFoodListener: null,
            unsubscribeUserListener: null,
            viewMode: 'list', // 'list' or 'calendar'
            calendarDate: new Date(), // ìº˜ë¦°ë”ê°€ ë³´ì—¬ì£¼ëŠ” ì›”
            foodIdToDelete: null, // ì‚­ì œ í™•ì¸ì„ ìœ„í•œ ID ì €ì¥
            analyzedImageFile: null, // AI ë¶„ì„ì— ì‚¬ìš©ëœ ì´ë¯¸ì§€ íŒŒì¼
        };

        // --- HTML í…œí”Œë¦¿ ---
        const LoadingSpinner = () => `
            <div class="flex items-center justify-center min-h-screen">
                <div class="w-16 h-16 border-4 border-teal-500 border-dashed rounded-full animate-spin"></div>
            </div>
        `;

        const LoginPage = () => `
            <div class="flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
                <div class="w-full max-w-sm">
                    <h1 class="text-4xl font-bold text-center text-teal-500 mb-2">FitMeal</h1>
                    <p class="text-center text-gray-600 mb-8">AI ì‹ë‹¨ ê´€ë¦¬, í”¼íŠ¸ë°€ê³¼ í•¨ê»˜</p>
                    <form id="login-form" class="bg-white shadow-lg rounded-lg px-8 pt-6 pb-8 mb-4">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">ì´ë©”ì¼</label>
                            <input class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" id="email" type="email" placeholder="email@example.com" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="password">ë¹„ë°€ë²ˆí˜¸</label>
                            <input class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" id="password" type="password" placeholder="********" required>
                        </div>
                        <button class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300" type="submit">ë¡œê·¸ì¸</button>
                    </form>
                    <p class="text-center text-gray-500 text-sm">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button onclick="window.navigate('register')" class="font-bold text-teal-500 hover:text-teal-700">íšŒì›ê°€ì…</button></p>
                </div>
            </div>
        `;

        const RegisterPage = () => `
            <div class="flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
                <div class="w-full max-w-sm">
                    <h1 class="text-4xl font-bold text-center text-teal-500 mb-8">íšŒì›ê°€ì…</h1>
                    <form id="register-form" class="bg-white shadow-lg rounded-lg px-8 pt-6 pb-8 mb-4">
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">ì´ë©”ì¼</label><input class="w-full p-3 border border-gray-300 rounded-lg" id="email" type="email" required></div>
                        <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">ë¹„ë°€ë²ˆí˜¸</label><input class="w-full p-3 border border-gray-300 rounded-lg" id="password" type="password" required></div>
                        <button class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg" type="submit">ë‹¤ìŒ</button>
                    </form>
                    <p class="text-center text-gray-500 text-sm">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button onclick="window.navigate('login')" class="font-bold text-teal-500 hover:text-teal-700">ë¡œê·¸ì¸</button></p>
                </div>
            </div>
        `;
        
        const OnboardingPage = () => `
            <div class="flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
                <div class="w-full max-w-md text-center">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">FitMealì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h1>
                    <p class="text-gray-600 mb-8">ì •í™•í•œ ì¶”ì²œì„ ìœ„í•´ ëª©í‘œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</p>
                    <form id="onboarding-form" class="bg-white shadow-lg rounded-lg p-8">
                        <div class="mb-6">
                            <label class="block text-gray-700 text-lg font-bold mb-4">ê°€ì¥ ì¤‘ìš”í•œ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”?</label>
                            <div id="goal-options" class="flex flex-col sm:flex-row justify-center gap-4">
                                <button type="button" data-goal="ì²´ì¤‘ ê°ëŸ‰" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition bg-teal-500 border-teal-500 text-white">ì²´ì¤‘ ê°ëŸ‰</button>
                                <button type="button" data-goal="ì²´ì¤‘ ìœ ì§€" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition border-gray-300 text-gray-700">ì²´ì¤‘ ìœ ì§€</button>
                                <button type="button" data-goal="ê·¼ìœ¡ ì¦ê°€" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition border-gray-300 text-gray-700">ê·¼ìœ¡ ì¦ê°€</button>
                            </div>
                        </div>
                        <button class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg" type="submit">í”¼íŠ¸ë°€ ì‹œì‘í•˜ê¸°</button>
                    </form>
                </div>
            </div>
        `;
        
        const DashboardPage = () => {
            return `
                <div class="min-h-screen bg-gray-50 animate-fade-in">
                    <header class="bg-white shadow-sm sticky top-0 z-10">
                        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                            <h1 onclick="window.goToDashboard()" class="text-2xl font-bold text-teal-500 cursor-pointer">FitMeal</h1>
                            <div class="flex items-center gap-4">
                                <button onclick="window.toggleViewMode()" class="text-sm text-gray-600 hover:text-teal-500">${state.viewMode === 'list' ? 'ìº˜ë¦°ë”' : 'ë©”ì¸'}</button>
                                <button onclick="window.openProfileModal()" class="text-sm text-gray-600 hover:text-teal-500">ì„¤ì •</button>
                                <button onclick="window.handleLogout()" class="text-sm text-gray-600 hover:text-teal-500">ë¡œê·¸ì•„ì›ƒ</button>
                            </div>
                        </div>
                    </header>
                    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                        ${state.viewMode === 'list' ? DailyView() : CalendarView()}
                    </main>
                    <div class="fixed bottom-6 right-6 z-20">
                        <button onclick="window.openModal()" class="bg-teal-500 text-white w-16 h-16 flex items-center justify-center text-3xl rounded-full shadow-lg hover:bg-teal-600 transition duration-300">+</button>
                    </div>
                    <div id="add-food-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        ${AddFoodModal()}
                    </div>
                    <div id="delete-account-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        ${DeleteAccountModal()}
                    </div>
                    <div id="delete-food-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        ${DeleteFoodModal()}
                    </div>
                    <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        ${ProfileModal()}
                    </div>
                </div>
            `;
        };

        const DailyView = () => {
            const dateKey = state.currentDate;
            const todaysEntries = state.foodEntries[dateKey] || [];
            const userInfo = state.userInfo || { goal: 2000, carbsGoal: 250, proteinGoal: 120, fatGoal: 67 };
            
            const totals = todaysEntries.reduce((acc, entry) => {
                acc.calories += entry.calories;
                acc.carbs += entry.carbs;
                acc.protein += entry.protein;
                acc.fat += entry.fat;
                return acc;
            }, { calories: 0, carbs: 0, protein: 0, fat: 0 });

            const meals = { 'ì•„ì¹¨': [], 'ì ì‹¬': [], 'ì €ë…': [], 'ê°„ì‹': [] };
            todaysEntries.forEach(entry => meals[entry.mealType].push(entry));

            const caloriePercentage = userInfo.goal > 0 ? Math.min((totals.calories / userInfo.goal) * 100, 100) : 0;
            const circumference = 2 * Math.PI * 50;
            const strokeDashoffset = circumference - (caloriePercentage / 100) * circumference;

            return `
                <div>
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="window.changeDate(-1)" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold">&lt;</button>
                        <h2 class="text-xl font-semibold text-gray-800">${new Date(dateKey).toLocaleDateString('ko-KR', { timeZone: 'UTC' })}</h2>
                        <button onclick="window.changeDate(1)" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold">&gt;</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <div class="flex flex-col md:flex-row items-center justify-around gap-8">
                            <div class="relative flex items-center justify-center w-48 h-48">
                                <svg class="w-full h-full" viewBox="0 0 120 120">
                                    <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60"/>
                                    <circle class="text-teal-500" stroke-width="10" stroke-dasharray="${circumference}" stroke-dashoffset="${strokeDashoffset}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60" transform="rotate(-90 60 60)"/>
                                </svg>
                                <div class="absolute flex flex-col items-center">
                                    <span class="text-3xl font-bold text-gray-800">${totals.calories}</span>
                                    <span class="text-sm text-gray-500">/ ${userInfo.goal} kcal</span>
                                </div>
                            </div>
                            <div class="w-full md:w-1/2 space-y-4">
                                ${NutrientBar('íƒ„ìˆ˜í™”ë¬¼', totals.carbs, userInfo.carbsGoal, 'bg-orange-500')}
                                ${NutrientBar('ë‹¨ë°±ì§ˆ', totals.protein, userInfo.proteinGoal, 'bg-sky-500')}
                                ${NutrientBar('ì§€ë°©', totals.fat, userInfo.fatGoal, 'bg-amber-400')}
                            </div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        ${Object.entries(meals).map(([mealType, entries]) => MealCard(mealType, entries)).join('')}
                    </div>
                     <footer class="mt-12 text-left">
                        <button onclick="window.openDeleteModal()" class="text-xs text-gray-400 hover:text-red-500 hover:underline">íšŒì› íƒˆí‡´</button>
                    </footer>
                </div>
            `;
        };

        const CalendarView = () => {
            const date = state.calendarDate;
            const year = date.getFullYear();
            const month = date.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 (Sun) to 6 (Sat)
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let calendarHtml = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="window.changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold">&lt;</button>
                        <h2 class="text-xl font-semibold text-gray-800">${year}ë…„ ${month + 1}ì›”</h2>
                        <button onclick="window.changeMonth(1)" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-sm">
                        <div class="font-bold text-red-500 py-2">ì¼</div>
                        <div class="font-bold py-2">ì›”</div>
                        <div class="font-bold py-2">í™”</div>
                        <div class="font-bold py-2">ìˆ˜</div>
                        <div class="font-bold py-2">ëª©</div>
                        <div class="font-bold py-2">ê¸ˆ</div>
                        <div class="font-bold text-blue-500 py-2">í† </div>
            `;

            for (let i = 0; i < firstDayOfWeek; i++) {
                calendarHtml += `<div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = getLocalDateString(new Date(year, month, day));
                const entries = state.foodEntries[dateKey] || [];
                const totalCalories = entries.reduce((sum, entry) => sum + entry.calories, 0);
                
                const isSelected = dateKey === state.currentDate;
                const isToday = dateKey === getLocalDateString(new Date());

                let dayClass = '';
                if (isSelected) dayClass = 'border-2 border-teal-500';
                if (isToday) dayClass = 'bg-teal-500 text-white';

                calendarHtml += `
                    <div onclick="window.selectDateFromCalendar('${dateKey}')" class="cursor-pointer rounded-lg hover:bg-gray-100 p-1 h-24 flex flex-col justify-start">
                        <div class="w-8 h-8 mx-auto flex items-center justify-center rounded-full ${dayClass}">${day}</div>
                        ${totalCalories > 0 ? `<div class="text-xs text-gray-500 mt-1">${totalCalories} kcal</div>` : ''}
                    </div>
                `;
            }

            calendarHtml += `</div></div>`;
            return calendarHtml;
        };

        const NutrientBar = (label, consumed, goal, color) => {
            const percentage = goal > 0 ? Math.min((consumed / goal) * 100, 100) : 0;
            return `
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700">${label}</span>
                        <span class="text-xs text-gray-500">${consumed}g / ${goal}g</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="${color} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        };

        const MealCard = (mealType, entries) => `
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800 mb-4">${mealType}</h3>
                ${entries.length > 0 ? `
                    <ul class="divide-y divide-gray-200">
                        ${entries.map(entry => `
                            <li class="py-3 flex justify-between items-center">
                                <div class="flex items-center gap-4">
                                    <div>
                                        <p class="font-semibold text-gray-700">${entry.name}</p>
                                        <p class="text-sm text-gray-500">${entry.calories} kcal</p>
                                    </div>
                                </div>
                                <button onclick="window.openDeleteFoodModal('${entry.id}')" class="text-red-500 hover:text-red-700 font-bold text-xl">Ã—</button>
                            </li>
                        `).join('')}
                    </ul>
                ` : `<p class="text-gray-500 text-sm">ê¸°ë¡ëœ ì‹ë‹¨ì´ ì—†ì–´ìš”.</p>`}
            </div>
        `;

        const AddFoodModal = () => `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative animate-fade-in">
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 font-bold text-xl">Ã—</button>
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ì‹ë‹¨ ê¸°ë¡í•˜ê¸°</h2>
                
                <div id="ai-section">
                    <div class="mb-4 p-4 border border-dashed rounded-lg text-center">
                        <label for="image-upload" class="cursor-pointer text-teal-500 font-semibold hover:text-teal-600">
                            ğŸ“· ì‚¬ì§„ìœ¼ë¡œ ê¸°ë¡í•˜ê¸°
                        </label>
                        <p class="text-xs text-gray-400 mt-1">(JPG, PNG, WEBP ì§€ì›)</p>
                        <input id="image-upload" type="file" accept="image/*, .jfif" class="hidden">
                        <p id="ai-status" class="text-sm text-gray-500 mt-2"></p>
                    </div>
                    
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                        <div class="relative flex justify-center"><span class="bg-white px-2 text-sm text-gray-500">ë˜ëŠ”</span></div>
                    </div>
                </div>

                <div id="manual-form-section">
                    <form id="add-food-form" class="mt-4">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">ì‹ì‚¬ ì¢…ë¥˜</label>
                            <select id="mealType" class="w-full p-3 border rounded-lg bg-gray-50">
                                <option>ì•„ì¹¨</option><option>ì ì‹¬</option><option>ì €ë…</option><option>ê°„ì‹</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">ìŒì‹ ì´ë¦„</label>
                            <input id="foodName" type="text" placeholder="ì˜ˆ: ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ" class="w-full p-3 border rounded-lg" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-bold mb-2">ì¹¼ë¡œë¦¬ (kcal)</label>
                            <input id="calories" type="number" placeholder="ì˜ˆ: 350" class="w-full p-3 border rounded-lg" required>
                        </div>
                        <button id="add-food-btn" type="submit" class="w-full bg-teal-500 text-white font-bold py-3 rounded-lg hover:bg-teal-600 transition">ê¸°ë¡ ì¶”ê°€</button>
                    </form>
                </div>
            </div>
        `;

        const DeleteAccountModal = () => `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative animate-fade-in text-center">
                 <h2 class="text-2xl font-bold mb-4 text-gray-800">íšŒì› íƒˆí‡´</h2>
                 <p class="text-gray-600 mb-6">ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ëª¨ë“  ì‹ë‹¨ ê¸°ë¡ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                 <div class="flex justify-center gap-4">
                    <button onclick="window.closeDeleteModal()" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300 transition">ì·¨ì†Œ</button>
                    <button onclick="window.confirmDeleteAccount()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">íƒˆí‡´ í™•ì¸</button>
                 </div>
            </div>
        `;
        
        const DeleteFoodModal = () => `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative animate-fade-in text-center">
                 <h2 class="text-2xl font-bold mb-4 text-gray-800">ê¸°ë¡ ì‚­ì œ</h2>
                 <p class="text-gray-600 mb-6">ì •ë§ë¡œ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                 <div class="flex justify-center gap-4">
                    <button onclick="window.closeDeleteFoodModal()" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300 transition">ì·¨ì†Œ</button>
                    <button onclick="window.confirmDeleteFood()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">ì‚­ì œ í™•ì¸</button>
                 </div>
            </div>
        `;

        const ProfileModal = () => `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative animate-fade-in">
                <button onclick="window.closeProfileModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 font-bold text-xl">Ã—</button>
                <h2 class="text-2xl font-bold mb-4 text-gray-800">í”„ë¡œí•„ ì„¤ì •</h2>
                <form id="profile-form">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-lg font-bold mb-4">ëª©í‘œ ë³€ê²½</label>
                        <div id="profile-goal-options" class="flex flex-col sm:flex-row justify-center gap-4">
                            <button type="button" data-goal="ì²´ì¤‘ ê°ëŸ‰" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition">ì²´ì¤‘ ê°ëŸ‰</button>
                            <button type="button" data-goal="ì²´ì¤‘ ìœ ì§€" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition">ì²´ì¤‘ ìœ ì§€</button>
                            <button type="button" data-goal="ê·¼ìœ¡ ì¦ê°€" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition">ê·¼ìœ¡ ì¦ê°€</button>
                        </div>
                    </div>
                    <button class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg" type="submit">ì €ì¥í•˜ê¸°</button>
                </form>
            </div>
        `;
        
        // --- ë Œë”ë§ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        const appContainer = document.getElementById('app-container');

        const render = () => {
            if (!state.authReady) {
                appContainer.innerHTML = LoadingSpinner();
                return;
            }

            let html = '';
            // ë¡œê·¸ì¸ ìƒíƒœì™€ ì‚¬ìš©ì ì •ë³´ ìœ ë¬´ì— ë”°ë¼ í˜ì´ì§€ ê²°ì •
            if (state.isLoggedIn) {
                if (state.userInfo) {
                    html = DashboardPage();
                } else {
                    html = OnboardingPage();
                }
            } else {
                if (state.currentPage === 'register') {
                    html = RegisterPage();
                } else {
                    html = LoginPage();
                }
            }
            appContainer.innerHTML = html;
            addEventListeners();
        };

        const navigate = (page) => {
            state.currentPage = page;
            render();
        };

        const addEventListeners = () => {
            document.getElementById('login-form')?.addEventListener('submit', window.handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', window.handleRegister);
            document.getElementById('onboarding-form')?.addEventListener('submit', window.handleOnboarding);
            document.getElementById('add-food-form')?.addEventListener('submit', window.handleAddFood);
            document.getElementById('image-upload')?.addEventListener('change', window.handleImageUpload);
            document.getElementById('profile-form')?.addEventListener('submit', window.handleUpdateProfile);
            
            if (state.currentPage === 'onboarding' || (state.isLoggedIn && !state.userInfo) || document.getElementById('profile-modal')) {
                 document.querySelectorAll('.goal-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.currentTarget.parentElement.querySelectorAll('.goal-btn').forEach(b => b.classList.remove('bg-teal-500', 'text-white', 'border-teal-500'));
                        e.currentTarget.classList.add('bg-teal-500', 'text-white', 'border-teal-500');
                    });
                });
            }
        };

        // --- AI ë¶„ì„ ë° Firebase ì—°ë™ ë¡œì§ ---
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        const getMimeType = (file) => {
            const extension = file.name.split('.').pop().toLowerCase();
            if (file.type) {
                return file.type;
            }
            switch (extension) {
                case 'jpg':
                case 'jpeg':
                case 'jfif':
                    return 'image/jpeg';
                case 'png':
                    return 'image/png';
                case 'webp':
                    return 'image/webp';
                case 'gif':
                    return 'image/gif';
                default:
                    return 'application/octet-stream';
            }
        };

        window.handleImageUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                alert("Gemini API í‚¤ë¥¼ ì½”ë“œì— ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const statusEl = document.getElementById('ai-status');
            const foodNameInput = document.getElementById('foodName');
            const caloriesInput = document.getElementById('calories');
            const addFoodBtn = document.getElementById('add-food-btn');

            statusEl.textContent = 'AIê°€ ì‚¬ì§„ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            addFoodBtn.disabled = true;
            addFoodBtn.textContent = 'ë¶„ì„ ì¤‘...';

            try {
                const base64Image = await fileToBase64(file);
                const mimeType = getMimeType(file);

                const model = "gemini-1.5-flash-latest";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "ì´ ìŒì‹ ì‚¬ì§„ì„ ë³´ê³  ê°€ì¥ ëŒ€í‘œì ì¸ ìŒì‹ ì´ë¦„ í•œ ê°€ì§€ì™€ 1ì¸ë¶„ ê¸°ì¤€ ì˜ˆìƒ ì¹¼ë¡œë¦¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. ë‹µë³€ì€ 'ìŒì‹ëª…: [ì´ë¦„], ì¹¼ë¡œë¦¬: [ìˆ«ì]' í˜•ì‹ìœ¼ë¡œë§Œ ì •í™•íˆ ë‹µë³€í•´ì£¼ì„¸ìš”." },
                                { inline_data: { mime_type: mimeType, data: base64Image } }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('AI Server Error:', errorData);
                    throw new Error(`AI ì„œë²„ ì˜¤ë¥˜: ${errorData.error.message}`);
                }

                const data = await response.json();
                
                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error('AIê°€ ë¶„ì„ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }

                const text = data.candidates[0].content.parts[0].text;

                const foodNameMatch = text.match(/ìŒì‹ëª…: (.*?)(,|$)/);
                const caloriesMatch = text.match(/ì¹¼ë¡œë¦¬: (\d+)/);

                if (foodNameMatch && caloriesMatch) {
                    const foodName = foodNameMatch[1].trim();
                    const calories = parseInt(caloriesMatch[1]);
                    
                    foodNameInput.value = foodName;
                    caloriesInput.value = calories;
                    statusEl.textContent = `ë¶„ì„ ì™„ë£Œ: ${foodName} (${calories}kcal)`;
                } else {
                    console.warn("AI ì‘ë‹µ í˜•ì‹ ë¶ˆì¼ì¹˜:", text);
                    throw new Error('AIê°€ ìŒì‹ ì •ë³´ë¥¼ ì •í™•íˆ ë¶„ì„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }

            } catch (error) {
                console.error("AI ë¶„ì„ ì˜¤ë¥˜:", error);
                statusEl.textContent = `ë¶„ì„ ì‹¤íŒ¨. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.`;
                alert(`AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                addFoodBtn.disabled = false;
                addFoodBtn.textContent = 'ê¸°ë¡ ì¶”ê°€';
            }
        };

        // --- Firebase CRUD ë° ì¸ì¦ ë¡œì§ ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
            }
        };

        window.handleRegister = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + error.message);
            }
        };
        
        window.handleOnboarding = async (e) => {
            e.preventDefault();
            const selectedGoalEl = document.querySelector('#onboarding-form .goal-btn.bg-teal-500');
            if (!selectedGoalEl) {
                alert("ëª©í‘œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            const selectedGoal = selectedGoalEl.dataset.goal;
            let calorieGoal = 2000;
            if (selectedGoal === 'ì²´ì¤‘ ê°ëŸ‰') calorieGoal = 1800;
            if (selectedGoal === 'ê·¼ìœ¡ ì¦ê°€') calorieGoal = 2500;
            
            const userInfo = {
                goal: calorieGoal,
                carbsGoal: Math.round(calorieGoal * 0.5 / 4),
                proteinGoal: Math.round(calorieGoal * 0.3 / 4),
                fatGoal: Math.round(calorieGoal * 0.2 / 9)
            };
            
            try {
                const userDocRef = doc(db, "users", auth.currentUser.uid);
                await setDoc(userDocRef, userInfo);
            } catch (error) {
                alert("ì •ë³´ ì €ì¥ ì‹¤íŒ¨: " + error.message);
            }
        };

        window.handleUpdateProfile = async (e) => {
            e.preventDefault();
            const selectedGoalEl = document.querySelector('#profile-form .goal-btn.bg-teal-500');
             if (!selectedGoalEl) {
                alert("ìƒˆë¡œìš´ ëª©í‘œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            const selectedGoal = selectedGoalEl.dataset.goal;
            let calorieGoal = 2000;
            if (selectedGoal === 'ì²´ì¤‘ ê°ëŸ‰') calorieGoal = 1800;
            if (selectedGoal === 'ê·¼ìœ¡ ì¦ê°€') calorieGoal = 2500;

            const newUserInfo = {
                goal: calorieGoal,
                carbsGoal: Math.round(calorieGoal * 0.5 / 4),
                proteinGoal: Math.round(calorieGoal * 0.3 / 4),
                fatGoal: Math.round(calorieGoal * 0.2 / 9)
            };

            try {
                const userDocRef = doc(db, "users", auth.currentUser.uid);
                await setDoc(userDocRef, newUserInfo);
                window.closeProfileModal();
            } catch (error) {
                alert("í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + error.message);
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
        };

        const deleteUserData = async (uid) => {
            const batch = writeBatch(db);
            const foodEntriesQuery = query(collection(db, "foodEntries"), where("uid", "==", uid));
            const foodEntriesSnapshot = await getDocs(foodEntriesQuery);
            foodEntriesSnapshot.forEach((doc) => batch.delete(doc.ref));
            const userDocRef = doc(db, "users", uid);
            batch.delete(userDocRef);
            await batch.commit();
        };

        window.confirmDeleteAccount = async () => {
            const user = auth.currentUser;
            if (user) {
                try {
                    await deleteUserData(user.uid);
                    await deleteUser(user);
                    alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (error) {
                    console.error("íšŒì› íƒˆí‡´ ì˜¤ë¥˜:", error);
                    alert(`ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ íƒˆí‡´ë¥¼ ì™„ë£Œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ${error.message}`);
                    if (error.code === 'auth/requires-recent-login') {
                        alert("ë³´ì•ˆì„ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•œ í›„ íšŒì› íƒˆí‡´ë¥¼ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        await signOut(auth);
                    }
                }
            }
        };
        
        window.handleAddFood = async (e) => {
            e.preventDefault();
            const newEntry = {
                uid: auth.currentUser.uid,
                date: state.currentDate,
                name: e.target.foodName.value,
                calories: parseInt(e.target.calories.value),
                mealType: e.target.mealType.value,
                carbs: Math.round(parseInt(e.target.calories.value) * 0.5 / 4),
                protein: Math.round(parseInt(e.target.calories.value) * 0.2 / 4),
                fat: Math.round(parseInt(e.target.calories.value) * 0.3 / 9),
            };
            
            try {
                await addDoc(collection(db, "foodEntries"), newEntry);
                window.closeModal();
            } catch (error) {
                alert("ê¸°ë¡ ì¶”ê°€ ì‹¤íŒ¨: " + error.message);
            }
        };

        window.confirmDeleteFood = async () => {
            if (state.foodIdToDelete) {
                try {
                    await deleteDoc(doc(db, "foodEntries", state.foodIdToDelete));
                } catch (error) {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
                } finally {
                    window.closeDeleteFoodModal();
                }
            }
        };

        const setupListeners = (uid) => {
            if (state.unsubscribeFoodListener) state.unsubscribeFoodListener();
            const foodQuery = query(collection(db, "foodEntries"), where("uid", "==", uid));
            state.unsubscribeFoodListener = onSnapshot(foodQuery, (snapshot) => {
                const allEntries = {};
                snapshot.forEach((doc) => {
                    const entry = { id: doc.id, ...doc.data() };
                    if (!allEntries[entry.date]) allEntries[entry.date] = [];
                    allEntries[entry.date].push(entry);
                });
                state.foodEntries = allEntries;
                if (state.authReady) render();
            });

            if (state.unsubscribeUserListener) state.unsubscribeUserListener();
            const userDocRef = doc(db, "users", uid);
            state.unsubscribeUserListener = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.userInfo = docSnap.data();
                    if (state.authReady) render();
                }
            });
        };

        // --- ì•± ì‹œì‘ ë° ì¸ì¦ ìƒíƒœ ê°ì§€ ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.isLoggedIn = true;
                state.user = user;
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    state.userInfo = docSnap.data();
                    setupListeners(user.uid);
                } else {
                    state.userInfo = null;
                }
            } else {
                if (state.unsubscribeFoodListener) state.unsubscribeFoodListener();
                if (state.unsubscribeUserListener) state.unsubscribeUserListener();
                Object.assign(state, {
                    isLoggedIn: false, user: null, userInfo: null, foodEntries: {},
                    currentPage: 'login', unsubscribeFoodListener: null, unsubscribeUserListener: null,
                });
            }
            state.authReady = true;
            render();
            document.body.style.visibility = 'visible';
        });
        
        // --- ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë…¸ì¶œ ---
        window.navigate = navigate;
        window.changeDate = (amount) => {
            const currentDateObj = new Date(state.currentDate);
            currentDateObj.setDate(currentDateObj.getDate() + amount);
            state.currentDate = getLocalDateString(currentDateObj);
            render();
        };
        window.changeMonth = (amount) => {
            state.calendarDate.setMonth(state.calendarDate.getMonth() + amount);
            render();
        };
        window.selectDateFromCalendar = (dateKey) => {
            state.currentDate = dateKey;
            state.viewMode = 'list';
            render();
        };
        window.toggleViewMode = () => {
            state.viewMode = state.viewMode === 'list' ? 'calendar' : 'list';
            if (state.viewMode === 'calendar') {
                state.calendarDate = new Date(state.currentDate);
            }
            render();
        };
        window.openModal = () => document.getElementById('add-food-modal').classList.remove('hidden');
        window.closeModal = () => {
            document.getElementById('add-food-modal').classList.add('hidden');
            const aiStatus = document.getElementById('ai-status');
            if(aiStatus) aiStatus.textContent = '';
            const imageUpload = document.getElementById('image-upload');
            if(imageUpload) imageUpload.value = '';
        };
        window.openDeleteModal = () => document.getElementById('delete-account-modal').classList.remove('hidden');
        window.closeDeleteModal = () => document.getElementById('delete-account-modal').classList.add('hidden');
        window.openDeleteFoodModal = (id) => {
            state.foodIdToDelete = id;
            document.getElementById('delete-food-modal').classList.remove('hidden');
        };
        window.closeDeleteFoodModal = () => {
            state.foodIdToDelete = null;
            document.getElementById('delete-food-modal').classList.add('hidden');
        };
        window.openProfileModal = () => document.getElementById('profile-modal').classList.remove('hidden');
        window.closeProfileModal = () => document.getElementById('profile-modal').classList.add('hidden');
        window.goToDashboard = () => {
            state.viewMode = 'list';
            state.currentDate = getLocalDateString(new Date());
            render();
        };

    </script>
</body>
</html>
