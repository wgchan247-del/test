<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitMeal - AI ì‹ë‹¨ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        html { font-family: 'Inter', sans-serif; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .btn-interactive { transition: transform 0.1s ease; }
        .btn-interactive:active { transform: scale(0.98); }
        .modal-content-wrapper { max-height: 90vh; overflow-y: auto; }
        @keyframes fade-in-up { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        @keyframes fade-out { to { opacity: 0; } }
        .animate-fade-out { animation: fade-out 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-container"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-[100]"></div>

<script>
    // --- 1. UI ì»´í¬ë„ŒíŠ¸ (ë¶€í’ˆ) ì •ì˜ ---
    const Logo = (sizeClass = "text-4xl") => `<div class="flex items-center justify-center gap-2"><svg class="${sizeClass.replace('text-','w-').replace('4xl','10').replace('2xl','8')} text-teal-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.384,13.823,19.2,11.639,16.8,14.038V3a1,1,0,0,0-2,0v11.038L12.4,11.639,10.216,13.823,15.8,19.4a1,1,0,0,0,1.414,0ZM12,12a1,1,0,0,0-1,1v8a1,1,0,0,0,2,0V13A1,1,0,0,0,12,12ZM7.2,14.038,4.8,11.639,2.616,13.823,8.2,19.4a1,1,0,0,0,1.414,0L11.8,17.239,9.6,15.055,7.2,17.454V3a1,1,0,0,0-2,0Z"/></svg><h1 class="${sizeClass} font-bold text-teal-500">FitMeal</h1></div>`;
    const LoginPage = () => `<div class="flex flex-col items-center justify-center min-h-screen p-4"><div class="w-full max-w-sm"><div class="mb-2">${Logo("text-4xl")}</div><p class="text-center text-gray-600 mb-8">AI ì‹ë‹¨ ê´€ë¦¬, í”¼íŠ¸ë°€ê³¼ í•¨ê»˜</p><form id="login-form" class="bg-white shadow-lg rounded-lg px-8 pt-6 pb-8 mb-4"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="email">ì´ë©”ì¼</label><input class="w-full p-3 border border-gray-300 rounded-lg" id="email" type="email" required></div><div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2" for="password">ë¹„ë°€ë²ˆí˜¸</label><input class="w-full p-3 border border-gray-300 rounded-lg" id="password" type="password" required></div><button id="login-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg btn-interactive" type="submit">ë¡œê·¸ì¸</button></form><p class="text-center text-gray-500 text-sm">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button onclick="App.handlers.navigateTo('register')" class="font-bold text-teal-500 hover:text-teal-700">íšŒì›ê°€ì…</button></p></div></div>`;
    const RegisterPage = () => `<div class="flex flex-col items-center justify-center min-h-screen p-4"><div class="w-full max-w-sm"><h1 class="text-4xl font-bold text-center text-teal-500 mb-8">íšŒì›ê°€ì…</h1><form id="register-form" class="bg-white shadow-lg rounded-lg px-8 pt-6 pb-8 mb-4"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">ì´ë©”ì¼</label><input class="w-full p-3 border border-gray-300 rounded-lg" id="email" type="email" required></div><div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">ë¹„ë°€ë²ˆí˜¸</label><input class="w-full p-3 border border-gray-300 rounded-lg" id="password" type="password" required></div><button class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg btn-interactive" type="submit">ë‹¤ìŒ</button></form><p class="text-center text-gray-500 text-sm">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button onclick="App.handlers.navigateTo('login')" class="font-bold text-teal-500 hover:text-teal-700">ë¡œê·¸ì¸</button></p></div></div>`;
    const OnboardingPage = () => `<div class="flex flex-col items-center justify-center min-h-screen p-4"><div class="w-full max-w-md text-center"><h1 class="text-3xl font-bold text-gray-800 mb-2">FitMealì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h1><p class="text-gray-600 mb-8">ì •í™•í•œ ì¶”ì²œì„ ìœ„í•´ ëª©í‘œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</p><form id="onboarding-form" class="bg-white shadow-lg rounded-lg p-8"><div class="mb-6"><label class="block text-gray-700 text-lg font-bold mb-4">ê°€ì¥ ì¤‘ìš”í•œ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”?</label><div id="goal-options" class="flex flex-col sm:flex-row justify-center gap-4"><button type="button" data-goal="ì²´ì¤‘ ê°ëŸ‰" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition bg-teal-500 border-teal-500 text-white btn-interactive">ì²´ì¤‘ ê°ëŸ‰</button><button type="button" data-goal="ì²´ì¤‘ ìœ ì§€" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition border-gray-300 text-gray-700 btn-interactive">ì²´ì¤‘ ìœ ì§€</button><button type="button" data-goal="ê·¼ìœ¡ ì¦ê°€" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition border-gray-300 text-gray-700 btn-interactive">ê·¼ìœ¡ ì¦ê°€</button></div></div><button class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg btn-interactive" type="submit">í”¼íŠ¸ë°€ ì‹œì‘í•˜ê¸°</button></form></div></div>`;
    const DashboardPage = (state) => { if (!state.user) return `<div class="flex items-center justify-center min-h-screen"><p>ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>`; const dateKey = state.currentDate; const todaysEntries = state.foodEntries[dateKey] || []; const totals = todaysEntries.reduce((a, e) => ({ calories: a.calories + (e.calories||0), carbs: a.carbs + (e.carbs||0), protein: a.protein + (e.protein||0), fat: a.fat + (e.fat||0) }), { calories:0, carbs:0, protein:0, fat:0 }); const meals = { 'ì•„ì¹¨':[],'ì ì‹¬':[],'ì €ë…':[],'ê°„ì‹':[]}; todaysEntries.forEach(e => meals[e.mealType]?.push(e)); const caloriePercentage = state.user.goal > 0 ? Math.min((totals.calories/state.user.goal)*100, 100) : 0; const circ = 2 * Math.PI * 50; const offset = circ - (caloriePercentage/100) * circ; return `<div class="min-h-screen bg-gray-50"><header class="bg-white shadow-sm sticky top-0 z-10"><div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center"><div class="flex items-center gap-4">${Logo("text-2xl")}<button id="settings-btn" class="text-sm text-gray-600 hover:text-teal-500 btn-interactive">í”„ë¡œí•„ ì„¤ì •</button></div><button id="logout-btn" class="text-sm text-gray-600 hover:text-teal-500 btn-interactive">ë¡œê·¸ì•„ì›ƒ</button></div></header><main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8"><div class="flex items-center justify-between mb-6"><button id="prev-date-btn" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold btn-interactive">&lt;</button><h2 class="text-xl font-semibold text-gray-800">${new Date(dateKey + 'T00:00:00').toLocaleDateString('ko-KR')}</h2><button id="next-date-btn" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold btn-interactive">&gt;</button></div><div class="bg-white p-6 rounded-lg shadow-md mb-8"><div class="flex flex-col md:flex-row items-center justify-around gap-8"><div class="relative flex items-center justify-center w-48 h-48"><svg class="w-full h-full" viewBox="0 0 120 120"><circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60"/><circle class="text-teal-500" stroke-width="10" stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60" transform="rotate(-90 60 60)"/></svg><div class="absolute flex flex-col items-center"><span class="text-3xl font-bold text-gray-800">${Math.round(totals.calories)}</span><span class="text-sm text-gray-500">/ ${state.user.goal||2000} kcal</span></div></div><div class="w-full md:w-1/2 space-y-4">${NutrientBar('íƒ„ìˆ˜í™”ë¬¼',totals.carbs,state.user.carbsGoal||0,'bg-orange-500')}${NutrientBar('ë‹¨ë°±ì§ˆ',totals.protein,state.user.proteinGoal||0,'bg-sky-500')}${NutrientBar('ì§€ë°©',totals.fat,state.user.fatGoal||0,'bg-amber-400')}</div></div></div><div class="space-y-6">${Object.entries(meals).map(([type, entries]) => MealCard(type, entries)).join('')}</div></main><div class="fixed bottom-6 right-6"><button id="add-food-btn" class="bg-teal-500 text-white w-16 h-16 flex items-center justify-center text-3xl rounded-full shadow-lg hover:bg-teal-600 transition duration-300 btn-interactive">+</button></div><div id="add-food-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 flex items-center justify-center z-50">${AddFoodModal()}</div><div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 flex items-center justify-center z-50">${SettingsModal(state)}</div></div>`; };
    const NutrientBar = (label, consumed, goal, color) => { const percentage = goal > 0 ? Math.min((consumed/goal)*100, 100) : 0; return `<div><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-gray-700">${label}</span><span class="text-xs text-gray-500">${Math.round(consumed)}g / ${goal}g</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${color} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`; };
    const MealCard = (mealType, entries) => `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-bold text-gray-800 mb-4">${mealType}</h3>${entries.length > 0 ? `<ul class="divide-y divide-gray-200">${entries.map(entry => `<li class="py-3 flex justify-between items-center"><div><p class="font-semibold text-gray-700">${entry.name}</p><p class="text-xs text-gray-400 mt-1">íƒ„: ${entry.carbs || 0}g ãƒ» ë‹¨: ${entry.protein || 0}g ãƒ» ì§€: ${entry.fat || 0}g</p></div><div class="text-right"><p class="font-semibold text-gray-700">${entry.calories} kcal</p><button onclick="App.handlers.deleteFood('${entry.id}')" class="text-red-500 hover:text-red-700 text-xl leading-none mt-1 btn-interactive">Ã—</button></div></li>`).join('')}</ul>` : `<p class="text-gray-500 text-sm">ê¸°ë¡ëœ ì‹ë‹¨ì´ ì—†ì–´ìš”.</p>`}</div>`;
    const AddFoodModal = () => `<div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content-wrapper"><div class="p-6 relative"><button id="close-add-food-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 font-bold text-2xl z-10">Ã—</button><h2 class="text-2xl font-bold mb-4 text-gray-800">ì‹ë‹¨ ê¸°ë¡</h2><div id="modal-step-1"><div class="mb-4"><label class="block text-sm font-bold mb-2">ì‹ì‚¬ ì¢…ë¥˜</label><select id="mealType-select" class="w-full p-3 border rounded-lg bg-gray-50"><option>ì•„ì¹¨</option><option>ì ì‹¬</option><option>ì €ë…</option><option>ê°„ì‹</option></select></div><div class="mb-4"><label class="block text-sm font-bold mb-2" for="food-image-input">ìŒì‹ ì‚¬ì§„ ì—…ë¡œë“œ</label><input type="file" id="food-image-input" accept="image/jpeg, image/png, image/webp" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"><img id="image-preview" class="hidden rounded-lg mt-4 w-full h-auto object-cover"/></div><button id="ai-suggest-btn" class="w-full bg-teal-500 text-white font-bold py-3 rounded-lg hover:bg-teal-600 transition btn-interactive">AIë¡œ ìŒì‹ ì¶”ì²œë°›ê¸°</button><p class="text-center text-sm text-gray-500 my-4">ë˜ëŠ”</p><button id="manual-entry-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition btn-interactive">ì§ì ‘ ì…ë ¥í•˜ê¸°</button></div><div id="modal-step-2" class="hidden"><div id="editable-food-list"></div><div class="mt-4"><button id="add-food-item-btn" class="w-full text-sm text-teal-600 font-semibold py-2">+ í•­ëª© ì¶”ê°€</button></div><hr class="my-4"><button id="calculate-nutrition-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 btn-interactive">ì˜ì–‘ ì •ë³´ ê³„ì‚°</button></div><div id="modal-step-3" class="hidden"><div id="final-results-container"></div><button id="record-btn" class="w-full bg-sky-500 text-white font-bold py-3 rounded-lg hover:bg-sky-600 transition mt-4 btn-interactive">ì´ëŒ€ë¡œ ê¸°ë¡í•˜ê¸°</button></div><div id="modal-loading" class="hidden"><div class="flex flex-col items-center justify-center p-8"><svg class="animate-spin h-8 w-8 text-teal-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-center text-gray-500">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ¤–</p></div></div></div>`;
    const EditableFoodList = (items) => `<h4 class="font-bold mb-2 text-gray-700">AI ì¶”ì²œ ëª©ë¡ (ìˆ˜ì • ê°€ëŠ¥)</h4><ul class="space-y-2">${items.map((item, index) => `<li class="flex items-center gap-2"><input type="text" class="food-name-input w-full p-2 border rounded-lg" value="${item}"><button onclick="this.parentElement.remove()" class="text-red-500 p-2 btn-interactive">Ã—</button></li>`).join('')}</ul>`;
    const FinalResultList = (foodItems) => `<h4 class="font-bold mb-2 text-gray-700">ìµœì¢… ë¶„ì„ ê²°ê³¼</h4><ul class="space-y-2">${foodItems.map((item, index) => `<li class="flex items-center p-3 bg-gray-50 rounded-lg"><input id="food-${index}" type="checkbox" class="h-5 w-5 rounded text-teal-500 focus:ring-teal-400" data-name="${item.name||''}" data-calories="${item.calories||0}" data-carbs="${item.carbs||0}" data-protein="${item.protein||0}" data-fat="${item.fat||0}" checked><label for="food-${index}" class="ml-3"><span class="font-semibold">${item.name||'ì´ë¦„ì—†ìŒ'}</span><span class="text-sm text-gray-500"> - ${item.calories||0} kcal</span></label></li>`).join('')}</ul>`;
    const SettingsModal = (state) => {
        if (!state.user) return '';
        const currentGoal = state.user.goalDescription || '';
        const isSelected = (goal) => goal === currentGoal ? 'bg-teal-500 border-teal-500 text-white' : 'border-gray-300 text-gray-700';
        return `<div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content-wrapper animate-fade-in-up">
            <div class="p-6 relative">
                <button id="close-settings-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 font-bold text-2xl z-10">Ã—</button>
                <h2 class="text-2xl font-bold mb-6 text-gray-800">í”„ë¡œí•„ ì„¤ì •</h2>
                <div class="mb-6">
                    <label class="block text-gray-700 text-lg font-bold mb-4">ëª©í‘œ ë³€ê²½</label>
                    <div id="settings-goal-options" class="flex flex-col sm:flex-row justify-center gap-4">
                        <button type="button" data-goal="ì²´ì¤‘ ê°ëŸ‰" class="settings-goal-btn w-full p-4 border-2 rounded-lg font-semibold transition btn-interactive ${isSelected('ì²´ì¤‘ ê°ëŸ‰')}">ì²´ì¤‘ ê°ëŸ‰</button>
                        <button type="button" data-goal="ì²´ì¤‘ ìœ ì§€" class="settings-goal-btn w-full p-4 border-2 rounded-lg font-semibold transition btn-interactive ${isSelected('ì²´ì¤‘ ìœ ì§€')}">ì²´ì¤‘ ìœ ì§€</button>
                        <button type="button" data-goal="ê·¼ìœ¡ ì¦ê°€" class="settings-goal-btn w-full p-4 border-2 rounded-lg font-semibold transition btn-interactive ${isSelected('ê·¼ìœ¡ ì¦ê°€')}">ê·¼ìœ¡ ì¦ê°€</button>
                    </div>
                </div>
                <button id="save-settings-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg btn-interactive">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>`;
    };

    // =================================================================
    // ğŸš€ 2. ì•± ë©”ì¸ ë¡œì§
    // =================================================================
    const App = {
        config: {
            firebase: { apiKey: "AIzaSyCRax6rd1rlBIc3kVgg5OkHmSIQyzJmC8A", authDomain: "fitmeal-app-d1a97.firebaseapp.com", projectId: "fitmeal-app-d1a97", storageBucket: "fitmeal-app-d1a97.appspot.com", messagingSenderId: "968711774677", appId: "1:968711774677:web:b3d3cb9ccc2388c3ba5d5c" },
            proxyServerUrl: "http://127.0.0.1:5000" 
        },
        state: { currentPage: 'loading', isLoading: true, user: null, foodEntries: {}, currentDate: new Date().toISOString().split('T')[0] },

        init() {
            firebase.initializeApp(this.config.firebase);
            this.auth = firebase.auth();
            this.db = firebase.firestore();
            this.auth.onAuthStateChanged(this.handlers.onAuthStateChanged.bind(this));
            this.render();
        },

        setState(newState) { this.state = { ...this.state, ...newState }; window.requestAnimationFrame(() => this.render()); },
        render() {
            const { currentPage, isLoading } = this.state;
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;
            if (isLoading) { appContainer.innerHTML = `<div class="flex items-center justify-center min-h-screen"><p class="text-gray-500">FitMealì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p></div>`; return; }
            let pageHtml = '';
            switch(currentPage) {
                case 'login': pageHtml = LoginPage(); break;
                case 'register': pageHtml = RegisterPage(); break;
                case 'onboarding': pageHtml = OnboardingPage(); break;
                case 'dashboard': pageHtml = DashboardPage(this.state); break;
                default: pageHtml = `<div class="p-4 text-center">í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
            appContainer.innerHTML = pageHtml;
            this.addEventListeners();
        },

        addEventListeners() {
            const { currentPage } = this.state;
            if (currentPage === 'login') document.getElementById('login-form')?.addEventListener('submit', this.handlers.handleLogin.bind(this));
            if (currentPage === 'register') document.getElementById('register-form')?.addEventListener('submit', this.handlers.handleRegister.bind(this));
            if (currentPage === 'onboarding') {
                document.getElementById('onboarding-form')?.addEventListener('submit', this.handlers.handleOnboarding.bind(this));
                document.querySelectorAll('.goal-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.goal-btn').forEach(b => {
                        b.classList.remove('bg-teal-500', 'text-white', 'border-teal-500');
                        b.classList.add('border-gray-300', 'text-gray-700');
                    });
                    e.currentTarget.classList.add('bg-teal-500', 'text-white', 'border-teal-500');
                    e.currentTarget.classList.remove('border-gray-300', 'text-gray-700');
                }));
            }
            if (currentPage === 'dashboard') {
                // Dashboard-specific event listeners
                document.getElementById('settings-btn')?.addEventListener('click', () => App.handlers.openSettingsModal());
                document.getElementById('logout-btn')?.addEventListener('click', () => App.handlers.handleLogout());
                document.getElementById('add-food-btn')?.addEventListener('click', () => App.handlers.openModal());
                document.getElementById('prev-date-btn')?.addEventListener('click', () => App.handlers.changeDate(-1));
                document.getElementById('next-date-btn')?.addEventListener('click', () => App.handlers.changeDate(1));
                
                // Add Food Modal listeners
                document.getElementById('close-add-food-modal-btn')?.addEventListener('click', () => App.handlers.closeModal());
                document.getElementById('food-image-input')?.addEventListener('change', this.handlers.handleImagePreview);
                document.getElementById('ai-suggest-btn')?.addEventListener('click', this.handlers.handlePhotoSuggestion.bind(this));
                document.getElementById('manual-entry-btn')?.addEventListener('click', this.handlers.handleManualSuggestion.bind(this));
                document.getElementById('calculate-nutrition-btn')?.addEventListener('click', this.handlers.handleNutritionCalculation.bind(this));
                document.getElementById('record-btn')?.addEventListener('click', this.handlers.handleAddSelectedFoods.bind(this));
                document.getElementById('add-food-item-btn')?.addEventListener('click', this.handlers.addEditableFoodItem);

                // Settings Modal listeners
                document.getElementById('close-settings-modal-btn')?.addEventListener('click', App.handlers.closeSettingsModal);
                document.getElementById('save-settings-btn')?.addEventListener('click', this.handlers.handleSaveSettings.bind(this));
                document.querySelectorAll('.settings-goal-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.settings-goal-btn').forEach(b => {
                        b.classList.remove('bg-teal-500', 'text-white', 'border-teal-500');
                        b.classList.add('border-gray-300', 'text-gray-700');
                    });
                    e.currentTarget.classList.add('bg-teal-500', 'text-white', 'border-teal-500');
                    e.currentTarget.classList.remove('border-gray-300', 'text-gray-700');
                }));
            }
        },

        handlers: {
            async onAuthStateChanged(firebaseUser) {
                try {
                    if (firebaseUser) {
                        const userProfile = await App.api.getUserProfile(firebaseUser.uid);
                        const user = userProfile ? { uid: firebaseUser.uid, email: firebaseUser.email, ...userProfile } : { uid: firebaseUser.uid, email: firebaseUser.email };
                        const foodEntries = await App.api.getFoodEntries(user.uid, App.state.currentDate);
                        App.setState({ user, foodEntries: { [App.state.currentDate]: foodEntries }, isLoading: false, currentPage: user.goal ? 'dashboard' : 'onboarding' });
                    } else {
                        App.setState({ user: null, isLoading: false, currentPage: 'login' });
                    }
                } catch (error) {
                    console.error("ì¸ì¦ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:", error);
                    document.getElementById('app-container').innerHTML = `<div class="p-4 text-center text-red-500">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</div>`;
                }
            },
            navigateTo(page) { App.setState({ currentPage: page }); },
            handleImagePreview(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); const preview = document.getElementById('image-preview'); if (preview) { reader.onload = (event) => { preview.src = event.target.result; preview.classList.remove('hidden'); }; reader.readAsDataURL(file); } },
            async handleLogin(e) { e.preventDefault(); const btn = document.getElementById('login-btn'); btn.disabled = true; btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...'; try { await App.api.signIn(e.target.email.value, e.target.password.value); } catch (error) { App.handlers.showToast(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`); btn.disabled = false; btn.textContent = 'ë¡œê·¸ì¸'; } },
            async handleRegister(e) { e.preventDefault(); const btn = e.target.querySelector('button'); btn.disabled = true; try { await App.api.register(e.target.email.value, e.target.password.value); } catch (error) { App.handlers.showToast(error.message); btn.disabled = false; } },
            handleLogout() { App.auth.signOut(); },
            async handleOnboarding(e) {
                e.preventDefault();
                const el = document.querySelector('.goal-btn.bg-teal-500');
                if (!el) { App.handlers.showToast('ëª©í‘œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
                const goalDescription = el.dataset.goal;
                let goal = 2000;
                if (goalDescription === 'ì²´ì¤‘ ê°ëŸ‰') goal = 1800;
                if (goalDescription === 'ê·¼ìœ¡ ì¦ê°€') goal = 2500;
                const userData = {
                    goalDescription,
                    goal,
                    carbsGoal: Math.round(goal * 0.5 / 4),
                    proteinGoal: Math.round(goal * 0.3 / 4),
                    fatGoal: Math.round(goal * 0.2 / 9)
                };
                await App.api.updateUserProfile(this.state.user.uid, userData);
            },
            
            // âœ… BUG FIX: ë¡œë”© í•¨ìˆ˜ê°€ ë‹¤ë¥¸ ë‹¨ê³„ì˜ í™”ë©´ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ ìˆ˜ì •
            showLoading(show) {
                const loadingEl = document.getElementById('modal-loading');
                const step1El = document.getElementById('modal-step-1');
                const step2El = document.getElementById('modal-step-2');
                const step3El = document.getElementById('modal-step-3');

                if (show) {
                    loadingEl?.classList.remove('hidden');
                    step1El?.classList.add('hidden');
                    step2El?.classList.add('hidden');
                    step3El?.classList.add('hidden');
                } else {
                    loadingEl?.classList.add('hidden');
                }
            },
            
            showToast(message, type = 'error', duration = 3000) {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
                toast.className = `p-4 ${bgColor} text-white rounded-lg shadow-lg mb-2 animate-fade-in-up`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('animate-fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                }, duration);
            },
            
            confirmAction(message) {
                return new Promise((resolve) => {
                    const modalHTML = `
                        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 p-4 flex items-center justify-center z-[101]" role="alertdialog" aria-modal="true" aria-labelledby="confirmation-title">
                            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 animate-fade-in-up">
                                <h3 id="confirmation-title" class="text-lg font-bold mb-4">í™•ì¸</h3>
                                <p class="text-gray-600 mb-6">${message}</p>
                                <div class="flex justify-end gap-4">
                                    <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 btn-interactive">ì·¨ì†Œ</button>
                                    <button id="confirm-ok-btn" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 btn-interactive">í™•ì¸</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    const modal = document.getElementById('confirmation-modal');
                    const closeModal = (result) => { modal?.remove(); resolve(result); };
                    document.getElementById('confirm-ok-btn')?.addEventListener('click', () => closeModal(true));
                    document.getElementById('confirm-cancel-btn')?.addEventListener('click', () => closeModal(false));
                });
            },

            // âœ… BUG FIX: ë¡œë”© í•¨ìˆ˜ ìˆ˜ì •ì— ë§ì¶° í•¸ë“¤ëŸ¬ ë¡œì§ ë³€ê²½
            async handlePhotoSuggestion() {
                const fileInput = document.getElementById('food-image-input');
                if (!fileInput.files.length) {
                    this.handlers.showToast('ë¶„ì„í•  ìŒì‹ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                    return;
                }
                this.handlers.showLoading(true);
                try {
                    const foodNames = await App.api.suggestFoodsFromPhoto(fileInput.files[0]);
                    if (!foodNames || foodNames.length === 0) {
                        throw new Error("AIê°€ ì‚¬ì§„ì—ì„œ ìŒì‹ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    }
                    const editableList = document.getElementById('editable-food-list');
                    editableList.innerHTML = EditableFoodList(foodNames);
                    document.getElementById('modal-step-2').classList.remove('hidden');
                } catch (error) {
                    this.handlers.showToast(`AI ì¶”ì²œ ì‹¤íŒ¨: ${error.message}`);
                    // ì‹¤íŒ¨ ì‹œ 1ë‹¨ê³„ë¡œ ë³µê·€
                    document.getElementById('modal-step-1').classList.remove('hidden');
                } finally {
                    this.handlers.showLoading(false);
                }
            },
            
            handleManualSuggestion() {
                const editableList = document.getElementById('editable-food-list');
                editableList.innerHTML = EditableFoodList(["", "", ""]);
                document.getElementById('modal-step-1').classList.add('hidden');
                document.getElementById('modal-step-2').classList.remove('hidden');
            },

            addEditableFoodItem() {
                const list = document.querySelector('#editable-food-list ul');
                if(!list) return;
                const newItem = document.createElement('li');
                newItem.className = 'flex items-center gap-2';
                newItem.innerHTML = `<input type="text" class="food-name-input w-full p-2 border rounded-lg" value=""><button onclick="this.parentElement.remove()" class="text-red-500 p-2 btn-interactive">Ã—</button>`;
                list.appendChild(newItem);
            },

            // âœ… BUG FIX: ë¡œë”© í•¨ìˆ˜ ìˆ˜ì •ì— ë§ì¶° í•¸ë“¤ëŸ¬ ë¡œì§ ë³€ê²½
            async handleNutritionCalculation() {
                const inputs = document.querySelectorAll('.food-name-input');
                const foodList = Array.from(inputs).map(input => input.value).filter(value => value.trim() !== '');
                if (foodList.length === 0) {
                    this.handlers.showToast('ë¶„ì„í•  ìŒì‹ì„ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                this.handlers.showLoading(true);
                try {
                    const foodItems = await App.api.analyzeText(foodList.join(', '));
                    if (!foodItems || foodItems.length === 0) {
                        throw new Error("AIê°€ ìœ íš¨í•œ ì˜ì–‘ ì •ë³´ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    }
                    const finalResults = document.getElementById('final-results-container');
                    finalResults.innerHTML = FinalResultList(foodItems);
                    document.getElementById('modal-step-3').classList.remove('hidden');
                } catch (error) {
                    this.handlers.showToast(`ì˜ì–‘ ì •ë³´ ê³„ì‚° ì‹¤íŒ¨: ${error.message}`);
                     // ì‹¤íŒ¨ ì‹œ 2ë‹¨ê³„ë¡œ ë³µê·€
                    document.getElementById('modal-step-2').classList.remove('hidden');
                } finally {
                    this.handlers.showLoading(false);
                }
            },

            async handleAddSelectedFoods() { const sel = document.querySelectorAll('#final-results-container input:checked'); if (!sel.length) { this.handlers.showToast('ê¸°ë¡í•  ìŒì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; } const btn = document.getElementById('record-btn'); btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...'; const mealType = document.getElementById('mealType-select').value; const entries = Array.from(sel).map(cb => ({ name: cb.dataset.name, calories: parseInt(cb.dataset.calories), carbs: parseInt(cb.dataset.carbs), protein: parseInt(cb.dataset.protein), fat: parseInt(cb.dataset.fat), mealType })); try { await App.api.addFoodEntries(this.state.user.uid, this.state.currentDate, entries); } catch(e) { this.handlers.showToast('ì €ì¥ ì‹¤íŒ¨: '+e.message); btn.disabled = false; btn.textContent = 'ì´ëŒ€ë¡œ ê¸°ë¡í•˜ê¸°'; } },
            async deleteFood(id) { const confirmed = await App.handlers.confirmAction('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'); if (confirmed) { await App.api.deleteFoodEntry(App.state.user.uid, App.state.currentDate, id); const newEntries = await App.api.getFoodEntries(App.state.user.uid, App.state.currentDate); App.setState({ foodEntries: { ...App.state.foodEntries, [App.state.currentDate]: newEntries } }); }},
            async changeDate(amount) { const d = new Date(App.state.currentDate); d.setDate(d.getDate() + amount); const newDate = d.toISOString().split('T')[0]; const newEntries = await App.api.getFoodEntries(App.state.user.uid, newDate); App.setState({ currentDate: newDate, foodEntries: { ...App.state.foodEntries, [newDate]: newEntries } }); },
            openModal() {
                // ëª¨ë‹¬ì„ ì—´ ë•Œ ìƒíƒœ ì´ˆê¸°í™”
                document.getElementById('modal-step-1')?.classList.remove('hidden');
                document.getElementById('modal-step-2')?.classList.add('hidden');
                document.getElementById('modal-step-3')?.classList.add('hidden');
                document.getElementById('modal-loading')?.classList.add('hidden');
                const preview = document.getElementById('image-preview');
                if (preview) {
                    preview.src = '';
                    preview.classList.add('hidden');
                }
                const fileInput = document.getElementById('food-image-input');
                if(fileInput) fileInput.value = '';

                document.getElementById('settings-modal')?.classList.add('hidden'); 
                document.getElementById('add-food-modal')?.classList.remove('hidden');
            },
            closeModal() { 
                document.getElementById('add-food-modal')?.classList.add('hidden'); 
            },
            openSettingsModal() {
                document.getElementById('add-food-modal')?.classList.add('hidden'); 
                document.getElementById('settings-modal')?.classList.remove('hidden');
            },
            closeSettingsModal() { 
                document.getElementById('settings-modal')?.classList.add('hidden'); 
            },
            async handleSaveSettings() {
                const btn = document.getElementById('save-settings-btn');
                if (btn) btn.disabled = true;

                const el = document.querySelector('.settings-goal-btn.bg-teal-500');
                if (!el) {
                    App.handlers.showToast('ìƒˆë¡œìš´ ëª©í‘œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    if (btn) btn.disabled = false;
                    return;
                }

                const goalDescription = el.dataset.goal;
                let goal = 2000;
                if (goalDescription === 'ì²´ì¤‘ ê°ëŸ‰') goal = 1800;
                if (goalDescription === 'ê·¼ìœ¡ ì¦ê°€') goal = 2500;
                
                const userData = {
                    goalDescription,
                    goal,
                    carbsGoal: Math.round(goal * 0.5 / 4),
                    proteinGoal: Math.round(goal * 0.3 / 4),
                    fatGoal: Math.round(goal * 0.2 / 9)
                };
                
                try {
                    await App.api.updateUserProfile(App.state.user.uid, userData);
                    App.handlers.showToast('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    App.handlers.closeSettingsModal();
                } catch (error) {
                    App.handlers.showToast(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`);
                } finally {
                    if (btn) btn.disabled = false;
                }
            },
        },

        api: {
            async signIn(email, password) { return App.auth.signInWithEmailAndPassword(email, password); },
            async register(email, password) { const cred = await App.auth.createUserWithEmailAndPassword(email, password); return App.db.collection('users').doc(cred.user.uid).set({ email: cred.user.email, name: 'ìƒˆ ì‚¬ìš©ì' }); },
            async getUserProfile(uid) { const doc = await App.db.collection('users').doc(uid).get(); return doc.exists ? doc.data() : null; },
            async updateUserProfile(uid, data) { await App.db.collection('users').doc(uid).set(data, { merge: true }); App.setState({ user: { ...App.state.user, ...data }}); },
            async getFoodEntries(uid, date) { const snapshot = await App.db.collection('users').doc(uid).collection(date).orderBy('createdAt').get(); return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); },
            async addFoodEntries(uid, date, entries) { const batch = App.db.batch(); const ref = App.db.collection('users').doc(uid).collection(date); entries.forEach(entry => { entry.createdAt = firebase.firestore.FieldValue.serverTimestamp(); batch.set(ref.doc(), entry); }); await batch.commit(); App.handlers.closeModal(); const newEntries = await App.api.getFoodEntries(uid, date); App.setState({ foodEntries: { ...App.state.foodEntries, [date]: newEntries } }); },
            async deleteFoodEntry(uid, date, entryId) { return App.db.collection('users').doc(uid).collection(date).doc(entryId).delete(); },
            
            async suggestFoodsFromPhoto(file) {
                const formData = new FormData();
                formData.append('image', file);
                const response = await fetch(`${App.config.proxyServerUrl}/api/suggest-foods-from-photo`, { 
                    method: 'POST', 
                    body: formData 
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    return data.foodNames;
                } else {
                    throw new Error(data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
            async analyzeText(text) {
                const response = await fetch(`${App.config.proxyServerUrl}/api/analyze-text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    return data.nutritionInfo;
                } else {
                    throw new Error(data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
        },
    };
    
    App.init();
</script>
</body>
</html>

