<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitMeal - AI 식단 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">

    <div id="app-container">
        <!-- 초기 로딩 화면 -->
        <div class="flex items-center justify-center min-h-screen">
            <p class="text-gray-500">앱을 불러오는 중입니다...</p>
        </div>
    </div>

    <!-- Firebase SDK 스크립트 -->
    <script type="module">
        // Firebase v9+ 모듈러 SDK 임포트
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot,
            doc,
            deleteDoc,
            setDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ===================================================================================
        // 중요! 여기에 자신의 Firebase 프로젝트 설정 값을 붙여넣으세요.
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCRax6rd1rlBIc3kVgg5OkHmSIQyzJmC8A",
            authDomain: "fitmeal-app-d1a97.firebaseapp.com",
            projectId: "fitmeal-app-d1a97",
            storageBucket: "fitmeal-app-d1a97.firebasestorage.app",
            messagingSenderId: "968711774677",
            appId: "1:968711774677:web:b3d3cb9ccc2388c3ba5d5c"
            };

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 앱 상태 관리 ---
        let state = {
            currentPage: 'loading',
            isLoggedIn: false,
            user: null, // Firebase auth user 객체
            userInfo: null, // Firestore에 저장된 사용자 정보
            foodEntries: {},
            currentDate: new Date().toISOString().split('T')[0],
            unsubscribeFoodListener: null, // 실시간 리스너 구독 해제 함수
        };

        // --- HTML 템플릿 ---
        const LoginPage = () => `...`; // (이전과 동일, 생략)
        const RegisterPage = () => `...`; // (이전과 동일, 생략)
        const OnboardingPage = () => `...`; // (이전과 동일, 생략)
        
        const DashboardPage = () => {
            const dateKey = state.currentDate;
            const todaysEntries = state.foodEntries[dateKey] || [];
            const userInfo = state.userInfo || { goal: 2000, carbsGoal: 250, proteinGoal: 120, fatGoal: 67 };
            
            const totals = todaysEntries.reduce((acc, entry) => {
                acc.calories += entry.calories;
                acc.carbs += entry.carbs;
                acc.protein += entry.protein;
                acc.fat += entry.fat;
                return acc;
            }, { calories: 0, carbs: 0, protein: 0, fat: 0 });

            const meals = { '아침': [], '점심': [], '저녁': [], '간식': [] };
            todaysEntries.forEach(entry => meals[entry.mealType].push(entry));

            const caloriePercentage = userInfo.goal > 0 ? Math.min((totals.calories / userInfo.goal) * 100, 100) : 0;
            const circumference = 2 * Math.PI * 50;
            const strokeDashoffset = circumference - (caloriePercentage / 100) * circumference;

            return `
                <div class="min-h-screen bg-gray-50 animate-fade-in">
                    <header class="bg-white shadow-sm sticky top-0 z-10">
                        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-teal-500">FitMeal</h1>
                            <button onclick="window.handleLogout()" class="text-sm text-gray-600 hover:text-teal-500">로그아웃</button>
                        </div>
                    </header>
                    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="window.changeDate(-1)" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold">&lt;</button>
                            <h2 class="text-xl font-semibold text-gray-800">${new Date(dateKey + 'T00:00:00').toLocaleDateString('ko-KR')}</h2>
                            <button onclick="window.changeDate(1)" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold">&gt;</button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                            <div class="flex flex-col md:flex-row items-center justify-around gap-8">
                                <div class="relative flex items-center justify-center w-48 h-48">
                                    <svg class="w-full h-full" viewBox="0 0 120 120">
                                        <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60"/>
                                        <circle class="text-teal-500" stroke-width="10" stroke-dasharray="${circumference}" stroke-dashoffset="${strokeDashoffset}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60" transform="rotate(-90 60 60)"/>
                                    </svg>
                                    <div class="absolute flex flex-col items-center">
                                        <span class="text-3xl font-bold text-gray-800">${totals.calories}</span>
                                        <span class="text-sm text-gray-500">/ ${userInfo.goal} kcal</span>
                                    </div>
                                </div>
                                <div class="w-full md:w-1/2 space-y-4">
                                    ${NutrientBar('탄수화물', totals.carbs, userInfo.carbsGoal, 'bg-orange-500')}
                                    ${NutrientBar('단백질', totals.protein, userInfo.proteinGoal, 'bg-sky-500')}
                                    ${NutrientBar('지방', totals.fat, userInfo.fatGoal, 'bg-amber-400')}
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            ${Object.entries(meals).map(([mealType, entries]) => MealCard(mealType, entries)).join('')}
                        </div>
                    </main>
                    <div class="fixed bottom-6 right-6">
                        <button onclick="window.openModal()" class="bg-teal-500 text-white w-16 h-16 flex items-center justify-center text-3xl rounded-full shadow-lg hover:bg-teal-600 transition duration-300">+</button>
                    </div>
                    <div id="add-food-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        ${AddFoodModal()}
                    </div>
                </div>
            `;
        };
        
        // --- 렌더링 및 이벤트 핸들러 ---
        const appContainer = document.getElementById('app-container');

        const render = () => {
            let html = '';
            if (state.currentPage === 'loading') {
                html = `<div class="flex items-center justify-center min-h-screen"><p class="text-gray-500">로딩 중...</p></div>`;
            } else if (state.isLoggedIn) {
                if (state.userInfo) {
                    html = DashboardPage();
                } else {
                    html = OnboardingPage();
                }
            } else {
                if (state.currentPage === 'register') {
                    html = RegisterPage();
                } else {
                    html = LoginPage();
                }
            }
            appContainer.innerHTML = html;
            addEventListeners();
        };

        const navigate = (page) => {
            state.currentPage = page;
            render();
        };

        const addEventListeners = () => {
            document.getElementById('login-form')?.addEventListener('submit', window.handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', window.handleRegister);
            document.getElementById('onboarding-form')?.addEventListener('submit', window.handleOnboarding);
            document.getElementById('add-food-form')?.addEventListener('submit', window.handleAddFood);
            
            if (state.currentPage === 'onboarding' || (state.isLoggedIn && !state.userInfo)) {
                 document.querySelectorAll('.goal-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.goal-btn').forEach(b => b.classList.remove('bg-teal-500', 'text-white', 'border-teal-500'));
                        e.currentTarget.classList.add('bg-teal-500', 'text-white', 'border-teal-500');
                    });
                });
            }
        };

        // --- Firebase 연동 로직 ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged가 나머지를 처리
            } catch (error) {
                alert("로그인 실패: " + error.message);
            }
        };

        window.handleRegister = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged가 나머지를 처리
            } catch (error) {
                alert("회원가입 실패: " + error.message);
            }
        };
        
        window.handleOnboarding = async (e) => {
            e.preventDefault();
            const selectedGoal = document.querySelector('.goal-btn.bg-teal-500').dataset.goal;
            let calorieGoal = 2000;
            if (selectedGoal === '체중 감량') calorieGoal = 1800;
            if (selectedGoal === '근육 증가') calorieGoal = 2500;
            
            const userInfo = {
                goal: calorieGoal,
                carbsGoal: Math.round(calorieGoal * 0.5 / 4),
                proteinGoal: Math.round(calorieGoal * 0.3 / 4),
                fatGoal: Math.round(calorieGoal * 0.2 / 9)
            };
            
            try {
                // Firestore에 사용자 정보 저장
                const userDocRef = doc(db, "users", auth.currentUser.uid);
                await setDoc(userDocRef, userInfo);
                state.userInfo = userInfo;
                render();
            } catch (error) {
                alert("정보 저장 실패: " + error.message);
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            // onAuthStateChanged가 나머지를 처리
        };
        
        window.handleAddFood = async (e) => {
            e.preventDefault();
            const newEntry = {
                uid: auth.currentUser.uid,
                date: state.currentDate,
                name: e.target.foodName.value,
                calories: parseInt(e.target.calories.value),
                mealType: e.target.mealType.value,
                carbs: Math.round(parseInt(e.target.calories.value) * 0.5 / 4),
                protein: Math.round(parseInt(e.target.calories.value) * 0.2 / 4),
                fat: Math.round(parseInt(e.target.calories.value) * 0.3 / 9),
            };
            
            try {
                await addDoc(collection(db, "foodEntries"), newEntry);
                closeModal();
            } catch (error) {
                alert("기록 추가 실패: " + error.message);
            }
        };

        window.deleteFood = async (id) => {
            try {
                await deleteDoc(doc(db, "foodEntries", id));
            } catch (error) {
                alert("삭제 실패: " + error.message);
            }
        };

        const setupFoodListener = (uid) => {
            if (state.unsubscribeFoodListener) {
                state.unsubscribeFoodListener(); // 이전 리스너 구독 해제
            }
            const q = query(collection(db, "foodEntries"), where("uid", "==", uid));
            state.unsubscribeFoodListener = onSnapshot(q, (querySnapshot) => {
                const allEntries = {};
                querySnapshot.forEach((doc) => {
                    const entry = { id: doc.id, ...doc.data() };
                    if (!allEntries[entry.date]) {
                        allEntries[entry.date] = [];
                    }
                    allEntries[entry.date].push(entry);
                });
                state.foodEntries = allEntries;
                render(); // 데이터 변경 시 다시 렌더링
            });
        };

        // --- 앱 시작 및 인증 상태 감지 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 사용자가 로그인한 경우
                state.isLoggedIn = true;
                state.user = user;
                
                // Firestore에서 사용자 정보 가져오기
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    state.userInfo = docSnap.data();
                    setupFoodListener(user.uid); // 실시간 식단 리스너 설정
                } else {
                    state.userInfo = null; // 온보딩 필요
                }
            } else {
                // 사용자가 로그아웃한 경우
                if (state.unsubscribeFoodListener) state.unsubscribeFoodListener();
                state = {
                    ...state,
                    isLoggedIn: false,
                    user: null,
                    userInfo: null,
                    foodEntries: {},
                    currentPage: 'login',
                    unsubscribeFoodListener: null,
                };
            }
            render();
        });
        
        // 전역 스코프에 함수 노출
        window.navigate = navigate;
        window.changeDate = (amount) => {
            const currentDateObj = new Date(state.currentDate + 'T00:00:00');
            currentDateObj.setDate(currentDateObj.getDate() + amount);
            state.currentDate = currentDateObj.toISOString().split('T')[0];
            render();
        };
        window.openModal = () => document.getElementById('add-food-modal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('add-food-modal').classList.add('hidden');
        
        // LoginPage, RegisterPage 등 이전과 동일한 HTML 템플릿 함수들을 여기에 포함시켜야 합니다.
        // ... (이전 코드의 템플릿 함수들) ...

    </script>
</body>
</html>
