<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”¼íŠ¸ë°€ - ë‚˜ë§Œì˜ AI ì˜ì–‘ì‚¬</title>
    <meta name="google-adsense-account" content="ca-pub-8389343171492169">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 
        â†“â†“â†“ STEP 1: êµ¬ê¸€ ì• ë“œì„¼ìŠ¤ ì½”ë“œ (1/2) â†“â†“â†“
    -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8389343171492169"
     crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FFFBF9; /* Very light pink background */
        }
        .font-jua {
            font-family: 'Jua', sans-serif;
        }
        .meal-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .meal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(236, 128, 128, 0.15);
        }
        .nutrient-ring {
            --size: 80px;
            --thickness: 8px;
            width: var(--size);
            height: var(--size);
            position: relative;
            display: inline-grid;
            place-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .nutrient-ring::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: conic-gradient(var(--color, #f43f5e) calc(var(--p, 0) * 1%), #fce7f3 0);
            border-radius: 50%;
            mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            -webkit-mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            transition: background 0.5s ease-in-out;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .custom-shadow {
            box-shadow: 0 4px 12px 0 rgba(236, 128, 128, 0.1);
        }
        .dashed-border {
             background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%23FBCFE8FF' stroke-width='4' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .calendar-day {
            transition: background-color 0.2s ease-in-out;
        }
        .premium-crown {
            filter: drop-shadow(0 2px 4px rgba(252, 211, 77, 0.6));
        }
        .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.1em; font-weight: 600; }
        .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
    </style>
</head>
<body class="text-slate-700">

    <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ë·° -->
    <div id="auth-view" class="fixed inset-0 bg-rose-50 flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-sm p-8 bg-white rounded-3xl shadow-xl">
            <div class="flex justify-center mb-4">
                <div class="w-16 h-16 bg-rose-500 rounded-full flex items-center justify-center shadow-lg shadow-rose-200">
                    <svg class="w-8 h-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.362-3.797z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214C14.267 4.43 13.18 4 12 4a8.25 8.25 0 00-5.962 2.952 8.287 8.287 0 014.9-2.313 8.983 8.983 0 003.362 2.575z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a8.25 8.25 0 005.962-2.952 8.286 8.286 0 01-4.9 2.312 8.983 8.983 0 01-3.362-2.575M15.362 5.214a8.252 8.252 0 0112 21" />
                    </svg>
                </div>
            </div>
            <h1 class="text-4xl font-jua text-rose-500 text-center">í”¼íŠ¸ë°€</h1>
            <p class="text-slate-500 text-center mb-8">ë‚˜ë§Œì˜ AI ì˜ì–‘ì‚¬, í”¼íŠ¸ë°€</p>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-slate-600">ì´ë©”ì¼</label>
                    <input type="email" id="email" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-slate-600">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="submit" id="login-btn" class="w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition">ë¡œê·¸ì¸</button>
                    <button type="button" id="register-btn" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition">íšŒì›ê°€ì…</button>
                </div>
            </form>
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="w-full border-t border-slate-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="bg-white px-2 text-slate-500">ë˜ëŠ”</span>
                </div>
            </div>
            <button id="google-login-btn" class="w-full bg-white border border-slate-300 text-slate-700 py-3 rounded-full font-semibold hover:bg-slate-50 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 36.49 44 30.861 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
            <div class="mt-6 text-center text-xs text-slate-400">
                <a href="#" id="terms-link" class="underline hover:text-slate-600">ì´ìš©ì•½ê´€</a>
                <span class="mx-2">|</span>
                <a href="#" id="privacy-link" class="underline hover:text-slate-600">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a>
            </div>
        </div>
    </div>

    <div id="app-view" class="hidden max-w-4xl mx-auto p-4 md:p-6">
        <!-- í—¤ë” -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-jua text-rose-500">í”¼íŠ¸ë°€ ğŸ¥—</h1>
            <div class="flex items-center gap-4">
                 <button id="calendar-toggle-button" class="text-gray-400 hover:text-rose-500">
                    <!-- ì•„ì´ì½˜ì€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë™ì ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤ -->
                </button>
                <button id="profile-button" class="text-gray-400 hover:text-rose-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                    </svg>
                </button>
                 <button id="logout-button" class="text-gray-400 hover:text-rose-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
        <main id="dashboard-view" class="space-y-8">
            <!-- í”„ë¡œí•„ ì„¤ì • ìœ ë„ ë©”ì‹œì§€ -->
            <section id="welcome-message" class="hidden bg-white p-6 rounded-3xl custom-shadow text-center">
                <h2 class="text-2xl font-jua text-rose-600 mb-2">í”¼íŠ¸ë°€ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                <p class="text-slate-600 mb-4">ì •í™•í•œ AI ì‹ë‹¨ ì¶”ì²œì„ ìœ„í•´ í”„ë¡œí•„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
                <button id="setup-profile-btn" class="bg-rose-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-rose-600 transition">
                    í”„ë¡œí•„ ì„¤ì • ì‹œì‘í•˜ê¸°
                </button>
            </section>

            <!-- ì¼ì¼ ì„­ì·¨ í˜„í™© -->
            <section id="nutrition-progress" class="bg-white p-6 rounded-3xl custom-shadow">
                <h2 class="text-xl font-jua text-rose-600 mb-4">ì˜¤ëŠ˜ì˜ ì˜ì–‘ ì²´í¬ ğŸ“Š</h2>
                <div id="progress-content" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <!-- Nutrients rings here -->
                    <div class="flex flex-col items-center"><div id="calories-ring" class="nutrient-ring" style="--color: #f43f5e; --p: 0;"><span id="calories-current">0</span><small class="text-slate-400">/ <span id="calories-goal">0</span></small></div><p class="mt-2 font-semibold">ì¹¼ë¡œë¦¬ (kcal)</p></div><div class="flex flex-col items-center"><div id="carbs-ring" class="nutrient-ring" style="--color: #2dd4bf; --p: 0;"><span id="carbs-current">0</span><small class="text-slate-400">/ <span id="carbs-goal">0</span></small></div><p class="mt-2 font-semibold">íƒ„ìˆ˜í™”ë¬¼ (g)</p></div><div class="flex flex-col items-center"><div id="protein-ring" class="nutrient-ring" style="--color: #fb923c; --p: 0;"><span id="protein-current">0</span><small class="text-slate-400">/ <span id="protein-goal">0</span></small></div><p class="mt-2 font-semibold">ë‹¨ë°±ì§ˆ (g)</p></div><div class="flex flex-col items-center"><div id="fat-ring" class="nutrient-ring" style="--color: #a78bfa; --p: 0;"><span id="fat-current">0</span><small class="text-slate-400">/ <span id="fat-goal">0</span></small></div><p class="mt-2 font-semibold">ì§€ë°© (g)</p></div>
                </div>
            </section>

            <!-- ì˜¤ëŠ˜ ì„­ì·¨ ê¸°ë¡ -->
            <section id="daily-intake-log">
                <h2 class="text-xl font-jua text-rose-600 mb-4">ì˜¤ëŠ˜ì˜ ë‹¤ì´ì–´íŠ¸ ê¸°ë¡ ğŸ“</h2>
                <div id="daily-intake-list" class="space-y-3 mb-4">
                    <!-- ì„­ì·¨ ê¸°ë¡ ì•„ì´í…œ -->
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="add-food-button" class="w-full bg-white border-2 border-dashed border-rose-200 text-rose-500 py-3 rounded-2xl font-semibold hover:bg-rose-50 hover:border-rose-400 transition duration-300">
                        + ì§ì ‘ ì…ë ¥
                    </button>
                    <button id="add-photo-button" class="w-full bg-rose-500 text-white py-3 rounded-2xl font-semibold hover:bg-rose-600 transition duration-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                        AI ì¹´ë©”ë¼ë¡œ ê¸°ë¡
                    </button>
                </div>
            </section>
            
            <!-- ì˜¤ëŠ˜ ìš´ë™ ê¸°ë¡ -->
            <section id="daily-exercise-log">
                <h2 class="text-xl font-jua text-rose-600 mb-4">ì˜¤ëŠ˜ ìš´ë™ ê¸°ë¡ ğŸ‹ï¸â€â™€ï¸</h2>
                <div id="daily-exercise-list" class="space-y-3 mb-4">
                    <!-- ìš´ë™ ê¸°ë¡ ì•„ì´í…œ -->
                </div>
                <button id="add-exercise-button" class="w-full bg-white border-2 border-dashed border-teal-200 text-teal-500 py-3 rounded-2xl font-semibold hover:bg-teal-50 hover:border-teal-400 transition duration-300">
                    + ìš´ë™ ì¶”ê°€í•˜ê¸°
                </button>
            </section>

            <!-- AI ì¶”ì²œ ì‹ë‹¨ -->
            <section id="meal-plan">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-jua text-rose-600">AI ì¶”ì²œ ì‹ë‹¨ âœ¨</h2>
                    <button id="generate-plan-button" class="bg-rose-500 text-white px-5 py-2 rounded-full font-semibold hover:bg-rose-600 transition duration-300 disabled:bg-rose-300 shadow-sm shadow-rose-200">
                        ìƒˆ ì‹ë‹¨ ë°›ê¸°
                    </button>
                </div>
                <div id="meal-plan-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                 <div id="loader" class="hidden text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-rose-500"></div><p class="mt-4 text-slate-500">AIê°€ ë§ì¶¤ ì‹ë‹¨ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p></div>
            </section>
            
            <!-- ë¬¼ ì„­ì·¨ëŸ‰ ì¶”ì  -->
            <section id="water-tracker" class="bg-white p-6 rounded-3xl custom-shadow">
                <h2 class="text-xl font-jua text-rose-600 mb-4">ìˆ˜ë¶„ ì„­ì·¨ ğŸ’§</h2>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-3xl font-bold text-sky-500"><span id="water-intake">0</span> / <span id="water-goal">8</span> ì”</p>
                        <p class="text-slate-400 text-sm">2L ëª©í‘œ (1ì” = 250ml)</p>
                    </div>
                    <div class="flex space-x-2">
                        <button id="add-water-button" class="bg-sky-400 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl font-bold hover:bg-sky-500 transition shadow-sm shadow-sky-200">+</button>
                        <button id="remove-water-button" class="bg-slate-100 text-slate-500 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 transition">-</button>
                    </div>
                </div>
            </section>
            
            <!-- ê´‘ê³  ë°°ë„ˆ -->
            <section id="ad-banner-container" class="mt-8 flex justify-center items-center h-24 bg-slate-100 rounded-2xl">
                <!-- 
                    â†“â†“â†“ STEP 2: êµ¬ê¸€ ì• ë“œì„¼ìŠ¤ ì½”ë“œ (2/2) â†“â†“â†“
                    êµ¬ê¸€ ì• ë“œì„¼ìŠ¤ì—ì„œ ìƒì„±í•œ 'ê´‘ê³  ë‹¨ìœ„' ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
                    <ins class="adsbygoogle" ...></ins>
                    <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
                -->
                <p class="text-slate-400 text-sm">ê´‘ê³ ê°€ í‘œì‹œë  ê³µê°„ì…ë‹ˆë‹¤.</p>
            </section>

        </main>

        <!-- ìº˜ë¦°ë” ë·° -->
        <section id="calendar-view" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-3xl custom-shadow">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-rose-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h2 id="calendar-month-year" class="text-xl font-jua text-rose-600"></h2>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-rose-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-slate-500 mb-2">
                    <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                    <!-- Calendar days will be generated here -->
                </div>
            </div>
             <!-- í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥ ì„¹ì…˜ -->
            <div id="premium-section" class="bg-white p-6 rounded-3xl custom-shadow text-center">
                 <h2 class="text-xl font-jua text-rose-600 mb-4">ğŸ’ í”¼íŠ¸ë°€ í”„ë¦¬ë¯¸ì—„</h2>
                 <p class="text-slate-600 mb-4">í”„ë¦¬ë¯¸ì—„ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ê³  ê´‘ê³  ì—†ì´ ë” ìƒì„¸í•œ ë¦¬í¬íŠ¸ë¥¼ ë°›ì•„ë³´ì„¸ìš”!</p>
                 <button id="report-btn" class="w-full bg-amber-400 text-amber-900 py-3 rounded-full font-semibold hover:bg-amber-500 transition duration-300 flex items-center justify-center gap-2">
                    <span class="premium-crown">ğŸ‘‘</span> ìƒì„¸ ë¦¬í¬íŠ¸ ë³´ê¸°
                 </button>
            </div>
        </section>

    </div>

    <!-- ì‚¬ìš©ì ì •ë³´ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-rose-600 mb-6 text-center">ë‚´ ì •ë³´ ì…ë ¥</h2>
            <form id="profile-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4"><div><label for="gender" class="block text-sm font-medium text-slate-600">ì„±ë³„</label><select id="gender" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500"><option value="female">ì—¬ì„±</option><option value="male">ë‚¨ì„±</option><option value="unspecified">ì„ íƒ ì•ˆí•¨</option></select></div><div><label for="age" class="block text-sm font-medium text-slate-600">ë‚˜ì´</label><input type="number" id="age" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" placeholder="ì„¸"></div></div><div class="grid grid-cols-2 gap-4"><div><label for="height" class="block text-sm font-medium text-slate-600">ì‹ ì¥</label><input type="number" id="height" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" placeholder="cm"></div><div><label for="weight" class="block text-sm font-medium text-slate-600">ì²´ì¤‘</label><input type="number" id="weight" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" placeholder="kg"></div></div><div><label for="activity" class="block text-sm font-medium text-slate-600">í™œë™ëŸ‰</label><select id="activity" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500"><option value="1.2">ê±°ì˜ ì—†ìŒ</option><option value="1.375">ê°€ë²¼ìš´ í™œë™</option><option value="1.55">ë³´í†µ í™œë™</option><option value="1.725">ë†’ì€ í™œë™</option><option value="1.9">ë§¤ìš° ë†’ì€ í™œë™</option></select></div><div><label for="goal" class="block text-sm font-medium text-slate-600">ëª©í‘œ</label><select id="goal" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500"><option value="loss">ì²´ì¤‘ ê°ëŸ‰</option><option value="maintain">ì²´ì¤‘ ìœ ì§€</option><option value="gain">ì²´ì¤‘ ì¦ê°€</option></select></div><div class="pt-4"><button type="submit" class="w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition duration-300">ì €ì¥í•˜ê¸°</button></div>
            </form>
        </div>
    </div>
    
    <!-- ìŒì‹ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="add-food-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-rose-600 mb-6 text-center">ìŒì‹ ê¸°ë¡í•˜ê¸°</h2>
            <form id="add-food-form" class="space-y-4">
                <label for="manual-photo-input" class="cursor-pointer">
                    <div id="manual-image-preview" class="w-full h-32 bg-rose-50 rounded-2xl flex flex-col items-center justify-center text-rose-400 dashed-border">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        <p class="mt-2 text-sm font-semibold">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</p>
                    </div>
                </label>
                <input type="file" id="manual-photo-input" accept="image/*" class="hidden">
                
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-2">
                        <label for="food-name" class="block text-sm font-medium text-slate-600">ìŒì‹ ì´ë¦„</label>
                        <input type="text" id="food-name" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required>
                    </div>
                    <div>
                        <label for="food-weight" class="block text-sm font-medium text-slate-600">ì–‘ (g)</label>
                        <input type="number" id="food-weight" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required>
                    </div>
                </div>
                 <button type="button" id="calculate-nutrients-btn" class="w-full bg-rose-100 text-rose-600 py-2.5 rounded-lg text-sm font-semibold hover:bg-rose-200">AI ì˜ì–‘ì†Œ ìë™ ê³„ì‚°</button>
                
                <div id="nutrient-loader" class="hidden text-center py-2">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-rose-500"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="food-calories" class="block text-sm font-medium text-slate-600">ì¹¼ë¡œë¦¬ (kcal)</label><input type="number" id="food-calories" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required></div>
                    <div><label for="food-protein" class="block text-sm font-medium text-slate-600">ë‹¨ë°±ì§ˆ (g)</label><input type="number" id="food-protein" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="food-carbs" class="block text-sm font-medium text-slate-600">íƒ„ìˆ˜í™”ë¬¼ (g)</label><input type="number" id="food-carbs" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required></div>
                    <div><label for="food-fat" class="block text-sm font-medium text-slate-600">ì§€ë°© (g)</label><input type="number" id="food-fat" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required></div>
                </div>
                <div class="pt-4 flex space-x-3">
                    <button type="button" id="cancel-add-food" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ì·¨ì†Œ</button>
                    <button type="submit" class="w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition duration-300">ê¸°ë¡í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ìš´ë™ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="add-exercise-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-rose-600 mb-6 text-center">ìš´ë™ ê¸°ë¡í•˜ê¸°</h2>
            <form id="add-exercise-form" class="space-y-4">
                <div>
                    <label for="exercise-name" class="block text-sm font-medium text-slate-600">ìš´ë™ ì´ë¦„</label>
                    <input type="text" id="exercise-name" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required placeholder="ì˜ˆ: ë‹¬ë¦¬ê¸°, ìš”ê°€">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="exercise-duration" class="block text-sm font-medium text-slate-600">ìš´ë™ ì‹œê°„ (ë¶„)</label>
                        <input type="number" id="exercise-duration" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required>
                    </div>
                    <div>
                        <label for="exercise-calories" class="block text-sm font-medium text-slate-600">ì†Œëª¨ ì¹¼ë¡œë¦¬ (kcal)</label>
                        <input type="number" id="exercise-calories" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required>
                    </div>
                </div>
                <div class="pt-4 flex space-x-3">
                    <button type="button" id="cancel-add-exercise" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ì·¨ì†Œ</button>
                    <button type="submit" class="w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition duration-300">ê¸°ë¡í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>


    <!-- AI ì‚¬ì§„ ë¶„ì„ ëª¨ë‹¬ -->
    <div id="photo-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-rose-600 mb-6 text-center">AI ìŒì‹ ë¶„ì„</h2>
            <div id="photo-upload-view">
                <label for="photo-input" class="cursor-pointer">
                    <div id="image-preview" class="w-full h-48 bg-rose-50 rounded-2xl flex flex-col items-center justify-center text-rose-400 dashed-border">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="mt-2 font-semibold">ì‚¬ì§„ì„ ì—¬ê¸°ì— ì˜¬ë ¤ì£¼ì„¸ìš”</p>
                    </div>
                </label>
                <input type="file" id="photo-input" accept="image/*" class="hidden">
                <button id="analyze-photo-button" class="mt-4 w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition duration-300 disabled:bg-rose-300">
                    ë¶„ì„ ì‹œì‘í•˜ê¸°
                </button>
            </div>
            <div id="photo-loading-view" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-rose-500"></div>
                <p class="mt-4 text-slate-500">AIê°€ ì‚¬ì§„ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</p>
            </div>
            <div id="photo-result-view" class="hidden">
                <!-- AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
             <button type="button" id="cancel-photo-analysis" class="mt-4 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ìº˜ë¦°ë” ìƒì„¸ ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="calendar-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 id="calendar-detail-title" class="text-2xl font-jua text-rose-600 mb-6 text-center"></h2>
            <div id="calendar-detail-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- ì„­ì·¨ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <button type="button" id="close-calendar-detail" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ë‹«ê¸°</button>
        </div>
    </div>
    
    <!-- í”„ë¦¬ë¯¸ì—„ êµ¬ë… ìœ ë„ ëª¨ë‹¬ -->
    <div id="premium-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300 text-center">
            <h2 class="text-2xl font-jua text-rose-600 mb-4">ğŸ’ í”¼íŠ¸ë°€ í”„ë¦¬ë¯¸ì—„</h2>
            <p class="text-slate-600 mb-6">ìƒì„¸ ë¦¬í¬íŠ¸ ê¸°ëŠ¥ì€ í”„ë¦¬ë¯¸ì—„ êµ¬ë…ì ì „ìš©ì…ë‹ˆë‹¤. ì§€ê¸ˆ êµ¬ë…í•˜ê³  ëª¨ë“  ê¸°ëŠ¥ì„ ì œí•œ ì—†ì´ ì´ìš©í•´ ë³´ì„¸ìš”!</p>
            <button id="subscribe-now-btn" class="w-full bg-amber-400 text-amber-900 py-3 rounded-full font-semibold hover:bg-amber-500 transition duration-300">
                í”„ë¦¬ë¯¸ì—„ êµ¬ë…í•˜ê¸°
            </button>
             <button type="button" id="close-premium-modal" class="mt-4 w-full text-slate-500 py-2 rounded-full font-semibold hover:bg-slate-100 transition duration-300">ë‚˜ì¤‘ì— í• ê²Œìš”</button>
        </div>
    </div>

    <!-- ì´ìš©ì•½ê´€ ëª¨ë‹¬ -->
    <div id="terms-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-2xl p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-rose-600 mb-6 text-center">ì´ìš©ì•½ê´€</h2>
            <div class="prose prose-sm max-h-96 overflow-y-auto text-slate-600">
                <h3>ì œ1ì¡° (ëª©ì )</h3>
                <p>ë³¸ ì•½ê´€ì€ í”¼íŠ¸ë°€(ì´í•˜ "íšŒì‚¬")ê°€ ì œê³µí•˜ëŠ” í”¼íŠ¸ë°€ ì„œë¹„ìŠ¤ ë° ê´€ë ¨ ì œë°˜ ì„œë¹„ìŠ¤(ì´í•˜ "ì„œë¹„ìŠ¤")ì˜ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ íšŒì‚¬ì™€ íšŒì›ê³¼ì˜ ê¶Œë¦¬, ì˜ë¬´ ë° ì±…ì„ì‚¬í•­, ê¸°íƒ€ í•„ìš”í•œ ì‚¬í•­ì„ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
                <h3>ì œ2ì¡° (ì •ì˜)</h3>
                <p>ë³¸ ì•½ê´€ì—ì„œ ì‚¬ìš©í•˜ëŠ” ìš©ì–´ì˜ ì •ì˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.<br>1. "ì„œë¹„ìŠ¤"ë¼ í•¨ì€ íšŒì›ì´ PC, íœ´ëŒ€í˜• ë‹¨ë§ê¸° ë“± ê°ì¢… ìœ ë¬´ì„  ì¥ì¹˜ë¥¼ í†µí•˜ì—¬ ì´ìš©í•  ìˆ˜ ìˆëŠ” í”¼íŠ¸ë°€ ë° ê´€ë ¨ ì œë°˜ ì„œë¹„ìŠ¤ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.<br>2. "íšŒì›"ì´ë¼ í•¨ì€ íšŒì‚¬ì˜ ì„œë¹„ìŠ¤ì— ì ‘ì†í•˜ì—¬ ë³¸ ì•½ê´€ì— ë”°ë¼ íšŒì‚¬ì™€ ì´ìš©ê³„ì•½ì„ ì²´ê²°í•˜ê³  íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ê³ ê°ì„ ë§í•©ë‹ˆë‹¤.</p>
                <h3>ì œ3ì¡° (íšŒì›ì˜ ì˜ë¬´)</h3>
                <p>íšŒì›ì€ ë‹¤ìŒ í–‰ìœ„ë¥¼ í•˜ì—¬ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.<br>1. ì‹ ì²­ ë˜ëŠ” ë³€ê²½ ì‹œ í—ˆìœ„ ë‚´ìš©ì˜ ë“±ë¡<br>2. íƒ€ì¸ì˜ ì •ë³´ ë„ìš©<br>3. íšŒì‚¬ê°€ ê²Œì‹œí•œ ì •ë³´ì˜ ë³€ê²½<br>4. ê¸°íƒ€ ë¶ˆë²•ì ì´ê±°ë‚˜ ë¶€ë‹¹í•œ í–‰ìœ„</p>
                <hr>
                <p class="text-xs text-center">ë³¸ ì•½ê´€ì€ ìƒ˜í”Œì´ë©°, ì‹¤ì œ ì„œë¹„ìŠ¤ ìš´ì˜ ì‹œì—ëŠ” ë²•ë¥  ì „ë¬¸ê°€ì˜ ê²€í† ë¥¼ ê±°ì¹œ í›„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</p>
            </div>
            <button type="button" id="close-terms-modal" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ëª¨ë‹¬ -->
    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-2xl p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-rose-600 mb-6 text-center">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</h2>
            <div class="prose prose-sm max-h-96 overflow-y-auto text-slate-600">
                <h3>1. ì´ì¹™</h3>
                <p>í”¼íŠ¸ë°€(ì´í•˜ "íšŒì‚¬")ëŠ” ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì¤‘ìš”ì‹œí•˜ë©°, "ì •ë³´í†µì‹ ë§ ì´ìš©ì´‰ì§„ ë° ì •ë³´ë³´í˜¸"ì— ê´€í•œ ë²•ë¥ ì„ ì¤€ìˆ˜í•˜ê³  ìˆìŠµë‹ˆë‹¤. íšŒì‚¬ëŠ” ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì„ í†µí•˜ì—¬ ì´ìš©ìê°€ ì œê³µí•˜ëŠ” ê°œì¸ì •ë³´ê°€ ì–´ë– í•œ ìš©ë„ì™€ ë°©ì‹ìœ¼ë¡œ ì´ìš©ë˜ê³  ìˆìœ¼ë©°, ê°œì¸ì •ë³´ë³´í˜¸ë¥¼ ìœ„í•´ ì–´ë– í•œ ì¡°ì¹˜ê°€ ì·¨í•´ì§€ê³  ìˆëŠ”ì§€ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</p>
                <h3>2. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ í•­ëª©</h3>
                <p>íšŒì‚¬ëŠ” íšŒì›ê°€ì…, ìƒë‹´, ì„œë¹„ìŠ¤ ì‹ ì²­ ë“±ì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>- í•„ìˆ˜í•­ëª© : ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸<br>- ì„ íƒí•­ëª© : ì„±ë³„, ë‚˜ì´, í‚¤, ì²´ì¤‘, í™œë™ëŸ‰, ëª©í‘œ</p>
                <h3>3. ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ë° ì´ìš© ëª©ì </h3>
                <p>íšŒì‚¬ëŠ” ìˆ˜ì§‘í•œ ê°œì¸ì •ë³´ë¥¼ ë‹¤ìŒì˜ ëª©ì ì„ ìœ„í•´ í™œìš©í•©ë‹ˆë‹¤.<br>- ì„œë¹„ìŠ¤ ì œê³µì— ê´€í•œ ê³„ì•½ ì´í–‰ ë° ì„œë¹„ìŠ¤ ì œê³µì— ë”°ë¥¸ ìš”ê¸ˆì •ì‚°<br>- íšŒì› ê´€ë¦¬: íšŒì›ì œ ì„œë¹„ìŠ¤ ì´ìš©ì— ë”°ë¥¸ ë³¸ì¸í™•ì¸, ê°œì¸ ì‹ë³„, ë¶ˆëŸ‰íšŒì›ì˜ ë¶€ì • ì´ìš© ë°©ì§€ì™€ ë¹„ì¸ê°€ ì‚¬ìš© ë°©ì§€<br>- AI ê¸°ë°˜ ë§ì¶¤í˜• ì‹ë‹¨ ë° ìš´ë™ ì¶”ì²œ ì„œë¹„ìŠ¤ ì œê³µ</p>
                <hr>
                <p class="text-xs text-center">ë³¸ ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì€ ìƒ˜í”Œì´ë©°, ì‹¤ì œ ì„œë¹„ìŠ¤ ìš´ì˜ ì‹œì—ëŠ” ë²•ë¥  ì „ë¬¸ê°€ì˜ ê²€í† ë¥¼ ê±°ì¹œ í›„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</p>
            </div>
            <button type="button" id="close-privacy-modal" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ë‹«ê¸°</button>
        </div>
    </div>


    <!-- ë©”ì‹œì§€ ì•Œë¦¼ì°½ -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 transform translate-y-2 transition-all duration-300 font-semibold">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        // Firebase SDK ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, collection, query, where, getDocs, documentId } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCRax6rd1rlBIc3kVgg5OkHmSIQyzJmC8A",
            authDomain: "fitmeal-app-d1a97.firebaseapp.com",
            projectId: "fitmeal-app-d1a97",
            storageBucket: "fitmeal-app-d1a97.appspot.com",
            messagingSenderId: "968711774677",
            appId: "1:968711774677:web:b3d3cb9ccc2388c3ba5d5c"
        };
        const appId = firebaseConfig.appId || 'default-diet-app';

        // ğŸ”‘ğŸ”‘ğŸ”‘ AI API í‚¤ ğŸ”‘ğŸ”‘ğŸ”‘
        const GEMINI_API_KEY = "AIzaSyB3H3RGnJlyypbdDuHHu-uCQBk3Dw6RW0c";

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI ìš”ì†Œ
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const registerBtn = document.getElementById('register-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutButton = document.getElementById('logout-button');

        const dashboardView = document.getElementById('dashboard-view');
        const calendarView = document.getElementById('calendar-view');
        const calendarToggleButton = document.getElementById('calendar-toggle-button');
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const calendarDetailModal = document.getElementById('calendar-detail-modal');
        const closeCalendarDetailBtn = document.getElementById('close-calendar-detail');

        const profileModal = document.getElementById('profile-modal');
        const addFoodModal = document.getElementById('add-food-modal');
        const addExerciseModal = document.getElementById('add-exercise-modal');
        const photoAnalysisModal = document.getElementById('photo-analysis-modal');
        const premiumModal = document.getElementById('premium-modal');
        const termsModal = document.getElementById('terms-modal');
        const privacyModal = document.getElementById('privacy-modal');
        const profileForm = document.getElementById('profile-form');
        const addFoodForm = document.getElementById('add-food-form');
        const addExerciseForm = document.getElementById('add-exercise-form');
        const profileButton = document.getElementById('profile-button');
        const generatePlanButton = document.getElementById('generate-plan-button');
        const addFoodButton = document.getElementById('add-food-button');
        const addPhotoButton = document.getElementById('add-photo-button');
        const addExerciseButton = document.getElementById('add-exercise-button');
        const cancelAddFoodButton = document.getElementById('cancel-add-food');
        const cancelAddExerciseButton = document.getElementById('cancel-add-exercise');
        const cancelPhotoAnalysisButton = document.getElementById('cancel-photo-analysis');
        const analyzePhotoButton = document.getElementById('analyze-photo-button');
        const photoInput = document.getElementById('photo-input');
        const imagePreview = document.getElementById('image-preview');
        const manualPhotoInput = document.getElementById('manual-photo-input');
        const manualImagePreview = document.getElementById('manual-image-preview');
        const calculateNutrientsBtn = document.getElementById('calculate-nutrients-btn');
        const nutrientLoader = document.getElementById('nutrient-loader');
        const loader = document.getElementById('loader');
        const mealPlanContent = document.getElementById('meal-plan-content');
        const dailyIntakeList = document.getElementById('daily-intake-list');
        const dailyExerciseList = document.getElementById('daily-exercise-list');
        const welcomeMessage = document.getElementById('welcome-message');
        const setupProfileBtn = document.getElementById('setup-profile-btn');
        const adBannerContainer = document.getElementById('ad-banner-container');
        const reportBtn = document.getElementById('report-btn');
        const closePremiumModalBtn = document.getElementById('close-premium-modal');
        const termsLink = document.getElementById('terms-link');
        const privacyLink = document.getElementById('privacy-link');
        const closeTermsModalBtn = document.getElementById('close-terms-modal');
        const closePrivacyModalBtn = document.getElementById('close-privacy-modal');
        
        // ìƒíƒœ ê´€ë¦¬
        let userProfile = null;
        let userId = null;
        let dailyIntake = [];
        let dailyExercise = [];
        let selectedImageBase64 = null;
        let manualImageBase64 = null;
        let currentDate = new Date();
        let isPremium = false; // í”„ë¦¬ë¯¸ì—„ ìƒíƒœ ë³€ìˆ˜

        const calendarIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>`;
        const homeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>`;
        
        // ì´ˆê¸° ì•„ì´ì½˜ ì„¤ì •
        calendarToggleButton.innerHTML = calendarIconSVG;

        // --- ì¸ì¦ ë° ë°ì´í„° ë¡œë”© ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ ê²½ìš°
                userId = user.uid;
                authView.classList.add('hidden');
                appView.classList.remove('hidden');
                
                const today = new Date().toISOString().slice(0, 10);
                
                // í”„ë¦¬ë¯¸ì—„ ìƒíƒœ í™•ì¸
                const premiumRef = doc(db, `artifacts/${appId}/users/${userId}/premium`, 'status');
                onSnapshot(premiumRef, (docSnap) => {
                    isPremium = docSnap.exists() && docSnap.data().active === true;
                    updatePremiumUI();
                });

                const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                onSnapshot(userProfileRef, (docSnap) => { 
                    if (docSnap.exists()) { 
                        userProfile = docSnap.data(); 
                        showDashboard();
                        updateNutritionGoalsUI(userProfile); 
                        updateNutritionProgressUI(dailyIntake, userProfile.nutritionGoals); 
                    } else { 
                        showWelcomeMessage();
                    } 
                });
                const mealPlanRef = doc(db, `artifacts/${appId}/users/${userId}/mealPlans`, today);
                onSnapshot(mealPlanRef, (docSnap) => { if (docSnap.exists()) { renderMealPlan(docSnap.data().plan); } else { mealPlanContent.innerHTML = '<p class="text-center text-slate-500 md:col-span-2 py-4">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì‹ë‹¨ì„ ë°›ì•„ë³´ì„¸ìš”.</p>'; } });
                const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, today);
                onSnapshot(dailyIntakeRef, (docSnap) => { dailyIntake = docSnap.exists() ? docSnap.data().foods : []; renderDailyIntake(dailyIntake); if (userProfile && userProfile.nutritionGoals) { updateNutritionProgressUI(dailyIntake, userProfile.nutritionGoals); } });
                const dailyExerciseRef = doc(db, `artifacts/${appId}/users/${userId}/dailyExercise`, today);
                onSnapshot(dailyExerciseRef, (docSnap) => { dailyExercise = docSnap.exists() ? docSnap.data().exercises : []; renderDailyExercise(dailyExercise); });
                const waterRef = doc(db, `artifacts/${appId}/users/${userId}/water`, today);
                onSnapshot(waterRef, (docSnap) => { updateWaterUI(docSnap.exists() ? docSnap.data().count : 0); });
                
                renderCalendar();
            } else {
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒí•œ ê²½ìš°
                userId = null;
                userProfile = null;
                authView.classList.remove('hidden');
                appView.classList.add('hidden');
            }
        });

        function showWelcomeMessage() {
            welcomeMessage.classList.remove('hidden');
            document.getElementById('nutrition-progress').classList.add('hidden');
            document.getElementById('daily-intake-log').classList.add('hidden');
            document.getElementById('daily-exercise-log').classList.add('hidden');
            document.getElementById('meal-plan').classList.add('hidden');
            document.getElementById('water-tracker').classList.add('hidden');
            document.getElementById('ad-banner-container').classList.add('hidden');
        }

        function showDashboard() {
            welcomeMessage.classList.add('hidden');
            document.getElementById('nutrition-progress').classList.remove('hidden');
            document.getElementById('daily-intake-log').classList.remove('hidden');
            document.getElementById('daily-exercise-log').classList.remove('hidden');
            document.getElementById('meal-plan').classList.remove('hidden');
            document.getElementById('water-tracker').classList.remove('hidden');
            document.getElementById('ad-banner-container').classList.remove('hidden');
        }

        function updatePremiumUI() {
            if (isPremium) {
                adBannerContainer.classList.add('hidden');
            } else {
                adBannerContainer.classList.remove('hidden');
            }
        }


        // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updateNutritionGoalsUI(profile) {
            if (!profile) return;
            let bmr;
            if (profile.gender === 'male') { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) + 5; } else if (profile.gender === 'female') { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) - 161; } else { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) - 78; }
            const tdee = bmr * profile.activity;
            let finalCalories = tdee;
            if (profile.goal === 'loss') finalCalories -= 500;
            if (profile.goal === 'gain') finalCalories += 300;
            userProfile.nutritionGoals = { calories: Math.round(finalCalories), carbs: Math.round((finalCalories * 0.45) / 4), protein: Math.round((finalCalories * 0.30) / 4), fat: Math.round((finalCalories * 0.25) / 9) };
            document.getElementById('calories-goal').textContent = userProfile.nutritionGoals.calories;
            document.getElementById('carbs-goal').textContent = userProfile.nutritionGoals.carbs;
            document.getElementById('protein-goal').textContent = userProfile.nutritionGoals.protein;
            document.getElementById('fat-goal').textContent = userProfile.nutritionGoals.fat;
        }

        function updateNutritionProgressUI(intake, goals) {
            if (!goals) return;
            const totals = intake.reduce((acc, food) => ({ calories: acc.calories + (food.calories || 0), carbs: acc.carbs + (food.carbs || 0), protein: acc.protein + (food.protein || 0), fat: acc.fat + (food.fat || 0) }), { calories: 0, carbs: 0, protein: 0, fat: 0 });
            const updateRing = (type, current, goal) => {
                document.getElementById(`${type}-current`).textContent = Math.round(current);
                const percentage = goal > 0 ? Math.min(Math.round((current / goal) * 100), 100) : 0;
                document.getElementById(`${type}-ring`).style.setProperty('--p', percentage);
            };
            updateRing('calories', totals.calories, goals.calories); updateRing('carbs', totals.carbs, goals.carbs); updateRing('protein', totals.protein, goals.protein); updateRing('fat', totals.fat, goals.fat);
        }

        function renderMealPlan(plan) {
            mealPlanContent.innerHTML = '';
            const mealTypes = { breakfast: 'ì•„ì¹¨', lunch: 'ì ì‹¬', dinner: 'ì €ë…', snack: 'ê°„ì‹' };
            for (const mealType in plan) {
                const meal = plan[mealType];
                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-2xl custom-shadow meal-card';
                card.innerHTML = `<div class="flex justify-between items-start"><div><h3 class="text-lg font-jua text-rose-500">${mealTypes[mealType]}</h3><p class="text-xl font-semibold my-2 text-slate-800">${meal.name}</p></div><button class="log-ai-meal-btn bg-rose-100 text-rose-600 px-3 py-1 rounded-full text-sm font-semibold hover:bg-rose-200">ì‹ë‹¨ì— ì¶”ê°€</button></div><div class="flex justify-between text-sm text-slate-500 border-t border-slate-100 pt-3 mt-3"><span>ğŸ”¥ ${meal.calories} kcal</span><span>ğŸ ${meal.carbs}g</span><span>ğŸ— ${meal.protein}g</span><span>ğŸ¥‘ ${meal.fat}g</span></div>`;
                card.querySelector('.log-ai-meal-btn').addEventListener('click', () => logFoodItem({ name: `(AI) ${meal.name}`, ...meal, timestamp: Date.now() }));
                mealPlanContent.appendChild(card);
            }
        }

        function renderDailyIntake(foods) {
            dailyIntakeList.innerHTML = '';
            if (foods.length === 0) { dailyIntakeList.innerHTML = '<p class="text-center text-slate-400 py-4">ì•„ì§ ê¸°ë¡ëœ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            foods.forEach((food) => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-2xl custom-shadow flex justify-between items-center';
                const imageHtml = food.photo ? `<img src="${food.photo}" class="w-12 h-12 rounded-lg object-cover mr-4">` : `<div class="w-12 h-12 rounded-lg bg-rose-50 flex-shrink-0 mr-4"></div>`;
                item.innerHTML = `
                    <div class="flex items-center flex-grow">
                        ${imageHtml}
                        <div class="flex-grow">
                            <p class="font-semibold text-slate-800">${food.name}</p>
                            <p class="text-sm text-slate-500">${food.calories}kcal | íƒ„ ${food.carbs}g, ë‹¨ ${food.protein}g, ì§€ ${food.fat}g</p>
                        </div>
                    </div>
                    <button class="remove-intake-btn text-rose-300 hover:text-rose-500 text-2xl font-bold flex-shrink-0 ml-2">&times;</button>
                `;
                item.querySelector('.remove-intake-btn').addEventListener('click', () => removeFoodItem(food));
                dailyIntakeList.appendChild(item);
            });
        }

        function renderDailyExercise(exercises) {
            dailyExerciseList.innerHTML = '';
            if (exercises.length === 0) {
                dailyExerciseList.innerHTML = '<p class="text-center text-slate-400 py-4">ì•„ì§ ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            exercises.forEach((ex) => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-2xl custom-shadow flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-slate-800">${ex.name}</p>
                        <p class="text-sm text-slate-500">${ex.duration}ë¶„ | ${ex.calories}kcal ì†Œëª¨</p>
                    </div>
                    <button class="remove-exercise-btn text-rose-300 hover:text-rose-500 text-2xl font-bold">&times;</button>
                `;
                item.querySelector('.remove-exercise-btn').addEventListener('click', () => removeExerciseItem(ex));
                dailyExerciseList.appendChild(item);
            });
        }
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        profileButton.addEventListener('click', openProfileModal);
        addFoodButton.addEventListener('click', openAddFoodModal);
        addPhotoButton.addEventListener('click', openPhotoAnalysisModal);
        addExerciseButton.addEventListener('click', () => openModal(addExerciseModal));
        setupProfileBtn.addEventListener('click', openProfileModal);
        
        profileModal.addEventListener('click', (e) => e.target === profileModal && closeProfileModal());
        addFoodModal.addEventListener('click', (e) => e.target === addFoodModal && closeAddFoodModal());
        addExerciseModal.addEventListener('click', (e) => e.target === addExerciseModal && closeModal(addExerciseModal));
        photoAnalysisModal.addEventListener('click', (e) => e.target === photoAnalysisModal && closePhotoAnalysisModal());
        
        cancelAddFoodButton.addEventListener('click', closeAddFoodModal);
        cancelAddExerciseButton.addEventListener('click', () => closeModal(addExerciseModal));
        cancelPhotoAnalysisButton.addEventListener('click', closePhotoAnalysisModal);
        
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const profileData = { gender: document.getElementById('gender').value, age: parseInt(document.getElementById('age').value), height: parseFloat(document.getElementById('height').value), weight: parseFloat(document.getElementById('weight').value), activity: parseFloat(document.getElementById('activity').value), goal: document.getElementById('goal').value };
            if (Object.values(profileData).some(v => !v && v !== 0)) { showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
            try { await setDoc(userProfileRef, profileData); showToast('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); closeProfileModal(); } catch (error) { console.error("Error saving profile: ", error); showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        });

        addFoodForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const foodName = document.getElementById('food-name').value;
            const foodWeight = document.getElementById('food-weight').value;
            const foodItem = { 
                name: `${foodName} (${foodWeight}g)`, 
                calories: parseInt(document.getElementById('food-calories').value), 
                carbs: parseInt(document.getElementById('food-carbs').value), 
                protein: parseInt(document.getElementById('food-protein').value), 
                fat: parseInt(document.getElementById('food-fat').value), 
                timestamp: Date.now(), 
                photo: manualImageBase64 
            };
            if (Object.values(foodItem).some(v => (v !== null && v !== 0 && !v) || (typeof v === 'number' && isNaN(v)))) { showToast('ëª¨ë“  ì˜ì–‘ ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            logFoodItem(foodItem);
            addFoodForm.reset();
            closeAddFoodModal();
        });

        addExerciseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const exerciseItem = {
                name: document.getElementById('exercise-name').value,
                duration: parseInt(document.getElementById('exercise-duration').value),
                calories: parseInt(document.getElementById('exercise-calories').value),
                timestamp: Date.now()
            };
            if (Object.values(exerciseItem).some(v => (v !== 0 && !v) || (typeof v === 'number' && isNaN(v)))) {
                showToast('ëª¨ë“  ìš´ë™ ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            logExerciseItem(exerciseItem);
            addExerciseForm.reset();
            closeModal(addExerciseModal);
        });

        generatePlanButton.addEventListener('click', generateMealPlan);

        // --- AI ì‚¬ì§„ ë¶„ì„ ê´€ë ¨ ì´ë²¤íŠ¸ ---
        photoInput.addEventListener('change', (event) => handleImageSelection(event, imagePreview, (base64) => { selectedImageBase64 = base64; analyzePhotoButton.disabled = false; }));
        manualPhotoInput.addEventListener('change', (event) => handleImageSelection(event, manualImagePreview, (base64) => { manualImageBase64 = base64; }));

        function handleImageSelection(event, previewElement, callback) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64String = reader.result.replace('data:', '').replace(/^.+,/, '');
                callback(reader.result); // Save full data URL for display
                previewElement.style.backgroundImage = `url('${reader.result}')`;
                previewElement.style.backgroundSize = 'cover';
                previewElement.style.backgroundPosition = 'center';
                previewElement.innerHTML = '';
            };
            reader.readAsDataURL(file);
        }

        analyzePhotoButton.addEventListener('click', async () => {
            if (!selectedImageBase64) { showToast('ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            document.getElementById('photo-upload-view').classList.add('hidden');
            document.getElementById('photo-loading-view').classList.remove('hidden');
            try {
                const resultText = await callGeminiVisionAPI(selectedImageBase64.split(',')[1]);
                const resultData = JSON.parse(resultText);
                renderPhotoAnalysisResult(resultData);
                document.getElementById('photo-loading-view').classList.add('hidden');
                document.getElementById('photo-result-view').classList.remove('hidden');
            } catch (error) {
                console.error('Photo analysis failed:', error);
                showToast('ì‚¬ì§„ ë¶„ì„ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë” ë°ì€ í™˜ê²½ì—ì„œ ë‹¤ì‹œ ì´¬ì˜í•´ë³´ì„¸ìš”!');
                document.getElementById('photo-loading-view').classList.add('hidden');
                document.getElementById('photo-upload-view').classList.remove('hidden');
            }
        });

        calculateNutrientsBtn.addEventListener('click', async () => {
            const foodName = document.getElementById('food-name').value;
            const foodWeight = document.getElementById('food-weight').value;
            if (!foodName || !foodWeight) { showToast('ìŒì‹ ì´ë¦„ê³¼ ì–‘(g)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            
            nutrientLoader.classList.remove('hidden');
            try {
                const resultText = await callGeminiNutritionAPI(`${foodName} ${foodWeight}g`);
                const data = JSON.parse(resultText);
                document.getElementById('food-calories').value = data.calories;
                document.getElementById('food-carbs').value = data.carbs;
                document.getElementById('food-protein').value = data.protein;
                document.getElementById('food-fat').value = data.fat;
            } catch (error) {
                console.error('Nutrient calculation failed:', error);
                showToast('ì˜ì–‘ì†Œ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            } finally {
                nutrientLoader.classList.add('hidden');
            }
        });

        // --- ìº˜ë¦°ë” ë° í”„ë¦¬ë¯¸ì—„ ê´€ë ¨ ì´ë²¤íŠ¸ ---
        calendarToggleButton.addEventListener('click', () => {
            const isDashboardVisible = !dashboardView.classList.contains('hidden');
            dashboardView.classList.toggle('hidden');
            calendarView.classList.toggle('hidden');
            if (isDashboardVisible) {
                // ëŒ€ì‹œë³´ë“œ -> ìº˜ë¦°ë” í™”ë©´ìœ¼ë¡œ ì „í™˜
                calendarToggleButton.innerHTML = homeIconSVG;
                renderCalendar(); // ìµœì‹  ë°ì´í„°ë¡œ ìº˜ë¦°ë”ë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
            } else {
                // ìº˜ë¦°ë” -> ëŒ€ì‹œë³´ë“œ í™”ë©´ìœ¼ë¡œ ì „í™˜
                calendarToggleButton.innerHTML = calendarIconSVG;
            }
        });

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        
        closeCalendarDetailBtn.addEventListener('click', () => closeModal(calendarDetailModal));
        calendarDetailModal.addEventListener('click', (e) => e.target === calendarDetailModal && closeModal(calendarDetailModal));
        
        reportBtn.addEventListener('click', () => {
            if (isPremium) {
                showToast('ğŸ’ í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ ê¸°ëŠ¥ì´ ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤!');
            } else {
                openModal(premiumModal);
            }
        });
        
        closePremiumModalBtn.addEventListener('click', () => closeModal(premiumModal));
        premiumModal.addEventListener('click', (e) => e.target === premiumModal && closeModal(premiumModal));

        document.getElementById('subscribe-now-btn').addEventListener('click', async () => {
            // ì‹¤ì œ ê²°ì œ ë¡œì§ì€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. (e.g., Stripe, I'mport)
            // ì§€ê¸ˆì€ ì„ì‹œë¡œ í”„ë¦¬ë¯¸ì—„ ìƒíƒœë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.
            const premiumRef = doc(db, `artifacts/${appId}/users/${userId}/premium`, 'status');
            try {
                await setDoc(premiumRef, { active: true, subscribedAt: new Date() });
                showToast('ğŸ‘‘ í”„ë¦¬ë¯¸ì—„ êµ¬ë…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeModal(premiumModal);
            } catch (error) {
                showToast('êµ¬ë… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });


        // --- í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ ---
        async function logFoodItem(foodItem) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, today);
            try { 
                await updateDoc(dailyIntakeRef, { foods: arrayUnion(foodItem) }); 
                showToast(`${foodItem.name} ê¸°ë¡ ì™„ë£Œ!`);
            } catch (error) { 
                if (error.code === 'not-found') { 
                    await setDoc(dailyIntakeRef, { foods: [foodItem] }); 
                    showToast(`${foodItem.name} ê¸°ë¡ ì™„ë£Œ!`);
                } else { 
                    console.error("Error logging food: ", error); 
                    showToast('ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); 
                } 
            }
            renderCalendar(); // ìº˜ë¦°ë” ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        }
        
        async function removeFoodItem(foodToRemove) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, today);
            try { 
                await updateDoc(dailyIntakeRef, { foods: arrayRemove(foodToRemove) }); 
                showToast(`${foodToRemove.name} ì‚­ì œ ì™„ë£Œ!`);
                renderCalendar(); // ìº˜ë¦°ë” ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            } catch (error) { 
                console.error("Error removing food: ", error); 
                showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); 
            }
        }
        
        async function logExerciseItem(exerciseItem) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyExerciseRef = doc(db, `artifacts/${appId}/users/${userId}/dailyExercise`, today);
            try {
                await updateDoc(dailyExerciseRef, { exercises: arrayUnion(exerciseItem) });
                showToast(`${exerciseItem.name} ìš´ë™ ê¸°ë¡ ì™„ë£Œ!`);
            } catch (error) {
                if (error.code === 'not-found') {
                    await setDoc(dailyExerciseRef, { exercises: [exerciseItem] });
                    showToast(`${exerciseItem.name} ìš´ë™ ê¸°ë¡ ì™„ë£Œ!`);
                } else {
                    console.error("Error logging exercise: ", error);
                    showToast('ìš´ë™ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
            renderCalendar();
        }

        async function removeExerciseItem(exerciseToRemove) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyExerciseRef = doc(db, `artifacts/${appId}/users/${userId}/dailyExercise`, today);
            try {
                await updateDoc(dailyExerciseRef, { exercises: arrayRemove(exerciseToRemove) });
                showToast(`${exerciseToRemove.name} ìš´ë™ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ!`);
                renderCalendar();
            } catch (error) {
                console.error("Error removing exercise: ", error);
                showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }


        async function generateMealPlan() {
            if (!userProfile || !userProfile.nutritionGoals) { showToast('ë¨¼ì € í”„ë¡œí•„ì„ ì €ì¥í•´ì£¼ì„¸ìš”.'); openProfileModal(); return; }
            loader.classList.remove('hidden');
            mealPlanContent.innerHTML = '';
            generatePlanButton.disabled = true;
            const userInfoParts = [ `ë‚˜ì´: ${userProfile.age}ì„¸`, userProfile.gender !== 'unspecified' ? `ì„±ë³„: ${userProfile.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}` : '', `ëª©í‘œ: ${userProfile.goal === 'loss' ? 'ì²´ì¤‘ ê°ëŸ‰' : (userProfile.goal === 'gain' ? 'ì²´ì¤‘ ì¦ê°€' : 'ì²´ì¤‘ ìœ ì§€')}` ].filter(part => part).join(', ');
            const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ì‚¬ìš©ì ì •ë³´ì™€ ì˜ì–‘ ëª©í‘œì— ë§ì¶°, ë§›ê³¼ ì˜ì–‘ì„ ëª¨ë‘ ê³ ë ¤í•œ í•œêµ­ì‹ ìœ„ì£¼ì˜ í•˜ë£¨ ì‹ë‹¨(ì•„ì¹¨, ì ì‹¬, ì €ë…, ê°„ì‹)ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”. ì‚¬ìš©ì ì •ë³´: ${userInfoParts}. ì¼ì¼ ì˜ì–‘ ëª©í‘œ: ì¹¼ë¡œë¦¬ ${userProfile.nutritionGoals.calories}kcal, íƒ„ìˆ˜í™”ë¬¼ ${userProfile.nutritionGoals.carbs}g, ë‹¨ë°±ì§ˆ ${userProfile.nutritionGoals.protein}g, ì§€ë°© ${userProfile.nutritionGoals.fat}g. ê° ì‹ì‚¬ì˜ ìŒì‹ ì´ë¦„ê³¼ ì˜ˆìƒ ì˜ì–‘ì„±ë¶„(ì¹¼ë¡œë¦¬,íƒ„ìˆ˜í™”ë¬¼,ë‹¨ë°±ì§ˆ,ì§€ë°©)ì„ ê³„ì‚°í•˜ì—¬ ì œê³µí•´ì£¼ì„¸ìš”. ì „ì²´ ì‹ë‹¨ì˜ ì˜ì–‘ì†Œ ì´í•©ì´ ëª©í‘œì¹˜ì— ìµœëŒ€í•œ ê·¼ì ‘í•´ì•¼ í•©ë‹ˆë‹¤.`;
            try {
                const responseText = await callGeminiAPI(prompt);
                const plan = JSON.parse(responseText);
                const today = new Date().toISOString().slice(0, 10);
                const mealPlanRef = doc(db, `artifacts/${appId}/users/${userId}/mealPlans`, today);
                await setDoc(mealPlanRef, { plan: plan, createdAt: new Date() });
                showToast('AI ë§ì¶¤ ì‹ë‹¨ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error("Error generating meal plan:", error);
                mealPlanContent.innerHTML = '<p class="text-center text-red-500 md:col-span-2">ì‹ë‹¨ ìƒì„± ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                showToast('ì‹ë‹¨ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                loader.classList.add('hidden');
                generatePlanButton.disabled = false;
            }
        }
        
        async function renderCalendar() {
            if (!userId) return;
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            calendarMonthYear.textContent = `${year}ë…„ ${month + 1}ì›”`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
            
            // Fetch meal data for the current month
            const mealQuery = query(collection(db, `artifacts/${appId}/users/${userId}/dailyIntake`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const mealSnapshot = await getDocs(mealQuery);
            const monthMealData = {};
            mealSnapshot.forEach(doc => {
                monthMealData[doc.id] = doc.data();
            });

            // Fetch water data for the current month
            const waterQuery = query(collection(db, `artifacts/${appId}/users/${userId}/water`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const waterSnapshot = await getDocs(waterQuery);
            const monthWaterData = {};
            waterSnapshot.forEach(doc => {
                monthWaterData[doc.id] = doc.data();
            });
            
            // Fetch exercise data for the current month
            const exerciseQuery = query(collection(db, `artifacts/${appId}/users/${userId}/dailyExercise`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const exerciseSnapshot = await getDocs(exerciseQuery);
            const monthExerciseData = {};
            exerciseSnapshot.forEach(doc => {
                monthExerciseData[doc.id] = doc.data();
            });

            for (let i = 0; i < firstDay; i++) {
                calendarGrid.innerHTML += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasMealData = monthMealData[dayStr] && monthMealData[dayStr].foods.length > 0;
                const hasWaterData = monthWaterData[dayStr] && monthWaterData[dayStr].count > 0;
                const hasExerciseData = monthExerciseData[dayStr] && monthExerciseData[dayStr].exercises.length > 0;
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                
                const dayCell = document.createElement('div');
                dayCell.className = 'h-16 flex flex-col items-center justify-center rounded-2xl calendar-day';
                
                let iconsHTML = '';
                if (hasMealData) iconsHTML += '<span class="text-xs">ğŸ½ï¸</span>';
                if (hasWaterData) iconsHTML += '<span class="text-xs">ğŸ’§</span>';
                if (hasExerciseData) iconsHTML += '<span class="text-xs">ğŸ‹ï¸â€â™€ï¸</span>';
                
                dayCell.innerHTML = `<span class="text-sm">${day}</span><div class="flex">${iconsHTML}</div>`;
                
                if (isToday) dayCell.classList.add('bg-rose-100', 'font-bold', 'text-rose-600');
                
                if (hasMealData || hasWaterData || hasExerciseData) {
                    dayCell.classList.add('cursor-pointer', 'hover:bg-rose-50');
                    dayCell.addEventListener('click', () => openCalendarDetailModal(dayStr, monthMealData[dayStr]?.foods || [], monthWaterData[dayStr]?.count || 0, monthExerciseData[dayStr]?.exercises || []));
                }
                calendarGrid.appendChild(dayCell);
            }
        }

        function openCalendarDetailModal(dateStr, foods, waterCount, exercises) {
            document.getElementById('calendar-detail-title').textContent = `${dateStr} ê¸°ë¡`;
            const listEl = document.getElementById('calendar-detail-list');
            listEl.innerHTML = '';
            
            const waterItem = document.createElement('div');
            waterItem.className = 'bg-sky-50 p-4 rounded-2xl flex items-center';
            waterItem.innerHTML = `<span class="text-2xl mr-4">ğŸ’§</span><div class="flex-grow"><p class="font-semibold text-sky-800">ì´ ìˆ˜ë¶„ ì„­ì·¨</p><p class="text-sm text-sky-600">${waterCount} ì” (${waterCount * 250}ml)</p></div>`;
            listEl.appendChild(waterItem);

            const exerciseTitle = document.createElement('h3');
            exerciseTitle.className = 'text-lg font-jua text-rose-600 mt-4 mb-2';
            exerciseTitle.textContent = 'ìš´ë™ ê¸°ë¡';
            listEl.appendChild(exerciseTitle);

            if (exercises.length === 0) {
                listEl.innerHTML += '<p class="text-center text-slate-400 py-4">ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                exercises.forEach(ex => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl custom-shadow flex items-center';
                    item.innerHTML = `<span class="text-2xl mr-4">ğŸ‹ï¸â€â™€ï¸</span><div class="flex-grow"><p class="font-semibold text-slate-800">${ex.name}</p><p class="text-sm text-slate-500">${ex.duration}ë¶„ | ${ex.calories}kcal ì†Œëª¨</p></div>`;
                    listEl.appendChild(item);
                });
            }

            const foodTitle = document.createElement('h3');
            foodTitle.className = 'text-lg font-jua text-rose-600 mt-4 mb-2';
            foodTitle.textContent = 'ì‹ë‹¨ ê¸°ë¡';
            listEl.appendChild(foodTitle);

            if (foods.length === 0) {
                listEl.innerHTML += '<p class="text-center text-slate-400 py-4">ê¸°ë¡ëœ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                foods.forEach(food => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl custom-shadow flex items-center';
                    const imageHtml = food.photo ? `<img src="${food.photo}" class="w-12 h-12 rounded-lg object-cover mr-4">` : `<div class="w-12 h-12 rounded-lg bg-rose-50 flex-shrink-0 mr-4"></div>`;
                    item.innerHTML = `${imageHtml}<div class="flex-grow"><p class="font-semibold text-slate-800">${food.name}</p><p class="text-sm text-slate-500">${food.calories}kcal | íƒ„ ${food.carbs}g, ë‹¨ ${food.protein}g, ì§€ ${food.fat}g</p></div>`;
                    listEl.appendChild(item);
                });
            }
            openModal(calendarDetailModal);
        }

        // --- Gemini API í˜¸ì¶œ ---
        async function callGeminiAPI(prompt) {
            const apiKey = GEMINI_API_KEY;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { breakfast: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, lunch: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, dinner: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, snack: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } } } } } };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); 
            const result = await response.json(); 
            if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text; 
            else throw new Error("API ì‘ë‹µì— ìœ íš¨í•œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤."); 
        }

        async function callGeminiNutritionAPI(foodString) {
            const apiKey = GEMINI_API_KEY;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `'${foodString}'ì˜ ì˜ˆìƒ ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© í•¨ëŸ‰ì„ ê³„ì‚°í•´ì„œ JSON í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì¤˜. ê°’ì€ ì†Œìˆ˜ì  ì—†ì´ ì •ìˆ˜ë¡œë§Œ ì œê³µí•´ì•¼ í•´.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } } } };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
            else throw new Error("API ì‘ë‹µì— ìœ íš¨í•œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
        
        async function callGeminiVisionAPI(base64ImageData) {
            const apiKey = GEMINI_API_KEY;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = "ì´ ìŒì‹ ì‚¬ì§„ì„ ë¶„ì„í•´ì„œ, ìŒì‹ ì´ë¦„, ì˜ˆìƒ ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© í•¨ëŸ‰, ê·¸ë¦¬ê³  ì´ ìŒì‹ì— ëŒ€í•œ ê°„ë‹¨í•œ ì˜ì–‘í•™ì  ì¡°ì–¸ì´ë‚˜ íŒì„ JSON í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì¤˜.";
            const payload = { contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } } ] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" }, tip: { type: "STRING" } } } } };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
            else throw new Error("API ì‘ë‹µì— ìœ íš¨í•œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
        
        function renderPhotoAnalysisResult(data) {
            const resultView = document.getElementById('photo-result-view');
            resultView.innerHTML = `<div class="text-center"><p class="text-sm text-slate-500">AI ë¶„ì„ ê²°ê³¼</p><p class="text-2xl font-jua text-rose-600 my-2">${data.name}</p></div><div class="my-4 bg-rose-50 p-4 rounded-2xl space-y-2 text-sm"><div class="flex justify-between"><span>ğŸ”¥ ì¹¼ë¡œë¦¬</span><span class="font-semibold">${data.calories} kcal</span></div><div class="flex justify-between"><span>ğŸ íƒ„ìˆ˜í™”ë¬¼</span><span class="font-semibold">${data.carbs} g</span></div><div class="flex justify-between"><span>ğŸ— ë‹¨ë°±ì§ˆ</span><span class="font-semibold">${data.protein} g</span></div><div class="flex justify-between"><span>ğŸ¥‘ ì§€ë°©</span><span class="font-semibold">${data.fat} g</span></div></div><div class="my-4 text-center text-sm bg-sky-50 text-sky-700 p-3 rounded-2xl"><p>ğŸ’¡ <strong>ì˜ì–‘ íŒ:</strong> ${data.tip}</p></div><button id="log-photo-result" class="w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition">ê¸°ë¡í•˜ê¸°</button>`;
            document.getElementById('log-photo-result').addEventListener('click', () => { logFoodItem({ name: `(ì‚¬ì§„) ${data.name}`, ...data, timestamp: Date.now() }); closePhotoAnalysisModal(); });
        }

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function openModal(modal) { modal.classList.remove('pointer-events-none', 'opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }
        function closeModal(modal) { modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('scale-95'); setTimeout(() => modal.classList.add('pointer-events-none'), 300); }
        function openProfileModal() { if(userProfile) { document.getElementById('gender').value = userProfile.gender || 'female'; document.getElementById('age').value = userProfile.age || ''; document.getElementById('height').value = userProfile.height || ''; document.getElementById('weight').value = userProfile.weight || ''; document.getElementById('activity').value = userProfile.activity || '1.55'; document.getElementById('goal').value = userProfile.goal || 'maintain'; } openModal(profileModal); }
        function closeProfileModal() { closeModal(profileModal); }
        function openAddFoodModal() { openModal(addFoodModal); }
        function closeAddFoodModal() { 
            closeModal(addFoodModal);
            setTimeout(() => {
                addFoodForm.reset();
                manualImageBase64 = null;
                manualImagePreview.style.backgroundImage = 'url("data:image/svg+xml,%3csvg width=\'100%25\' height=\'100%25\' xmlns=\'http://www.w3.org/2000/svg\'%3e%3crect width=\'100%25\' height=\'100%25\' fill=\'none\' rx=\'24\' ry=\'24\' stroke=\'%23FBCFE8FF\' stroke-width=\'4\' stroke-dasharray=\'6%2c 14\' stroke-dashoffset=\'0\' stroke-linecap=\'square\'/%3e%3c/svg%3e")';
                manualImagePreview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg><p class="mt-2 text-sm font-semibold">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</p>';
            }, 300);
        }
        function openPhotoAnalysisModal() { openModal(photoAnalysisModal); }
        function closePhotoAnalysisModal() { 
            closeModal(photoAnalysisModal);
            setTimeout(() => {
                document.getElementById('photo-upload-view').classList.remove('hidden');
                document.getElementById('photo-loading-view').classList.add('hidden');
                document.getElementById('photo-result-view').classList.add('hidden').innerHTML = '';
                imagePreview.style.backgroundImage = 'url("data:image/svg+xml,%3csvg width=\'100%25\' height=\'100%25\' xmlns=\'http://www.w3.org/2000/svg\'%3e%3crect width=\'100%25\' height=\'100%25\' fill=\'none\' rx=\'24\' ry=\'24\' stroke=\'%23FBCFE8FF\' stroke-width=\'4\' stroke-dasharray=\'6%2c 14\' stroke-dashoffset=\'0\' stroke-linecap=\'square\'/%3e%3c/svg%3e")';
                imagePreview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><p class="mt-2 font-semibold">ì‚¬ì§„ì„ ì—¬ê¸°ì— ì˜¬ë ¤ì£¼ì„¸ìš”</p>';
                photoInput.value = '';
                selectedImageBase64 = null;
                analyzePhotoButton.disabled = true;
            }, 300);
        }
        
        let toastTimer;
        function showToast(message) { const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); toastMessage.textContent = message; toast.classList.remove('opacity-0', 'translate-y-2'); clearTimeout(toastTimer); toastTimer = setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-2'); }, 3000); }

        // --- ë¬¼ ì„­ì·¨ëŸ‰ ê´€ë ¨ ---
        const addWaterBtn = document.getElementById('add-water-button');
        const removeWaterBtn = document.getElementById('remove-water-button');
        let currentWaterIntake = 0;
        function updateWaterUI(count) { currentWaterIntake = count; document.getElementById('water-intake').textContent = count; }
        async function updateWaterInDB(newCount) { 
            if (newCount < 0) newCount = 0; 
            const today = new Date().toISOString().slice(0, 10); 
            const waterRef = doc(db, `artifacts/${appId}/users/${userId}/water`, today); 
            try { 
                await setDoc(waterRef, { count: newCount }); 
                renderCalendar(); // ìº˜ë¦°ë” ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            } catch (error) { 
                console.error("Error updating water intake: ", error); 
                showToast('ë¬¼ ì„­ì·¨ëŸ‰ ê¸°ë¡ ì‹¤íŒ¨.'); 
            } 
        }
        addWaterBtn.addEventListener('click', () => updateWaterInDB(currentWaterIntake + 1));
        removeWaterBtn.addEventListener('click', () => updateWaterInDB(currentWaterIntake - 1));

        // --- ì•½ê´€ ëª¨ë‹¬ ê´€ë ¨ ---
        termsLink.addEventListener('click', (e) => { e.preventDefault(); openModal(termsModal); });
        privacyLink.addEventListener('click', (e) => { e.preventDefault(); openModal(privacyModal); });
        closeTermsModalBtn.addEventListener('click', () => closeModal(termsModal));
        closePrivacyModalBtn.addEventListener('click', () => closeModal(privacyModal));
        termsModal.addEventListener('click', (e) => e.target === termsModal && closeModal(termsModal));
        privacyModal.addEventListener('click', (e) => e.target === privacyModal && closeModal(privacyModal));

    </script>
</body>
</html>
