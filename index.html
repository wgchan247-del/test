<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitMeal - AI ë§ì¶¤ ì‹ë‹¨ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FFFBF9; /* Very light pink background */
        }
        .font-jua {
            font-family: 'Jua', sans-serif;
        }
        .meal-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .meal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(236, 128, 128, 0.15);
        }
        .nutrient-ring {
            --size: 80px;
            --thickness: 8px;
            width: var(--size);
            height: var(--size);
            position: relative;
            display: inline-grid;
            place-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .nutrient-ring::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: conic-gradient(var(--color, #f43f5e) calc(var(--p, 0) * 1%), #fce7f3 0);
            border-radius: 50%;
            mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            -webkit-mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            transition: background 0.5s ease-in-out;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .custom-shadow {
            box-shadow: 0 4px 12px 0 rgba(236, 128, 128, 0.1);
        }
        .dashed-border {
             background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%23FBCFE8FF' stroke-width='4' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .calendar-day {
            transition: background-color 0.2s ease-in-out;
        }
    </style>
</head>
<body class="text-slate-700">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <!-- í—¤ë” -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-jua text-rose-500">FitMeal ğŸ¥—</h1>
            <div class="flex items-center gap-4">
                 <button id="calendar-toggle-button" class="text-gray-400 hover:text-rose-500">
                    <!-- ì•„ì´ì½˜ì€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë™ì ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤ -->
                </button>
                <button id="profile-button" class="text-gray-400 hover:text-rose-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
        <main id="dashboard-view" class="space-y-8">
            <!-- ì¼ì¼ ì„­ì·¨ í˜„í™© -->
            <section id="nutrition-progress" class="bg-white p-6 rounded-3xl custom-shadow">
                <h2 class="text-xl font-jua text-rose-600 mb-4">ì˜¤ëŠ˜ì˜ ì„­ì·¨ í˜„í™©</h2>
                <div id="progress-content" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <!-- Nutrients rings here -->
                    <div class="flex flex-col items-center"><div id="calories-ring" class="nutrient-ring" style="--color: #f43f5e; --p: 0;"><span id="calories-current">0</span><small class="text-slate-400">/ <span id="calories-goal">0</span></small></div><p class="mt-2 font-semibold">ì¹¼ë¡œë¦¬ (kcal)</p></div><div class="flex flex-col items-center"><div id="carbs-ring" class="nutrient-ring" style="--color: #2dd4bf; --p: 0;"><span id="carbs-current">0</span><small class="text-slate-400">/ <span id="carbs-goal">0</span></small></div><p class="mt-2 font-semibold">íƒ„ìˆ˜í™”ë¬¼ (g)</p></div><div class="flex flex-col items-center"><div id="protein-ring" class="nutrient-ring" style="--color: #fb923c; --p: 0;"><span id="protein-current">0</span><small class="text-slate-400">/ <span id="protein-goal">0</span></small></div><p class="mt-2 font-semibold">ë‹¨ë°±ì§ˆ (g)</p></div><div class="flex flex-col items-center"><div id="fat-ring" class="nutrient-ring" style="--color: #a78bfa; --p: 0;"><span id="fat-current">0</span><small class="text-slate-400">/ <span id="fat-goal">0</span></small></div><p class="mt-2 font-semibold">ì§€ë°© (g)</p></div>
                </div>
            </section>

            <!-- ì˜¤ëŠ˜ ì„­ì·¨ ê¸°ë¡ -->
            <section id="daily-intake-log">
                <h2 class="text-xl font-jua text-rose-600 mb-4">ì˜¤ëŠ˜ ì„­ì·¨ ê¸°ë¡ ğŸ“</h2>
                <div id="daily-intake-list" class="space-y-3 mb-4">
                    <!-- ì„­ì·¨ ê¸°ë¡ ì•„ì´í…œ -->
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="add-food-button" class="w-full bg-white border-2 border-dashed border-rose-200 text-rose-500 py-3 rounded-2xl font-semibold hover:bg-rose-50 hover:border-rose-400 transition duration-300">
                        + ì§ì ‘ ì…ë ¥
                    </button>
                    <button id="add-photo-button" class="w-full bg-rose-500 text-white py-3 rounded-2xl font-semibold hover:bg-rose-600 transition duration-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                        AI ì¹´ë©”ë¼ë¡œ ê¸°ë¡
                    </button>
                </div>
            </section>

            <!-- AI ì¶”ì²œ ì‹ë‹¨ -->
            <section id="meal-plan">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-jua text-rose-600">AI ì¶”ì²œ ì‹ë‹¨ ğŸ§‘ğŸ»â€ğŸ³</h2>
                    <button id="generate-plan-button" class="bg-rose-500 text-white px-5 py-2 rounded-full font-semibold hover:bg-rose-600 transition duration-300 disabled:bg-rose-300 shadow-sm shadow-rose-200">
                        ìƒˆ ì‹ë‹¨ ë°›ê¸°
                    </button>
                </div>
                <div id="meal-plan-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                 <div id="loader" class="hidden text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-rose-500"></div><p class="mt-4 text-slate-500">AIê°€ ë§ì¶¤ ì‹ë‹¨ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p></div>
            </section>
            
            <!-- ë¬¼ ì„­ì·¨ëŸ‰ ì¶”ì  -->
            <section id="water-tracker" class="bg-white p-6 rounded-3xl custom-shadow">
                <h2 class="text-xl font-jua text-rose-600 mb-4">ìˆ˜ë¶„ ì„­ì·¨ ğŸ’§</h2>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-3xl font-bold text-sky-500"><span id="water-intake">0</span> / <span id="water-goal">8</span> ì”</p>
                        <p class="text-slate-400 text-sm">2L ëª©í‘œ (1ì” = 250ml)</p>
                    </div>
                    <div class="flex space-x-2">
                        <button id="add-water-button" class="bg-sky-400 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl font-bold hover:bg-sky-500 transition shadow-sm shadow-sky-200">+</button>
                        <button id="remove-water-button" class="bg-slate-100 text-slate-500 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 transition">-</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- ìº˜ë¦°ë” ë·° -->
        <section id="calendar-view" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-3xl custom-shadow">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-rose-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h2 id="calendar-month-year" class="text-xl font-jua text-rose-600"></h2>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-rose-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-slate-500 mb-2">
                    <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                    <!-- Calendar days will be generated here -->
                </div>
            </div>
        </section>

    </div>

    <!-- ì‚¬ìš©ì ì •ë³´ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-rose-600 mb-6 text-center">ë‚´ ì •ë³´ ì…ë ¥</h2>
            <form id="profile-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4"><div><label for="gender" class="block text-sm font-medium text-slate-600">ì„±ë³„</label><select id="gender" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500"><option value="female">ì—¬ì„±</option><option value="male">ë‚¨ì„±</option><option value="unspecified">ì„ íƒ ì•ˆí•¨</option></select></div><div><label for="age" class="block text-sm font-medium text-slate-600">ë‚˜ì´</label><input type="number" id="age" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" placeholder="ì„¸"></div></div><div class="grid grid-cols-2 gap-4"><div><label for="height" class="block text-sm font-medium text-slate-600">ì‹ ì¥</label><input type="number" id="height" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" placeholder="cm"></div><div><label for="weight" class="block text-sm font-medium text-slate-600">ì²´ì¤‘</label><input type="number" id="weight" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" placeholder="kg"></div></div><div><label for="activity" class="block text-sm font-medium text-slate-600">í™œë™ëŸ‰</label><select id="activity" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500"><option value="1.2">ê±°ì˜ ì—†ìŒ</option><option value="1.375">ê°€ë²¼ìš´ í™œë™</option><option value="1.55">ë³´í†µ í™œë™</option><option value="1.725">ë†’ì€ í™œë™</option><option value="1.9">ë§¤ìš° ë†’ì€ í™œë™</option></select></div><div><label for="goal" class="block text-sm font-medium text-slate-600">ëª©í‘œ</label><select id="goal" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500"><option value="loss">ì²´ì¤‘ ê°ëŸ‰</option><option value="maintain">ì²´ì¤‘ ìœ ì§€</option><option value="gain">ì²´ì¤‘ ì¦ê°€</option></select></div><div class="pt-4"><button type="submit" class="w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition duration-300">ì €ì¥í•˜ê¸°</button></div>
            </form>
        </div>
    </div>
    
    <!-- ìŒì‹ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="add-food-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-rose-600 mb-6 text-center">ìŒì‹ ê¸°ë¡í•˜ê¸°</h2>
            <form id="add-food-form" class="space-y-4">
                <label for="manual-photo-input" class="cursor-pointer">
                    <div id="manual-image-preview" class="w-full h-32 bg-rose-50 rounded-2xl flex flex-col items-center justify-center text-rose-400 dashed-border">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        <p class="mt-2 text-sm font-semibold">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</p>
                    </div>
                </label>
                <input type="file" id="manual-photo-input" accept="image/*" class="hidden">
                
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-2">
                        <label for="food-name" class="block text-sm font-medium text-slate-600">ìŒì‹ ì´ë¦„</label>
                        <input type="text" id="food-name" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required>
                    </div>
                    <div>
                        <label for="food-weight" class="block text-sm font-medium text-slate-600">ì–‘ (g)</label>
                        <input type="number" id="food-weight" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required>
                    </div>
                </div>
                 <button type="button" id="calculate-nutrients-btn" class="w-full bg-rose-100 text-rose-600 py-2.5 rounded-lg text-sm font-semibold hover:bg-rose-200">AI ì˜ì–‘ì†Œ ìë™ ê³„ì‚°</button>
                
                <div id="nutrient-loader" class="hidden text-center py-2">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-rose-500"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="food-calories" class="block text-sm font-medium text-slate-600">ì¹¼ë¡œë¦¬ (kcal)</label><input type="number" id="food-calories" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required></div>
                    <div><label for="food-protein" class="block text-sm font-medium text-slate-600">ë‹¨ë°±ì§ˆ (g)</label><input type="number" id="food-protein" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="food-carbs" class="block text-sm font-medium text-slate-600">íƒ„ìˆ˜í™”ë¬¼ (g)</label><input type="number" id="food-carbs" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required></div>
                    <div><label for="food-fat" class="block text-sm font-medium text-slate-600">ì§€ë°© (g)</label><input type="number" id="food-fat" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500" required></div>
                </div>
                <div class="pt-4 flex space-x-3">
                    <button type="button" id="cancel-add-food" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ì·¨ì†Œ</button>
                    <button type="submit" class="w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition duration-300">ê¸°ë¡í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI ì‚¬ì§„ ë¶„ì„ ëª¨ë‹¬ -->
    <div id="photo-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-rose-600 mb-6 text-center">AI ìŒì‹ ë¶„ì„</h2>
            <div id="photo-upload-view">
                <label for="photo-input" class="cursor-pointer">
                    <div id="image-preview" class="w-full h-48 bg-rose-50 rounded-2xl flex flex-col items-center justify-center text-rose-400 dashed-border">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="mt-2 font-semibold">ì‚¬ì§„ì„ ì—¬ê¸°ì— ì˜¬ë ¤ì£¼ì„¸ìš”</p>
                    </div>
                </label>
                <input type="file" id="photo-input" accept="image/*" class="hidden">
                <button id="analyze-photo-button" class="mt-4 w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition duration-300 disabled:bg-rose-300">
                    ë¶„ì„ ì‹œì‘í•˜ê¸°
                </button>
            </div>
            <div id="photo-loading-view" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-rose-500"></div>
                <p class="mt-4 text-slate-500">AIê°€ ì‚¬ì§„ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</p>
            </div>
            <div id="photo-result-view" class="hidden">
                <!-- AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
             <button type="button" id="cancel-photo-analysis" class="mt-4 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ìº˜ë¦°ë” ìƒì„¸ ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="calendar-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 id="calendar-detail-title" class="text-2xl font-jua text-rose-600 mb-6 text-center"></h2>
            <div id="calendar-detail-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- ì„­ì·¨ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <button type="button" id="close-calendar-detail" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ ì•Œë¦¼ì°½ -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 transform translate-y-2 transition-all duration-300 font-semibold">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        // Firebase SDK ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, collection, query, where, getDocs, documentId } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCRax6rd1rlBIc3kVgg5OkHmSIQyzJmC8A",
            authDomain: "fitmeal-app-d1a97.firebaseapp.com",
            projectId: "fitmeal-app-d1a97",
            storageBucket: "fitmeal-app-d1a97.appspot.com",
            messagingSenderId: "968711774677",
            appId: "1:968711774677:web:b3d3cb9ccc2388c3ba5d5c"
        };
        const appId = firebaseConfig.appId || 'default-diet-app';

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI ìš”ì†Œ
        const dashboardView = document.getElementById('dashboard-view');
        const calendarView = document.getElementById('calendar-view');
        const calendarToggleButton = document.getElementById('calendar-toggle-button');
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const calendarDetailModal = document.getElementById('calendar-detail-modal');
        const closeCalendarDetailBtn = document.getElementById('close-calendar-detail');

        const profileModal = document.getElementById('profile-modal');
        const addFoodModal = document.getElementById('add-food-modal');
        const photoAnalysisModal = document.getElementById('photo-analysis-modal');
        const profileForm = document.getElementById('profile-form');
        const addFoodForm = document.getElementById('add-food-form');
        const profileButton = document.getElementById('profile-button');
        const generatePlanButton = document.getElementById('generate-plan-button');
        const addFoodButton = document.getElementById('add-food-button');
        const addPhotoButton = document.getElementById('add-photo-button');
        const cancelAddFoodButton = document.getElementById('cancel-add-food');
        const cancelPhotoAnalysisButton = document.getElementById('cancel-photo-analysis');
        const analyzePhotoButton = document.getElementById('analyze-photo-button');
        const photoInput = document.getElementById('photo-input');
        const imagePreview = document.getElementById('image-preview');
        const manualPhotoInput = document.getElementById('manual-photo-input');
        const manualImagePreview = document.getElementById('manual-image-preview');
        const calculateNutrientsBtn = document.getElementById('calculate-nutrients-btn');
        const nutrientLoader = document.getElementById('nutrient-loader');
        const loader = document.getElementById('loader');
        const mealPlanContent = document.getElementById('meal-plan-content');
        const dailyIntakeList = document.getElementById('daily-intake-list');
        
        // ìƒíƒœ ê´€ë¦¬
        let userProfile = null;
        let userId = null;
        let dailyIntake = [];
        let selectedImageBase64 = null;
        let manualImageBase64 = null;
        let currentDate = new Date();

        const calendarIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>`;
        const homeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>`;
        
        // ì´ˆê¸° ì•„ì´ì½˜ ì„¤ì •
        calendarToggleButton.innerHTML = calendarIconSVG;

        // --- ì¸ì¦ ë° ë°ì´í„° ë¡œë”© ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const today = new Date().toISOString().slice(0, 10);
                const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                onSnapshot(userProfileRef, (docSnap) => { if (docSnap.exists()) { userProfile = docSnap.data(); updateNutritionGoalsUI(userProfile); updateNutritionProgressUI(dailyIntake, userProfile.nutritionGoals); closeProfileModal(); } else { openProfileModal(); } });
                const mealPlanRef = doc(db, `artifacts/${appId}/users/${userId}/mealPlans`, today);
                onSnapshot(mealPlanRef, (docSnap) => { if (docSnap.exists()) { renderMealPlan(docSnap.data().plan); } else { mealPlanContent.innerHTML = '<p class="text-center text-slate-500 md:col-span-2 py-4">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì‹ë‹¨ì„ ë°›ì•„ë³´ì„¸ìš”.</p>'; } });
                const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, today);
                onSnapshot(dailyIntakeRef, (docSnap) => { dailyIntake = docSnap.exists() ? docSnap.data().foods : []; renderDailyIntake(dailyIntake); if (userProfile && userProfile.nutritionGoals) { updateNutritionProgressUI(dailyIntake, userProfile.nutritionGoals); } });
                const waterRef = doc(db, `artifacts/${appId}/users/${userId}/water`, today);
                onSnapshot(waterRef, (docSnap) => { updateWaterUI(docSnap.exists() ? docSnap.data().count : 0); });
                
                renderCalendar();
            } else {
                signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
            }
        });

        // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updateNutritionGoalsUI(profile) {
            if (!profile) return;
            let bmr;
            if (profile.gender === 'male') { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) + 5; } else if (profile.gender === 'female') { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) - 161; } else { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) - 78; }
            const tdee = bmr * profile.activity;
            let finalCalories = tdee;
            if (profile.goal === 'loss') finalCalories -= 500;
            if (profile.goal === 'gain') finalCalories += 300;
            userProfile.nutritionGoals = { calories: Math.round(finalCalories), carbs: Math.round((finalCalories * 0.45) / 4), protein: Math.round((finalCalories * 0.30) / 4), fat: Math.round((finalCalories * 0.25) / 9) };
            document.getElementById('calories-goal').textContent = userProfile.nutritionGoals.calories;
            document.getElementById('carbs-goal').textContent = userProfile.nutritionGoals.carbs;
            document.getElementById('protein-goal').textContent = userProfile.nutritionGoals.protein;
            document.getElementById('fat-goal').textContent = userProfile.nutritionGoals.fat;
        }

        function updateNutritionProgressUI(intake, goals) {
            if (!goals) return;
            const totals = intake.reduce((acc, food) => ({ calories: acc.calories + (food.calories || 0), carbs: acc.carbs + (food.carbs || 0), protein: acc.protein + (food.protein || 0), fat: acc.fat + (food.fat || 0) }), { calories: 0, carbs: 0, protein: 0, fat: 0 });
            const updateRing = (type, current, goal) => {
                document.getElementById(`${type}-current`).textContent = Math.round(current);
                const percentage = goal > 0 ? Math.min(Math.round((current / goal) * 100), 100) : 0;
                document.getElementById(`${type}-ring`).style.setProperty('--p', percentage);
            };
            updateRing('calories', totals.calories, goals.calories); updateRing('carbs', totals.carbs, goals.carbs); updateRing('protein', totals.protein, goals.protein); updateRing('fat', totals.fat, goals.fat);
        }

        function renderMealPlan(plan) {
            mealPlanContent.innerHTML = '';
            const mealTypes = { breakfast: 'ì•„ì¹¨', lunch: 'ì ì‹¬', dinner: 'ì €ë…', snack: 'ê°„ì‹' };
            for (const mealType in plan) {
                const meal = plan[mealType];
                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-2xl custom-shadow meal-card';
                card.innerHTML = `<div class="flex justify-between items-start"><div><h3 class="text-lg font-jua text-rose-500">${mealTypes[mealType]}</h3><p class="text-xl font-semibold my-2 text-slate-800">${meal.name}</p></div><button class="log-ai-meal-btn bg-rose-100 text-rose-600 px-3 py-1 rounded-full text-sm font-semibold hover:bg-rose-200">ì‹ë‹¨ì— ì¶”ê°€</button></div><div class="flex justify-between text-sm text-slate-500 border-t border-slate-100 pt-3 mt-3"><span>ğŸ”¥ ${meal.calories} kcal</span><span>ğŸ ${meal.carbs}g</span><span>ğŸ— ${meal.protein}g</span><span>ğŸ¥‘ ${meal.fat}g</span></div>`;
                card.querySelector('.log-ai-meal-btn').addEventListener('click', () => logFoodItem({ name: `(AI) ${meal.name}`, ...meal, timestamp: Date.now() }));
                mealPlanContent.appendChild(card);
            }
        }

        function renderDailyIntake(foods) {
            dailyIntakeList.innerHTML = '';
            if (foods.length === 0) { dailyIntakeList.innerHTML = '<p class="text-center text-slate-400 py-4">ì•„ì§ ê¸°ë¡ëœ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            foods.forEach((food) => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-2xl custom-shadow flex justify-between items-center';
                const imageHtml = food.photo ? `<img src="${food.photo}" class="w-12 h-12 rounded-lg object-cover mr-4">` : `<div class="w-12 h-12 rounded-lg bg-rose-50 flex-shrink-0 mr-4"></div>`;
                item.innerHTML = `
                    <div class="flex items-center flex-grow">
                        ${imageHtml}
                        <div class="flex-grow">
                            <p class="font-semibold text-slate-800">${food.name}</p>
                            <p class="text-sm text-slate-500">${food.calories}kcal | íƒ„ ${food.carbs}g, ë‹¨ ${food.protein}g, ì§€ ${food.fat}g</p>
                        </div>
                    </div>
                    <button class="remove-intake-btn text-rose-300 hover:text-rose-500 text-2xl font-bold flex-shrink-0 ml-2">&times;</button>
                `;
                item.querySelector('.remove-intake-btn').addEventListener('click', () => removeFoodItem(food));
                dailyIntakeList.appendChild(item);
            });
        }
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        profileButton.addEventListener('click', openProfileModal);
        addFoodButton.addEventListener('click', openAddFoodModal);
        addPhotoButton.addEventListener('click', openPhotoAnalysisModal);
        
        profileModal.addEventListener('click', (e) => e.target === profileModal && closeProfileModal());
        addFoodModal.addEventListener('click', (e) => e.target === addFoodModal && closeAddFoodModal());
        photoAnalysisModal.addEventListener('click', (e) => e.target === photoAnalysisModal && closePhotoAnalysisModal());
        
        cancelAddFoodButton.addEventListener('click', closeAddFoodModal);
        cancelPhotoAnalysisButton.addEventListener('click', closePhotoAnalysisModal);
        
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const profileData = { gender: document.getElementById('gender').value, age: parseInt(document.getElementById('age').value), height: parseFloat(document.getElementById('height').value), weight: parseFloat(document.getElementById('weight').value), activity: parseFloat(document.getElementById('activity').value), goal: document.getElementById('goal').value };
            if (Object.values(profileData).some(v => !v && v !== 0)) { showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
            try { await setDoc(userProfileRef, profileData); showToast('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); closeProfileModal(); } catch (error) { console.error("Error saving profile: ", error); showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        });

        addFoodForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const foodName = document.getElementById('food-name').value;
            const foodWeight = document.getElementById('food-weight').value;
            const foodItem = { 
                name: `${foodName} (${foodWeight}g)`, 
                calories: parseInt(document.getElementById('food-calories').value), 
                carbs: parseInt(document.getElementById('food-carbs').value), 
                protein: parseInt(document.getElementById('food-protein').value), 
                fat: parseInt(document.getElementById('food-fat').value), 
                timestamp: Date.now(), 
                photo: manualImageBase64 
            };
            if (Object.values(foodItem).some(v => (v !== null && v !== 0 && !v) || (typeof v === 'number' && isNaN(v)))) { showToast('ëª¨ë“  ì˜ì–‘ ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            logFoodItem(foodItem);
            addFoodForm.reset();
            closeAddFoodModal();
        });

        generatePlanButton.addEventListener('click', generateMealPlan);

        // --- AI ì‚¬ì§„ ë¶„ì„ ê´€ë ¨ ì´ë²¤íŠ¸ ---
        photoInput.addEventListener('change', (event) => handleImageSelection(event, imagePreview, (base64) => { selectedImageBase64 = base64; analyzePhotoButton.disabled = false; }));
        manualPhotoInput.addEventListener('change', (event) => handleImageSelection(event, manualImagePreview, (base64) => { manualImageBase64 = base64; }));

        function handleImageSelection(event, previewElement, callback) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64String = reader.result.replace('data:', '').replace(/^.+,/, '');
                callback(reader.result); // Save full data URL for display
                previewElement.style.backgroundImage = `url('${reader.result}')`;
                previewElement.style.backgroundSize = 'cover';
                previewElement.style.backgroundPosition = 'center';
                previewElement.innerHTML = '';
            };
            reader.readAsDataURL(file);
        }

        analyzePhotoButton.addEventListener('click', async () => {
            if (!selectedImageBase64) { showToast('ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            document.getElementById('photo-upload-view').classList.add('hidden');
            document.getElementById('photo-loading-view').classList.remove('hidden');
            try {
                const resultText = await callGeminiVisionAPI(selectedImageBase64.split(',')[1]);
                const resultData = JSON.parse(resultText);
                renderPhotoAnalysisResult(resultData);
                document.getElementById('photo-loading-view').classList.add('hidden');
                document.getElementById('photo-result-view').classList.remove('hidden');
            } catch (error) {
                console.error('Photo analysis failed:', error);
                showToast('ì‚¬ì§„ ë¶„ì„ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë” ë°ì€ í™˜ê²½ì—ì„œ ë‹¤ì‹œ ì´¬ì˜í•´ë³´ì„¸ìš”!');
                document.getElementById('photo-loading-view').classList.add('hidden');
                document.getElementById('photo-upload-view').classList.remove('hidden');
            }
        });

        calculateNutrientsBtn.addEventListener('click', async () => {
            const foodName = document.getElementById('food-name').value;
            const foodWeight = document.getElementById('food-weight').value;
            if (!foodName || !foodWeight) { showToast('ìŒì‹ ì´ë¦„ê³¼ ì–‘(g)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            
            nutrientLoader.classList.remove('hidden');
            try {
                const resultText = await callGeminiNutritionAPI(`${foodName} ${foodWeight}g`);
                const data = JSON.parse(resultText);
                document.getElementById('food-calories').value = data.calories;
                document.getElementById('food-carbs').value = data.carbs;
                document.getElementById('food-protein').value = data.protein;
                document.getElementById('food-fat').value = data.fat;
            } catch (error) {
                console.error('Nutrient calculation failed:', error);
                showToast('ì˜ì–‘ì†Œ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            } finally {
                nutrientLoader.classList.add('hidden');
            }
        });

        // --- ìº˜ë¦°ë” ê´€ë ¨ ì´ë²¤íŠ¸ ---
        calendarToggleButton.addEventListener('click', () => {
            const isDashboardVisible = !dashboardView.classList.contains('hidden');
            dashboardView.classList.toggle('hidden');
            calendarView.classList.toggle('hidden');
            if (isDashboardVisible) {
                // ëŒ€ì‹œë³´ë“œ -> ìº˜ë¦°ë” í™”ë©´ìœ¼ë¡œ ì „í™˜
                calendarToggleButton.innerHTML = homeIconSVG;
                renderCalendar(); // ìµœì‹  ë°ì´í„°ë¡œ ìº˜ë¦°ë”ë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
            } else {
                // ìº˜ë¦°ë” -> ëŒ€ì‹œë³´ë“œ í™”ë©´ìœ¼ë¡œ ì „í™˜
                calendarToggleButton.innerHTML = calendarIconSVG;
            }
        });

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        
        closeCalendarDetailBtn.addEventListener('click', () => closeModal(calendarDetailModal));
        calendarDetailModal.addEventListener('click', (e) => e.target === calendarDetailModal && closeModal(calendarDetailModal));

        // --- í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ ---
        async function logFoodItem(foodItem) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, today);
            try { 
                await updateDoc(dailyIntakeRef, { foods: arrayUnion(foodItem) }); 
                showToast(`${foodItem.name} ê¸°ë¡ ì™„ë£Œ!`);
            } catch (error) { 
                if (error.code === 'not-found') { 
                    await setDoc(dailyIntakeRef, { foods: [foodItem] }); 
                    showToast(`${foodItem.name} ê¸°ë¡ ì™„ë£Œ!`);
                } else { 
                    console.error("Error logging food: ", error); 
                    showToast('ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); 
                } 
            }
            renderCalendar(); // ìº˜ë¦°ë” ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        }
        
        async function removeFoodItem(foodToRemove) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, today);
            try { 
                await updateDoc(dailyIntakeRef, { foods: arrayRemove(foodToRemove) }); 
                showToast(`${foodToRemove.name} ì‚­ì œ ì™„ë£Œ!`);
                renderCalendar(); // ìº˜ë¦°ë” ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            } catch (error) { 
                console.error("Error removing food: ", error); 
                showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); 
            }
        }

        async function generateMealPlan() {
            if (!userProfile || !userProfile.nutritionGoals) { showToast('ë¨¼ì € í”„ë¡œí•„ì„ ì €ì¥í•´ì£¼ì„¸ìš”.'); openProfileModal(); return; }
            loader.classList.remove('hidden');
            mealPlanContent.innerHTML = '';
            generatePlanButton.disabled = true;
            const userInfoParts = [ `ë‚˜ì´: ${userProfile.age}ì„¸`, userProfile.gender !== 'unspecified' ? `ì„±ë³„: ${userProfile.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}` : '', `ëª©í‘œ: ${userProfile.goal === 'loss' ? 'ì²´ì¤‘ ê°ëŸ‰' : (userProfile.goal === 'gain' ? 'ì²´ì¤‘ ì¦ê°€' : 'ì²´ì¤‘ ìœ ì§€')}` ].filter(part => part).join(', ');
            const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ì‚¬ìš©ì ì •ë³´ì™€ ì˜ì–‘ ëª©í‘œì— ë§ì¶°, ë§›ê³¼ ì˜ì–‘ì„ ëª¨ë‘ ê³ ë ¤í•œ í•œêµ­ì‹ ìœ„ì£¼ì˜ í•˜ë£¨ ì‹ë‹¨(ì•„ì¹¨, ì ì‹¬, ì €ë…, ê°„ì‹)ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”. ì‚¬ìš©ì ì •ë³´: ${userInfoParts}. ì¼ì¼ ì˜ì–‘ ëª©í‘œ: ì¹¼ë¡œë¦¬ ${userProfile.nutritionGoals.calories}kcal, íƒ„ìˆ˜í™”ë¬¼ ${userProfile.nutritionGoals.carbs}g, ë‹¨ë°±ì§ˆ ${userProfile.nutritionGoals.protein}g, ì§€ë°© ${userProfile.nutritionGoals.fat}g. ê° ì‹ì‚¬ì˜ ìŒì‹ ì´ë¦„ê³¼ ì˜ˆìƒ ì˜ì–‘ì„±ë¶„(ì¹¼ë¡œë¦¬,íƒ„ìˆ˜í™”ë¬¼,ë‹¨ë°±ì§ˆ,ì§€ë°©)ì„ ê³„ì‚°í•˜ì—¬ ì œê³µí•´ì£¼ì„¸ìš”. ì „ì²´ ì‹ë‹¨ì˜ ì˜ì–‘ì†Œ ì´í•©ì´ ëª©í‘œì¹˜ì— ìµœëŒ€í•œ ê·¼ì ‘í•´ì•¼ í•©ë‹ˆë‹¤.`;
            try {
                const responseText = await callGeminiAPI(prompt);
                const plan = JSON.parse(responseText);
                const today = new Date().toISOString().slice(0, 10);
                const mealPlanRef = doc(db, `artifacts/${appId}/users/${userId}/mealPlans`, today);
                await setDoc(mealPlanRef, { plan: plan, createdAt: new Date() });
                showToast('AI ë§ì¶¤ ì‹ë‹¨ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error("Error generating meal plan:", error);
                mealPlanContent.innerHTML = '<p class="text-center text-red-500 md:col-span-2">ì‹ë‹¨ ìƒì„± ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                showToast('ì‹ë‹¨ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                loader.classList.add('hidden');
                generatePlanButton.disabled = false;
            }
        }
        
        async function renderCalendar() {
            if (!userId) return;
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            calendarMonthYear.textContent = `${year}ë…„ ${month + 1}ì›”`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
            
            // Fetch meal data for the current month
            const mealQuery = query(collection(db, `artifacts/${appId}/users/${userId}/dailyIntake`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const mealSnapshot = await getDocs(mealQuery);
            const monthMealData = {};
            mealSnapshot.forEach(doc => {
                monthMealData[doc.id] = doc.data();
            });

            // Fetch water data for the current month
            const waterQuery = query(collection(db, `artifacts/${appId}/users/${userId}/water`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const waterSnapshot = await getDocs(waterQuery);
            const monthWaterData = {};
            waterSnapshot.forEach(doc => {
                monthWaterData[doc.id] = doc.data();
            });

            for (let i = 0; i < firstDay; i++) {
                calendarGrid.innerHTML += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasMealData = monthMealData[dayStr] && monthMealData[dayStr].foods.length > 0;
                const hasWaterData = monthWaterData[dayStr] && monthWaterData[dayStr].count > 0;
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                
                const dayCell = document.createElement('div');
                dayCell.className = 'h-16 flex flex-col items-center justify-center rounded-2xl calendar-day';
                
                let iconsHTML = '';
                if (hasMealData) iconsHTML += '<span class="text-xs">ğŸ½ï¸</span>';
                if (hasWaterData) iconsHTML += '<span class="text-xs">ğŸ’§</span>';
                
                dayCell.innerHTML = `<span class="text-sm">${day}</span><div class="flex">${iconsHTML}</div>`;
                
                if (isToday) dayCell.classList.add('bg-rose-100', 'font-bold', 'text-rose-600');
                
                if (hasMealData || hasWaterData) {
                    dayCell.classList.add('cursor-pointer', 'hover:bg-rose-50');
                    dayCell.addEventListener('click', () => openCalendarDetailModal(dayStr, monthMealData[dayStr]?.foods || [], monthWaterData[dayStr]?.count || 0));
                }
                calendarGrid.appendChild(dayCell);
            }
        }

        function openCalendarDetailModal(dateStr, foods, waterCount) {
            document.getElementById('calendar-detail-title').textContent = `${dateStr} ê¸°ë¡`;
            const listEl = document.getElementById('calendar-detail-list');
            listEl.innerHTML = '';
            
            const waterItem = document.createElement('div');
            waterItem.className = 'bg-sky-50 p-4 rounded-2xl flex items-center';
            waterItem.innerHTML = `<span class="text-2xl mr-4">ğŸ’§</span><div class="flex-grow"><p class="font-semibold text-sky-800">ì´ ìˆ˜ë¶„ ì„­ì·¨</p><p class="text-sm text-sky-600">${waterCount} ì” (${waterCount * 250}ml)</p></div>`;
            listEl.appendChild(waterItem);

            if (foods.length === 0) {
                listEl.innerHTML += '<p class="text-center text-slate-400 py-4">ê¸°ë¡ëœ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                foods.forEach(food => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl custom-shadow flex items-center';
                    const imageHtml = food.photo ? `<img src="${food.photo}" class="w-12 h-12 rounded-lg object-cover mr-4">` : `<div class="w-12 h-12 rounded-lg bg-rose-50 flex-shrink-0 mr-4"></div>`;
                    item.innerHTML = `${imageHtml}<div class="flex-grow"><p class="font-semibold text-slate-800">${food.name}</p><p class="text-sm text-slate-500">${food.calories}kcal | íƒ„ ${food.carbs}g, ë‹¨ ${food.protein}g, ì§€ ${food.fat}g</p></div>`;
                    listEl.appendChild(item);
                });
            }
            openModal(calendarDetailModal);
        }

        // --- Gemini API í˜¸ì¶œ ---
        async function callGeminiAPI(prompt) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { breakfast: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, lunch: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, dinner: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, snack: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } } } } } };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); 
            const result = await response.json(); 
            if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text; 
            else throw new Error("API ì‘ë‹µì— ìœ íš¨í•œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤."); 
        }

        async function callGeminiNutritionAPI(foodString) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `'${foodString}'ì˜ ì˜ˆìƒ ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© í•¨ëŸ‰ì„ ê³„ì‚°í•´ì„œ JSON í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì¤˜. ê°’ì€ ì†Œìˆ˜ì  ì—†ì´ ì •ìˆ˜ë¡œë§Œ ì œê³µí•´ì•¼ í•´.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } } } };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
            else throw new Error("API ì‘ë‹µì— ìœ íš¨í•œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
        
        async function callGeminiVisionAPI(base64ImageData) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = "ì´ ìŒì‹ ì‚¬ì§„ì„ ë¶„ì„í•´ì„œ, ìŒì‹ ì´ë¦„, ì˜ˆìƒ ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© í•¨ëŸ‰, ê·¸ë¦¬ê³  ì´ ìŒì‹ì— ëŒ€í•œ ê°„ë‹¨í•œ ì˜ì–‘í•™ì  ì¡°ì–¸ì´ë‚˜ íŒì„ JSON í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì¤˜.";
            const payload = { contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } } ] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" }, tip: { type: "STRING" } } } } };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
            else throw new Error("API ì‘ë‹µì— ìœ íš¨í•œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
        
        function renderPhotoAnalysisResult(data) {
            const resultView = document.getElementById('photo-result-view');
            resultView.innerHTML = `<div class="text-center"><p class="text-sm text-slate-500">AI ë¶„ì„ ê²°ê³¼</p><p class="text-2xl font-jua text-rose-600 my-2">${data.name}</p></div><div class="my-4 bg-rose-50 p-4 rounded-2xl space-y-2 text-sm"><div class="flex justify-between"><span>ğŸ”¥ ì¹¼ë¡œë¦¬</span><span class="font-semibold">${data.calories} kcal</span></div><div class="flex justify-between"><span>ğŸ íƒ„ìˆ˜í™”ë¬¼</span><span class="font-semibold">${data.carbs} g</span></div><div class="flex justify-between"><span>ğŸ— ë‹¨ë°±ì§ˆ</span><span class="font-semibold">${data.protein} g</span></div><div class="flex justify-between"><span>ğŸ¥‘ ì§€ë°©</span><span class="font-semibold">${data.fat} g</span></div></div><div class="my-4 text-center text-sm bg-sky-50 text-sky-700 p-3 rounded-2xl"><p>ğŸ’¡ <strong>ì˜ì–‘ íŒ:</strong> ${data.tip}</p></div><button id="log-photo-result" class="w-full bg-rose-500 text-white py-3 rounded-full font-semibold hover:bg-rose-600 transition">ê¸°ë¡í•˜ê¸°</button>`;
            document.getElementById('log-photo-result').addEventListener('click', () => { logFoodItem({ name: `(ì‚¬ì§„) ${data.name}`, ...data, timestamp: Date.now() }); closePhotoAnalysisModal(); });
        }

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function openModal(modal) { modal.classList.remove('pointer-events-none', 'opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }
        function closeModal(modal) { modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('scale-95'); setTimeout(() => modal.classList.add('pointer-events-none'), 300); }
        function openProfileModal() { if(userProfile) { document.getElementById('gender').value = userProfile.gender || 'female'; document.getElementById('age').value = userProfile.age || ''; document.getElementById('height').value = userProfile.height || ''; document.getElementById('weight').value = userProfile.weight || ''; document.getElementById('activity').value = userProfile.activity || '1.55'; document.getElementById('goal').value = userProfile.goal || 'maintain'; } openModal(profileModal); }
        function closeProfileModal() { closeModal(profileModal); }
        function openAddFoodModal() { openModal(addFoodModal); }
        function closeAddFoodModal() { 
            closeModal(addFoodModal);
            setTimeout(() => {
                addFoodForm.reset();
                manualImageBase64 = null;
                manualImagePreview.style.backgroundImage = 'url("data:image/svg+xml,%3csvg width=\'100%25\' height=\'100%25\' xmlns=\'http://www.w3.org/2000/svg\'%3e%3crect width=\'100%25\' height=\'100%25\' fill=\'none\' rx=\'24\' ry=\'24\' stroke=\'%23FBCFE8FF\' stroke-width=\'4\' stroke-dasharray=\'6%2c 14\' stroke-dashoffset=\'0\' stroke-linecap=\'square\'/%3e%3c/svg%3e")';
                manualImagePreview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg><p class="mt-2 text-sm font-semibold">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</p>';
            }, 300);
        }
        function openPhotoAnalysisModal() { openModal(photoAnalysisModal); }
        function closePhotoAnalysisModal() { 
            closeModal(photoAnalysisModal);
            setTimeout(() => {
                document.getElementById('photo-upload-view').classList.remove('hidden');
                document.getElementById('photo-loading-view').classList.add('hidden');
                document.getElementById('photo-result-view').classList.add('hidden').innerHTML = '';
                imagePreview.style.backgroundImage = 'url("data:image/svg+xml,%3csvg width=\'100%25\' height=\'100%25\' xmlns=\'http://www.w3.org/2000/svg\'%3e%3crect width=\'100%25\' height=\'100%25\' fill=\'none\' rx=\'24\' ry=\'24\' stroke=\'%23FBCFE8FF\' stroke-width=\'4\' stroke-dasharray=\'6%2c 14\' stroke-dashoffset=\'0\' stroke-linecap=\'square\'/%3e%3c/svg%3e")';
                imagePreview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><p class="mt-2 font-semibold">ì‚¬ì§„ì„ ì—¬ê¸°ì— ì˜¬ë ¤ì£¼ì„¸ìš”</p>';
                photoInput.value = '';
                selectedImageBase64 = null;
                analyzePhotoButton.disabled = true;
            }, 300);
        }
        
        let toastTimer;
        function showToast(message) { const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); toastMessage.textContent = message; toast.classList.remove('opacity-0', 'translate-y-2'); clearTimeout(toastTimer); toastTimer = setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-2'); }, 3000); }

        // --- ë¬¼ ì„­ì·¨ëŸ‰ ê´€ë ¨ ---
        const addWaterBtn = document.getElementById('add-water-button');
        const removeWaterBtn = document.getElementById('remove-water-button');
        let currentWaterIntake = 0;
        function updateWaterUI(count) { currentWaterIntake = count; document.getElementById('water-intake').textContent = count; }
        async function updateWaterInDB(newCount) { 
            if (newCount < 0) newCount = 0; 
            const today = new Date().toISOString().slice(0, 10); 
            const waterRef = doc(db, `artifacts/${appId}/users/${userId}/water`, today); 
            try { 
                await setDoc(waterRef, { count: newCount }); 
                renderCalendar(); // ìº˜ë¦°ë” ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            } catch (error) { 
                console.error("Error updating water intake: ", error); 
                showToast('ë¬¼ ì„­ì·¨ëŸ‰ ê¸°ë¡ ì‹¤íŒ¨.'); 
            } 
        }
        addWaterBtn.addEventListener('click', () => updateWaterInDB(currentWaterIntake + 1));
        removeWaterBtn.addEventListener('click', () => updateWaterInDB(currentWaterIntake - 1));

    </script>
</body>
</html>
