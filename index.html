<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”¼íŠ¸ë°€ - ë‚˜ë§Œì˜ AI ì˜ì–‘ì‚¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #fff7ed; }
        .font-jua { font-family: 'Jua', sans-serif; }
        .nutrient-ring {
            --size: 72px; --thickness: 8px; width: var(--size); height: var(--size); position: relative;
            display: inline-grid; place-content: center; font-size: 0.8rem; font-weight: 600;
        }
        .nutrient-ring::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: conic-gradient(var(--color, #f97316) calc(var(--p, 0) * 1%), #fed7aa 0);
            border-radius: 50%;
            mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            -webkit-mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            transition: background 0.5s ease-in-out;
        }
        [data-action] { cursor: pointer; }
        .card-shadow { box-shadow: 0 4px 12px 0 rgba(249, 115, 22, 0.1); }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
    </style>
</head>
<body class="text-slate-700">

    <div id="app" class="max-w-2xl mx-auto p-4">
        </div>

    <div id="modal-container">
        </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50">
         </div>

    <script type="module">
        // Firebase SDK ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // --- 1. ì„¤ì • ë° ì´ˆê¸°í™” ---
        const firebaseConfig = {
            apiKey: "AIzaSyCRax6rd1rlBIc3kVgg5OkHmSIQyzJmC8A",
            authDomain: "fitmeal-app-d1a97.firebaseapp.com",
            projectId: "fitmeal-app-d1a97",
            storageBucket: "fitmeal-app-d1a97.appspot.com",
            messagingSenderId: "968711774677",
            appId: "1:968711774677:web:b3d3cb9ccc2388c3ba5d5c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const callGeminiAPI_server = httpsCallable(functions, 'callGeminiAPI');
        const callGeminiVisionAPI_server = httpsCallable(functions, 'callGeminiVisionAPI');

        const MOCK_USER_ID = 'local-user';
        const todayString = new Date().toISOString().slice(0, 10);

        // --- 2. ì•± ìƒíƒœ ê´€ë¦¬ ---
        const state = {
            userProfile: null,
            records: {}, 
            mealPlan: null,
            currentPage: 'loading',
            isLoading: false,
            currentDate: todayString,
        };

        // --- 3. UI ì»´í¬ë„ŒíŠ¸ (HTML í…œí”Œë¦¿ í•¨ìˆ˜) ---
        const AppShell = (content) => `
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-jua text-orange-500">í”¼íŠ¸ë°€ ğŸ¥—</h1>
                <div class="flex items-center gap-4">
                    <button data-action="show-calendar" class="text-slate-400 hover:text-orange-500">
                        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>
                    </button>
                    <button data-action="open-profile" class="text-slate-400 hover:text-orange-500">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/></svg>
                    </button>
                </div>
            </header>
            <main>${content}</main>
        `;
        
        const LoadingSpinner = () => `<div class="text-center py-10"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div></div>`;
        
        const ProfileSetupPage = (isModal = false) => {
            const profile = state.userProfile || {};
            return `
                <div class="bg-white rounded-2xl card-shadow p-6 ${isModal ? '' : 'mt-10'}">
                    <h2 class="text-2xl font-jua text-orange-500 mb-2 text-center">í”„ë¡œí•„ ì„¤ì •</h2>
                    <p class="text-slate-500 mb-6 text-center">ì •í™•í•œ AI ì¶”ì²œì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    <form id="profile-form" class="space-y-4" data-action="save-profile">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-slate-600">ì„±ë³„</label><select id="gender" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"><option value="female" ${profile.gender === 'female' ? 'selected' : ''}>ì—¬ì„±</option><option value="male" ${profile.gender === 'male' ? 'selected' : ''}>ë‚¨ì„±</option></select></div>
                            <div><label class="block text-sm font-medium text-slate-600">ë‚˜ì´</label><input type="number" id="age" value="${profile.age || ''}" class="mt-1 block w-full rounded-lg border-slate-300" placeholder="ì„¸" required></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-slate-600">ì‹ ì¥ (cm)</label><input type="number" id="height" value="${profile.height || ''}" class="mt-1 block w-full rounded-lg border-slate-300" required></div>
                            <div><label class="block text-sm font-medium text-slate-600">ì²´ì¤‘ (kg)</label><input type="number" id="weight" value="${profile.weight || ''}" class="mt-1 block w-full rounded-lg border-slate-300" required></div>
                        </div>
                        <div><label class="block text-sm font-medium text-slate-600">í™œë™ëŸ‰</label><select id="activity" class="mt-1 block w-full rounded-lg border-slate-300"><option value="1.2" ${profile.activity == 1.2 ? 'selected' : ''}>ê±°ì˜ ì—†ìŒ</option><option value="1.375" ${profile.activity == 1.375 ? 'selected' : ''}>ê°€ë²¼ìš´ í™œë™</option><option value="1.55" ${profile.activity == 1.55 ? 'selected' : ''}>ë³´í†µ í™œë™</option><option value="1.725" ${profile.activity == 1.725 ? 'selected' : ''}>ë†’ì€ í™œë™</option><option value="1.9" ${profile.activity == 1.9 ? 'selected' : ''}>ë§¤ìš° ë†’ì€ í™œë™</option></select></div>
                        <div><label class="block text-sm font-medium text-slate-600">ëª©í‘œ</label><select id="goal" class="mt-1 block w-full rounded-lg border-slate-300"><option value="loss" ${profile.goal === 'loss' ? 'selected' : ''}>ì²´ì¤‘ ê°ëŸ‰</option><option value="maintain" ${profile.goal === 'maintain' ? 'selected' : ''}>ì²´ì¤‘ ìœ ì§€</option><option value="gain" ${profile.goal === 'gain' ? 'selected' : ''}>ì²´ì¤‘ ì¦ê°€</option></select></div>
                        <div class="pt-4"><button type="submit" class="w-full bg-orange-500 text-white py-3 rounded-full font-semibold hover:bg-orange-600 transition">ì €ì¥í•˜ê¸°</button></div>
                    </form>
                </div>
            `;
        };
        
        const DashboardPage = () => {
            const records = state.records[state.currentDate] || { meals: [], exercises: [], water: 0 };
            const goals = state.userProfile?.nutritionGoals || {};
            
            const totals = records.meals.reduce((acc, meal) => {
                acc.calories += meal.calories; acc.carbs += meal.carbs;
                acc.protein += meal.protein; acc.fat += meal.fat;
                return acc;
            }, { calories: 0, carbs: 0, protein: 0, fat: 0 });

            return `
                <div class="space-y-6">
                    <section class="bg-white p-4 rounded-2xl card-shadow">
                        <h2 class="text-xl font-jua text-orange-500 mb-3">ì˜¤ëŠ˜ì˜ ì˜ì–‘ì†Œ (${state.currentDate})</h2>
                        <div class="grid grid-cols-4 gap-2 text-center">
                            ${NutritionRing('ì¹¼ë¡œë¦¬', totals.calories, goals.calories, 'kcal', '#f97316')}
                            ${NutritionRing('íƒ„ìˆ˜í™”ë¬¼', totals.carbs, goals.carbs, 'g', '#14b8a6')}
                            ${NutritionRing('ë‹¨ë°±ì§ˆ', totals.protein, goals.protein, 'g', '#f59e0b')}
                            ${NutritionRing('ì§€ë°©', totals.fat, goals.fat, 'g', '#8b5cf6')}
                        </div>
                    </section>

                    <section>${AiMealPlan(state.mealPlan)}</section>

                    <section>
                        <h2 class="text-xl font-jua text-orange-500 mb-3">ì‹ë‹¨ ê¸°ë¡ ğŸ“</h2>
                        <div id="meal-list" class="space-y-2 mb-3">
                            ${records.meals.length > 0 ? records.meals.map(MealItem).join('') : '<p class="text-center text-slate-400 py-4">ê¸°ë¡ëœ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button data-action="add-meal-manual" class="w-full bg-white border-2 border-dashed border-orange-200 text-orange-600 py-3 rounded-xl font-semibold hover:bg-orange-50 transition">+ ì§ì ‘ ì…ë ¥</button>
                            <button data-action="add-meal-photo" class="w-full bg-orange-500 text-white py-3 rounded-xl font-semibold hover:bg-orange-600 transition">ğŸ“· AI ì¹´ë©”ë¼ë¡œ ê¸°ë¡</button>
                        </div>
                    </section>
                    
                     <section>
                        <h2 class="text-xl font-jua text-orange-500 mb-3">ìš´ë™ ê¸°ë¡ ğŸ‹ï¸â€â™€ï¸</h2>
                        <div id="exercise-list" class="space-y-2 mb-3">
                           ${records.exercises.length > 0 ? records.exercises.map(ExerciseItem).join('') : '<p class="text-center text-slate-400 py-4">ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                        </div>
                        <button data-action="add-exercise" class="w-full bg-white border-2 border-dashed border-teal-200 text-teal-600 py-3 rounded-xl font-semibold hover:bg-teal-50 transition">+ ìš´ë™ ì¶”ê°€í•˜ê¸°</button>
                    </section>

                    <section class="bg-white p-4 rounded-2xl card-shadow">
                        <h2 class="text-xl font-jua text-orange-500 mb-3">ìˆ˜ë¶„ ì„­ì·¨ ğŸ’§</h2>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-3xl font-bold text-sky-500">${records.water} / 8 ì”</p>
                                <p class="text-slate-400 text-sm">${records.water * 250}ml / 2L ëª©í‘œ</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-action="update-water" data-value="${records.water + 1}" class="bg-sky-400 text-white rounded-full w-12 h-12 text-2xl font-bold hover:bg-sky-500 transition">+</button>
                                <button data-action="update-water" data-value="${records.water - 1}" class="bg-slate-100 text-slate-500 rounded-full w-12 h-12 text-2xl font-bold hover:bg-slate-200 transition">-</button>
                            </div>
                        </div>
                    </section>
                </div>
            `;
        };

        const NutritionRing = (name, current, goal, unit, color) => `
            <div>
                <div class="nutrient-ring mx-auto" style="--color: ${color}; --p: ${goal > 0 ? Math.min(Math.round((current / goal) * 100), 100) : 0};">
                    <span>${Math.round(current)}</span>
                    <small class="text-slate-400">/ ${goal || 0}</small>
                </div>
                <p class="mt-1 font-semibold text-sm">${name}</p>
            </div>
        `;

        const AiMealPlan = (plan) => `
            <h2 class="text-xl font-jua text-orange-500 mb-3">AI ì¶”ì²œ ì‹ë‹¨ âœ¨</h2>
            <div id="meal-plan-content" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                ${plan ? Object.entries(plan).map(([type, meal]) => MealPlanCard(type, meal)).join('') : '<p class="text-center text-slate-400 py-4 md:col-span-2">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ì²œ ì‹ë‹¨ì„ ë°›ì•„ë³´ì„¸ìš”.</p>'}
            </div>
            <button data-action="generate-plan" class="w-full bg-orange-800 text-white py-3 rounded-xl font-semibold hover:bg-orange-900 transition">ìƒˆ ì‹ë‹¨ ë°›ê¸°</button>
        `;

        const MealPlanCard = (type, meal) => {
            const mealTypes = { breakfast: 'ì•„ì¹¨', lunch: 'ì ì‹¬', dinner: 'ì €ë…', snack: 'ê°„ì‹' };
            const mealData = JSON.stringify({ name: `(AI) ${meal.name}`, ...meal });
            return `
                <div class="bg-white p-4 rounded-xl card-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-jua text-orange-500">${mealTypes[type]}</h3>
                            <p class="text-lg font-semibold my-1">${meal.name}</p>
                        </div>
                        <button data-action="log-ai-meal" data-meal='${mealData}' class="bg-orange-100 text-orange-600 w-9 h-9 rounded-full text-xl font-semibold hover:bg-orange-200 flex items-center justify-center">+</button>
                    </div>
                    <div class="flex justify-between text-xs text-slate-500 border-t pt-2 mt-2">
                        <span>ğŸ”¥ ${meal.calories}kcal</span><span>ğŸ ${meal.carbs}g</span><span>ğŸ— ${meal.protein}g</span><span>ğŸ¥‘ ${meal.fat}g</span>
                    </div>
                </div>
            `;
        };
        
        const MealItem = (meal) => `
            <div class="bg-white p-3 rounded-xl card-shadow flex justify-between items-center">
                <div class="flex items-center flex-grow">
                    ${meal.photo ? `<img src="${meal.photo}" class="w-12 h-12 rounded-lg object-cover mr-3">` : `<div class="w-12 h-12 rounded-lg bg-orange-50 flex-shrink-0 mr-3"></div>`}
                    <div class="flex-grow">
                        <p class="font-semibold">${meal.name}</p>
                        <p class="text-sm text-slate-500">${meal.calories}kcal | íƒ„ ${meal.carbs}g, ë‹¨ ${meal.protein}g, ì§€ ${meal.fat}g</p>
                    </div>
                </div>
                <button data-action="delete-meal" data-id="${meal.id}" class="text-rose-400 hover:text-rose-600 text-2xl font-bold flex-shrink-0 ml-2">&times;</button>
            </div>
        `;
        
        const ExerciseItem = (exercise) => `
             <div class="bg-white p-3 rounded-xl card-shadow flex justify-between items-center">
                <div>
                    <p class="font-semibold">${exercise.name}</p>
                    <p class="text-sm text-slate-500">${exercise.duration}ë¶„ | ${exercise.calories}kcal ì†Œëª¨</p>
                </div>
                <button data-action="delete-exercise" data-id="${exercise.id}" class="text-rose-400 hover:text-rose-600 text-2xl font-bold">&times;</button>
            </div>
        `;

        const Modal = (title, content, actions) => `
            <div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40 opacity-0" data-action="close-modal">
                <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md p-6 transform scale-95">
                    <h2 class="text-2xl font-jua text-orange-500 mb-6 text-center">${title}</h2>
                    ${content}
                    ${actions ? `<div class="pt-4 flex space-x-3">${actions}</div>` : ''}
                </div>
            </div>
        `;

        // --- 4. ë°ì´í„°ë² ì´ìŠ¤ ë° API í•¨ìˆ˜ ---
        const dbService = {
            getProfile: async () => {
                const docRef = doc(db, `users/${MOCK_USER_ID}/profile/data`);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            },
            saveProfile: (profileData) => {
                const docRef = doc(db, `users/${MOCK_USER_ID}/profile/data`);
                return setDoc(docRef, profileData);
            },
            getRecords: async (dateStr) => {
                const docRef = doc(db, `users/${MOCK_USER_ID}/records/${dateStr}`);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : { meals: [], exercises: [], water: 0 };
            },
            saveRecords: (dateStr, records) => {
                const docRef = doc(db, `users/${MOCK_USER_ID}/records/${dateStr}`);
                return setDoc(docRef, records, { merge: true });
            }
        };

        const aiService = {
            generateMealPlan: (profile) => {
                const prompt = `ì‚¬ìš©ì ì •ë³´: ë‚˜ì´ ${profile.age}ì„¸, ì„±ë³„ ${profile.gender}, ëª©í‘œ ${profile.goal}. ì˜ì–‘ ëª©í‘œ: ì¹¼ë¡œë¦¬ ${profile.nutritionGoals.calories}kcal, íƒ„ìˆ˜í™”ë¬¼ ${profile.nutritionGoals.carbs}g, ë‹¨ë°±ì§ˆ ${profile.nutritionGoals.protein}g, ì§€ë°© ${profile.nutritionGoals.fat}g. ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œêµ­ì‹ ìœ„ì£¼ì˜ ë§›ìˆëŠ” í•˜ë£¨ ì‹ë‹¨(ì•„ì¹¨, ì ì‹¬, ì €ë…, ê°„ì‹)ì„ ì¶”ì²œí•´ì¤˜.`;
                const schema = { type: "OBJECT", properties: { breakfast: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, lunch: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, dinner: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, snack: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } } } };
                return callGeminiAPI_server({ prompt, schema }).then(res => JSON.parse(res.data.result));
            },
            analyzeFoodImage: (base64) => {
                const prompt = "ì´ ìŒì‹ ì‚¬ì§„ì„ ë¶„ì„í•´ì„œ, ìŒì‹ ì´ë¦„, ì˜ˆìƒ ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© í•¨ëŸ‰, ê·¸ë¦¬ê³  ì˜ì–‘í•™ì  ì¡°ì–¸ì„ JSON í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì¤˜.";
                const schema = { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" }, tip: { type: "STRING" } } };
                return callGeminiVisionAPI_server({ base64ImageData: base64, prompt, schema }).then(res => JSON.parse(res.data.result));
            }
        };

        // --- 5. í•µì‹¬ ë¡œì§ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        const calculateGoals = (profile) => {
            let bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) + (profile.gender === 'male' ? 5 : -161);
            let tdee = bmr * profile.activity;
            if (profile.goal === 'loss') tdee -= 500; if (profile.goal === 'gain') tdee += 300;
            return {
                calories: Math.round(tdee), carbs: Math.round((tdee * 0.45) / 4),
                protein: Math.round((tdee * 0.30) / 4), fat: Math.round((tdee * 0.25) / 9)
            };
        };

        const actions = {
            async saveProfile(e) {
                e.preventDefault();
                const form = e.target;
                const profileData = {
                    gender: form.querySelector('#gender').value,
                    age: parseInt(form.querySelector('#age').value),
                    height: parseFloat(form.querySelector('#height').value),
                    weight: parseFloat(form.querySelector('#weight').value),
                    activity: parseFloat(form.querySelector('#activity').value),
                    goal: form.querySelector('#goal').value,
                };
                profileData.nutritionGoals = calculateGoals(profileData);
                await dbService.saveProfile(profileData);
                state.userProfile = profileData;
                state.currentPage = 'dashboard';
                await loadDataForDate(state.currentDate);
                render();
                showToast('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeModal();
            },
            openProfile() {
                renderModal('ë‚´ ì •ë³´ ìˆ˜ì •', ProfileSetupPage(true));
            },
            async generatePlan() {
                showToast('AIê°€ ì‹ë‹¨ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
                try {
                    const plan = await aiService.generateMealPlan(state.userProfile);
                    state.mealPlan = plan;
                    render();
                    showToast('AI ì¶”ì²œ ì‹ë‹¨ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (e) { showToast('ì‹ë‹¨ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error'); }
            },
            async logAiMeal(e) {
                const mealData = JSON.parse(e.target.dataset.meal);
                mealData.id = Date.now();
                const currentRecords = state.records[state.currentDate] || { meals: [], exercises: [], water: 0 };
                currentRecords.meals.push(mealData);
                await dbService.saveRecords(state.currentDate, currentRecords);
                render();
                showToast(`${mealData.name} ê¸°ë¡ ì™„ë£Œ!`);
            },
            async updateWater(e) {
                const newCount = Math.max(0, parseInt(e.target.dataset.value));
                const currentRecords = state.records[state.currentDate] || { meals: [], exercises: [], water: 0 };
                currentRecords.water = newCount;
                await dbService.saveRecords(state.currentDate, currentRecords);
                render();
            },
            async deleteMeal(e) {
                const mealId = parseInt(e.target.dataset.id);
                const currentRecords = state.records[state.currentDate];
                currentRecords.meals = currentRecords.meals.filter(m => m.id !== mealId);
                await dbService.saveRecords(state.currentDate, currentRecords);
                render();
                showToast('ì‹ë‹¨ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        };

        // --- 6. ë Œë”ë§ ë° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        const app = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');
        const toastContainer = document.getElementById('toast-container');

        const render = () => {
            if (state.currentPage === 'loading') {
                app.innerHTML = LoadingSpinner();
                return;
            }
            if (state.currentPage === 'profileSetup') {
                app.innerHTML = ProfileSetupPage();
                return;
            }
            if (state.currentPage === 'dashboard') {
                app.innerHTML = AppShell(DashboardPage());
            }
        };

        const renderModal = (title, content, actions = '') => {
            modalContainer.innerHTML = Modal(title, content, actions);
            setTimeout(() => {
                const modal = modalContainer.querySelector('.modal');
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        };
        const closeModal = () => {
            const modal = modalContainer.querySelector('.modal');
            if (modal) {
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modalContainer.innerHTML = '', 300);
            }
        };

        const showToast = (message, type = 'success') => {
            const colors = { success: 'bg-orange-500', error: 'bg-red-500', info: 'bg-sky-500' };
            const toast = document.createElement('div');
            toast.className = `toast text-white px-6 py-3 rounded-full shadow-lg opacity-0 transform translate-y-2 ${colors[type]}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.remove('opacity-0', 'translate-y-2'), 10);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };

        // --- 7. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        document.addEventListener('submit', (e) => {
            const action = e.target.dataset.action;
            if (action && actions[action]) {
                actions[action](e);
            }
        });

        document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (target) {
                const action = target.dataset.action;
                if(action === 'close-modal') closeModal();
                else if (actions[action]) actions[action](e);
            }
        });
        
        // --- 8. ì•± ì‹œì‘ ---
        const loadDataForDate = async (dateStr) => {
            const records = await dbService.getRecords(dateStr);
            state.records[dateStr] = records;
        };

        const main = async () => {
            render(); 
            const profile = await dbService.getProfile();
            if (profile) {
                state.userProfile = profile;
                state.currentPage = 'dashboard';
                await loadDataForDate(state.currentDate);
            } else {
                state.currentPage = 'profileSetup';
            }
            render();
        };

        main();
    </script>
</body>
</html>
