<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>피트밀 - 나만의 AI 영양사</title>
    <meta name="google-adsense-account" content="ca-pub-8389343171492169">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8389343171492169"
     crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0fdf4;
        }
        .font-jua {
            font-family: 'Jua', sans-serif;
        }
        .meal-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .meal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(34, 197, 94, 0.15);
        }
        .nutrient-ring {
            --size: 80px;
            --thickness: 8px;
            width: var(--size);
            height: var(--size);
            position: relative;
            display: inline-grid;
            place-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .nutrient-ring::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: conic-gradient(var(--color, #22c55e) calc(var(--p, 0) * 1%), #dcfce7 0);
            border-radius: 50%;
            mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            -webkit-mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            transition: background 0.5s ease-in-out;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .custom-shadow {
            box-shadow: 0 4px 12px 0 rgba(34, 197, 94, 0.1);
        }
        .dashed-border {
             background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%23bbf7d0' stroke-width='3' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .calendar-day {
            transition: background-color 0.2s ease-in-out;
        }
        .premium-crown {
            filter: drop-shadow(0 2px 4px rgba(252, 211, 77, 0.6));
        }
        .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.1em; font-weight: 600; }
        .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="text-slate-700">

    <div id="app-root">
        </div>

    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">내 정보 수정</h2>
            <form id="profile-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4"><div><label for="gender" class="block text-sm font-medium text-slate-600">성별</label><select id="gender" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="female">여성</option><option value="male">남성</option><option value="unspecified">선택 안함</option></select></div><div><label for="age" class="block text-sm font-medium text-slate-600">나이</label><input type="number" id="age" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="세"></div></div><div class="grid grid-cols-2 gap-4"><div><label for="height" class="block text-sm font-medium text-slate-600">신장</label><input type="number" id="height" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="cm"></div><div><label for="weight" class="block text-sm font-medium text-slate-600">체중</label><input type="number" id="weight" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="kg"></div></div><div><label for="activity" class="block text-sm font-medium text-slate-600">활동량</label><select id="activity" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="1.2">거의 없음</option><option value="1.375">가벼운 활동</option><option value="1.55">보통 활동</option><option value="1.725">높은 활동</option><option value="1.9">매우 높은 활동</option></select></div><div><label for="goal" class="block text-sm font-medium text-slate-600">목표</label><select id="goal" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="loss">체중 감량</option><option value="maintain">체중 유지</option><option value="gain">체중 증가</option></select></div><div class="pt-4"><button type="submit" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition duration-300">저장하기</button></div>
            </form>
        </div>
    </div>
    
    <div id="add-food-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">음식 기록하기</h2>
            <form id="add-food-form" class="space-y-4">
                <label for="manual-photo-input" class="cursor-pointer">
                    <div id="manual-image-preview" class="w-full h-32 bg-green-50 rounded-2xl flex flex-col items-center justify-center text-green-400 dashed-border">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        <p class="mt-2 text-sm font-semibold">사진 첨부 (선택)</p>
                    </div>
                </label>
                <input type="file" id="manual-photo-input" accept="image/*" class="hidden">
                
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-2">
                        <label for="food-name" class="block text-sm font-medium text-slate-600">음식 이름</label>
                        <input type="text" id="food-name" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label for="food-weight" class="block text-sm font-medium text-slate-600">양 (g)</label>
                        <input type="number" id="food-weight" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required>
                    </div>
                </div>
                 <button type="button" id="calculate-nutrients-btn" class="w-full bg-green-100 text-green-600 py-2.5 rounded-lg text-sm font-semibold hover:bg-green-200">AI 영양소 자동 계산</button>
                
                <div id="nutrient-loader" class="hidden text-center py-2">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="food-calories" class="block text-sm font-medium text-slate-600">칼로리 (kcal)</label><input type="number" id="food-calories" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                    <div><label for="food-protein" class="block text-sm font-medium text-slate-600">단백질 (g)</label><input type="number" id="food-protein" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="food-carbs" class="block text-sm font-medium text-slate-600">탄수화물 (g)</label><input type="number" id="food-carbs" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                    <div><label for="food-fat" class="block text-sm font-medium text-slate-600">지방 (g)</label><input type="number" id="food-fat" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                </div>
                <div class="pt-4 flex space-x-3">
                    <button type="button" id="cancel-add-food" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">취소</button>
                    <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition duration-300">기록하기</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-exercise-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">운동 기록하기</h2>
            <form id="add-exercise-form" class="space-y-4">
                <div>
                    <label for="exercise-name" class="block text-sm font-medium text-slate-600">운동 이름</label>
                    <input type="text" id="exercise-name" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required placeholder="예: 달리기, 요가">
                </div>
                <div>
                    <label for="exercise-duration" class="block text-sm font-medium text-slate-600">운동 시간 (분)</label>
                    <input type="number" id="exercise-duration" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required>
                </div>
                <button type="button" id="calculate-exercise-calories-btn" class="w-full bg-teal-100 text-teal-600 py-2.5 rounded-lg text-sm font-semibold hover:bg-teal-200">AI 예상 소모 칼로리 계산</button>
                <div id="exercise-calorie-loader" class="hidden text-center py-2">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                </div>
                <div id="exercise-calorie-result" class="hidden text-center bg-green-50 p-3 rounded-lg">
                    <p class="text-slate-600">예상 소모 칼로리: <span id="calculated-calories" class="font-bold text-green-600">0</span> kcal</p>
                </div>
                <div class="pt-4 flex space-x-3">
                    <button type="button" id="cancel-add-exercise" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">취소</button>
                    <button type="submit" id="submit-exercise-btn" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition disabled:bg-green-300" disabled>기록하기</button>
                </div>
            </form>
        </div>
    </div>

    <div id="photo-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">AI 음식 분석</h2>
            <div id="photo-upload-view">
                <label for="photo-input" class="cursor-pointer">
                    <div id="image-preview" class="w-full h-48 bg-green-50 rounded-2xl flex flex-col items-center justify-center text-green-400 dashed-border">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="mt-2 font-semibold">사진을 여기에 올려주세요</p>
                    </div>
                </label>
                <input type="file" id="photo-input" accept="image/*" class="hidden">
                <button id="analyze-photo-button" class="mt-4 w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition duration-300 disabled:bg-green-300">
                    분석 시작하기
                </button>
            </div>
            <div id="photo-loading-view" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
                <p class="mt-4 text-slate-500">AI가 사진을 분석하고 있어요...</p>
            </div>
            <div id="photo-result-view" class="hidden">
            </div>
             <button type="button" id="cancel-photo-analysis" class="mt-4 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">취소</button>
        </div>
    </div>

    <div id="calendar-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 id="calendar-detail-title" class="text-2xl font-jua text-green-600 mb-6 text-center"></h2>
            <div id="calendar-detail-list" class="space-y-3 max-h-96 overflow-y-auto">
            </div>
            <button type="button" id="close-calendar-detail" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">닫기</button>
        </div>
    </div>
    
    <div id="premium-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300 text-center">
            <h2 class="text-2xl font-jua text-green-600 mb-4">💎 피트밀 프리미엄</h2>
            <p class="text-slate-600 mb-6">상세 리포트 기능은 프리미엄 구독자 전용입니다. 지금 구독하고 모든 기능을 제한 없이 이용해 보세요!</p>
            <button id="subscribe-now-btn" class="w-full bg-amber-400 text-amber-900 py-3 rounded-full font-semibold hover:bg-amber-500 transition duration-300">
                프리미엄 구독하기
            </button>
             <button type="button" id="close-premium-modal" class="mt-4 w-full text-slate-500 py-2 rounded-full font-semibold hover:bg-slate-100 transition duration-300">나중에 할게요</button>
        </div>
    </div>

    <div id="terms-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-2xl p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">이용약관</h2>
            <div class="prose prose-sm max-h-96 overflow-y-auto text-slate-600">
                <h3>제1조 (목적)</h3>
                <p>본 약관은 에프앤앤(이하 "회사")가 제공하는 피트밀 앱(이하 "서비스")의 이용과 관련하여, 회사와 이용자 간의 권리와 의무, 책임사항 등을 정함을 목적으로 합니다.</p>
                <h3>제2조 (정의)</h3>
                <p>"이용자"란 피트밀 앱에 접속하여 본 약관에 따라 회사가 제공하는 서비스를 이용하는 모든 분을 의미합니다.</p>
                <p>"프리미엄 서비스"는 서비스 내 유료 결제를 통해 이용할 수 있으며, 광고 제거, 캘린더 상 상세 리포트 열람 등의 기능을 포함합니다.</p>
                <p>"콘텐츠"란 피트밀에서 제공하는 AI 식단 추천, 영양 정보, 텍스트, 이미지 및 기타 자료를 포함합니다.</p>
                <h3>제3조 (약관의 게시 및 변경)</h3>
                <p>본 약관은 피트밀 앱 내 또는 연결된 화면을 통해 게시되며, 이용자는 언제든지 열람하실 수 있습니다. 회사는 관련 법령에 따라 약관을 개정할 수 있으며, 변경 시에는 사전 고지를 통해 안내드립니다.</p>
                <h3>제4조 (회원가입 및 계정관리)</h3>
                <p>이용자는 이메일/비밀번호 또는 SNS 계정을 통해 간편하게 회원가입을 하실 수 있습니다. 회원가입 시 제공한 정보는 사실에 기반해야 하며, 최신 상태로 유지해 주셔야 합니다. 회원은 앱 내 계정 설정 메뉴를 통해 언제든지 탈퇴를 요청하실 수 있습니다.</p>
                <h3>제5조 (서비스의 제공)</h3>
                <p>회사는 AI 영양 체크, AI 다이어트 기록 등 다양한 콘텐츠를 서비스 형태로 제공합니다. 서비스는 시스템 점검, 기술적 이슈 등으로 인해 일시적으로 중단될 수 있으며, 가능할 경우 사전에 공지드립니다.</p>
                <h3>제6조 (유료결제 및 프리미엄 서비스 이용)</h3>
                <p>이용자는 앱 내 결제 시스템을 통해 프리미엄 서비스를 이용하실 수 있습니다. 프리미엄 서비스는 월 단위로 결제되며, 결제 완료 시 결제 취소를 하더라도 1개월 간의 서비스는 지속되며 환불은 어렵습니다. 결제 및 환불은 각 마켓(Google Play, App Store 등)의 운영 정책을 따르며, 해당 마켓을 통해 진행됩니다.</p>
                <h3>제7조 (콘텐츠 및 정보의 한계)</h3>
                <p>피트밀 앱에서 제공되는 AI 식단 추천 및 영양 정보 콘텐츠는 인공지능(AI) 기술을 기반으로 자동 생성되는 정보입니다. 이러한 정보는 건강 관리를 위한 참고용으로 제공되는 것으로, 의학적 진단이나 법적 효력을 보장하는 해석은 아닙니다. AI는 이용자가 입력한 데이터를 기반으로 통계적 알고리즘에 따라 콘텐츠를 생성하므로, 실제 전문가의 진단과 다를 수 있습니다. 회사는 해당 콘텐츠에 따른 이용자의 해석이나 판단, 행동 결과에 대해 법적 책임을 지지 않습니다.</p>
                <h3>제8조 (이용자의 의무)</h3>
                <p>다른 사람의 정보를 무단으로 사용해서는 안 됩니다. 서비스 이용 중 법령에 위반되거나 부정한 목적의 행위는 금지됩니다. 시스템 장애를 유발할 수 있는 해킹, 자동화 도구 등의 사용은 허용되지 않습니다.</p>
                <h3>제9조 (권리의 귀속)</h3>
                <p>서비스 내에서 제공되는 모든 콘텐츠 및 자료의 저작권은 회사에 있으며, 이용자는 이를 사전 허가 없이 복제, 배포, 유통하실 수 없습니다.</p>
                <h3>제10조 (책임의 제한)</h3>
                <p>이용자의 단말기 환경, 네트워크 상태 등 외부 요인으로 인해 발생하는 서비스 이용의 어려움에 대해서는 회사가 직접적으로 책임지기 어렵습니다. 앱 내 제공되는 콘텐츠는 참고용 정보이며, 이에 따른 판단이나 행위의 결과에 대해서는 회사가 법적 책임을 지지 않습니다.</p>
                <h3>제11조 (분쟁 해결 및 준거법)</h3>
                <p>서비스 이용과 관련한 분쟁은 상호 협의를 통해 원만히 해결하며, 필요 시 대한민국 관련 법령에 따라 처리되고, 관할 법원은 민사소송법에 따릅니다.</p>
                <hr>
                <p><strong>부칙</strong><br>이 약관은 2025년 8월 27일부터 시행됩니다.</p>
            </div>
            <button type="button" id="close-terms-modal" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">닫기</button>
        </div>
    </div>

    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-2xl p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">개인정보 처리방침</h2>
            <div class="prose prose-sm max-h-96 overflow-y-auto text-slate-600">
                <h3>1. 수집하는 개인정보 항목</h3>
                <p>회사는 회원가입 및 서비스 제공을 위해 아래와 같은 개인정보를 수집합니다.<br>
                - 회원가입 시: 이메일 주소, 비밀번호<br>
                - SNS 로그인 시: 닉네임, 이메일 등 SNS 제공 정보<br>
                - 프로필 설정 시 (선택): 성별, 나이, 키, 체중, 활동량, 목표<br>
                - 서비스 이용 시 자동 수집: 기기 정보, IP 주소, 접속 기록, 쿠키 등<br>
                - 유료 서비스 이용 시: 결제 기록 (결제 수단 정보는 수집하지 않음)</p>
                <h3>2. 개인정보의 이용 목적</h3>
                <p>회사는 수집한 개인정보를 다음의 목적을 위해 활용합니다.<br>
                - 회원 식별 및 본인 확인<br>
                - AI 기반 맞춤형 식단 및 운동 추천 서비스 제공<br>
                - 유료 서비스 제공 및 결제 처리<br>
                - 고객 문의 응대 및 민원 처리<br>
                - 서비스 안정성 확보 및 부정 이용 방지</p>
                <h3>3. 개인정보 보유 및 이용 기간</h3>
                <p>개인정보는 목적 달성 후 지체 없이 파기하며, 관계 법령에 따라 일정 기간 보존될 수 있습니다.<br>
                - 계약 및 결제 기록: 5년 (전자상거래법)<br>
                - 소비자 불만 및 분쟁 처리 기록: 3년 (전자상거래법)<br>
                - 접속 기록: 3개월 (통신비밀보호법)</p>
                <h3>4. 개인정보의 제3자 제공 및 처리 위탁</h3>
                <p>회사는 원칙적으로 이용자의 개인정보를 외부에 제공하지 않으며, 결제 처리 및 서비스 안정성 확보를 위해 다음과 같이 개인정보 처리를 위탁할 수 있습니다.<br>
                - 수탁업체: Google (Firebase, Google Play), Apple (App Store)<br>
                - 위탁업무: 회원인증, 데이터 저장 및 분석, 인앱 결제 처리</p>
                <h3>5. 이용자의 권리</h3>
                <p>이용자는 언제든지 등록되어 있는 자신의 개인정보를 조회하거나 수정할 수 있으며 가입해지를 요청할 수도 있습니다. 앱 내 ‘프로필’ 메뉴 또는 고객센터를 통해 요청 가능합니다.</p>
                <h3>6. 개인정보 보호책임자</h3>
                <p>성명: 황규찬<br>
                소속/직책: 에프앤앤 / 대표<br>
                이메일: wgchan247@gmail.com<br>
                전화번호: 010-9567-6114</p>
                <hr>
                <p><strong>공고일자:</strong> 2025년 8월 25일<br>
                <strong>시행일자:</strong> 2025년 8월 27일</p>
            </div>
            <button type="button" id="close-privacy-modal" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">닫기</button>
        </div>
    </div>
    
    <div id="password-reset-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-sm p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">비밀번호 재설정</h2>
            <p class="text-center text-slate-600 mb-4">가입하신 이메일 주소를 입력하시면, 비밀번호를 재설정할 수 있는 링크를 보내드립니다.</p>
            <form id="password-reset-form">
                <div>
                    <label for="reset-email" class="block text-sm font-medium text-slate-600">이메일</label>
                    <input type="email" id="reset-email" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required>
                </div>
                <div class="pt-4 flex flex-col gap-3">
                    <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition">재설정 이메일 받기</button>
                    <button type="button" id="cancel-reset-password" class="w-full text-slate-500 py-2 rounded-full font-semibold hover:bg-slate-100 transition">취소</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="withdraw-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300 text-center">
            <h2 class="text-2xl font-jua text-rose-600 mb-4">정말로 탈퇴하시겠어요? 😢</h2>
            <p class="text-slate-600 mb-6">지금 탈퇴하시면 모든 식단 기록, 운동 기록, 결제 내역이 영구적으로 삭제되며 다시는 복구할 수 없어요! 프리미엄 구독 중인 경우, 남은 기간은 환불되지 않습니다.</p>
            <div>
                <label for="withdraw-confirm-text" class="block text-sm font-medium text-slate-600 mb-2">탈퇴하시려면 아래에 "탈퇴하겠습니다"를 입력해주세요.</label>
                <input type="text" id="withdraw-confirm-text" class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-rose-500 focus:ring-rose-500">
            </div>
            <div class="pt-4 flex space-x-3">
                <button type="button" id="cancel-withdraw" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition">계정 유지하기</button>
                <button type="button" id="confirm-withdraw-btn" class="w-full bg-red-500 text-white py-3 rounded-full font-semibold hover:bg-red-600 transition disabled:bg-red-300" disabled>
                    탈퇴하기
                </button>
            </div>
        </div>
    </div>


    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 transform translate-y-2 transition-all duration-300 font-semibold">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        // Firebase SDK 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, sendPasswordResetEmail, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, collection, query, where, getDocs, documentId, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCRax6rd1rlBIc3kVgg5OkHmSIQyzJmC8A",
            authDomain: "fitmeal-app-d1a97.firebaseapp.com",
            projectId: "fitmeal-app-d1a97",
            storageBucket: "fitmeal-app-d1a97.appspot.com",
            messagingSenderId: "968711774677",
            appId: "1:968711774677:web:b3d3cb9ccc2388c3ba5d5c"
        };
        const appId = firebaseConfig.appId || 'default-diet-app';

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        // Firebase Functions 참조
        const callGeminiAPI_server = httpsCallable(functions, 'callGeminiAPI');
        const callGeminiVisionAPI_server = httpsCallable(functions, 'callGeminiVisionAPI');

        // 상태 관리
        let userProfile = null;
        let userId = null;
        let dailyIntake = [];
        let dailyExercise = [];
        let selectedImageBase64 = null;
        let manualImageBase64 = null;
        let currentDate = new Date();
        let isPremium = false; // 프리미엄 상태 변수
        let calorieChartInstance = null;
        let macroChartInstance = null;
        let currentPage = 'loading'; // 'loading', 'auth', 'profileSetup', 'main'

        const appRoot = document.getElementById('app-root');

        const calendarIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>`;
        const homeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>`;
        
        // --- 페이지 템플릿 ---
        const AuthPage = () => `
            <div id="auth-view-content" class="fixed inset-0 bg-green-50 flex items-center justify-center z-50 p-4">
                <div class="w-full max-w-sm p-8 bg-white rounded-3xl shadow-xl">
                    <div class="flex justify-center mb-4">
                        <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center shadow-lg shadow-green-200">
                             <svg class="w-10 h-10 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 20V5C9 4.44772 8.55228 4 8 4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                                <circle cx="12" cy="10" r="1.5" fill="currentColor"/>
                                <path d="M15 20V10" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                                <path d="M18 20V10" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    <h1 class="text-4xl font-jua text-green-600 text-center">피트밀</h1>
                    <p class="text-slate-500 text-center mb-8">나만의 AI 영양사, 피트밀</p>
                    <form id="login-form" class="space-y-4">
                        <div><label for="email" class="block text-sm font-medium text-slate-600">이메일</label><input type="email" id="email" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                        <div><label for="password" class="block text-sm font-medium text-slate-600">비밀번호</label><input type="password" id="password" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                        <div class="text-right text-sm"><a href="#" id="forgot-password-link" class="font-medium text-green-600 hover:text-green-500">비밀번호를 잊으셨나요?</a></div>
                        <div class="flex gap-3 pt-2"><button type="submit" id="login-btn" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition">로그인</button><button type="button" id="go-to-register-btn" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition">회원가입</button></div>
                    </form>
                    <form id="register-form" class="hidden space-y-4">
                        <div><label for="register-email" class="block text-sm font-medium text-slate-600">이메일</label><input type="email" id="register-email" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                        <div><label for="register-password" class="block text-sm font-medium text-slate-600">비밀번호</label><input type="password" id="register-password" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required><p class="mt-1 text-xs text-slate-500">8자리 이상 영문 소문자, 숫자를 조합해주세요.</p></div>
                        <div><label for="confirm-password" class="block text-sm font-medium text-slate-600">비밀번호 확인</label><input type="password" id="confirm-password" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                        <p id="password-error" class="hidden text-xs text-red-500">비밀번호가 일치하지 않거나 형식이 올바르지 않습니다.</p>
                        <div class="flex gap-3 pt-2"><button type="submit" id="register-btn" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition">회원가입</button></div>
                        <button type="button" id="back-to-login-btn" class="w-full text-slate-500 py-2 rounded-full text-sm font-semibold hover:bg-slate-100 transition">로그인으로 돌아가기</button>
                    </form>
                    <div class="relative my-6"><div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-300"></div></div><div class="relative flex justify-center text-sm"><span class="bg-white px-2 text-slate-500">또는</span></div></div>
                    <button id="google-login-btn" class="w-full bg-white border border-slate-300 text-slate-700 py-3 rounded-full font-semibold hover:bg-slate-50 transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 36.49 44 30.861 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        Google 계정으로 로그인
                    </button>
                    <div class="mt-6 text-center text-xs text-slate-400"><a href="#" id="terms-link" class="underline hover:text-slate-600">이용약관</a><span class="mx-2">|</span><a href="#" id="privacy-link" class="underline hover:text-slate-600">개인정보 처리방침</a></div>
                </div>
            </div>
        `;
        
        const ProfileSetupPage = () => `
            <div class="fixed inset-0 bg-green-50 flex items-center justify-center z-40 p-4">
                 <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8">
                    <h2 class="text-2xl font-jua text-green-600 mb-2 text-center">피트밀에 오신 것을 환영합니다!</h2>
                    <p class="text-slate-600 mb-6 text-center">정확한 AI 추천을 위해 프로필을 설정해주세요.</p>
                    <form id="profile-setup-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4"><div><label for="gender-setup" class="block text-sm font-medium text-slate-600">성별</label><select id="gender-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="female">여성</option><option value="male">남성</option><option value="unspecified">선택 안함</option></select></div><div><label for="age-setup" class="block text-sm font-medium text-slate-600">나이</label><input type="number" id="age-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="세" required></div></div><div class="grid grid-cols-2 gap-4"><div><label for="height-setup" class="block text-sm font-medium text-slate-600">신장</label><input type="number" id="height-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="cm" required></div><div><label for="weight-setup" class="block text-sm font-medium text-slate-600">체중</label><input type="number" id="weight-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="kg" required></div></div><div><label for="activity-setup" class="block text-sm font-medium text-slate-600">활동량</label><select id="activity-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="1.2">거의 없음</option><option value="1.375">가벼운 활동</option><option value="1.55">보통 활동</option><option value="1.725">높은 활동</option><option value="1.9">매우 높은 활동</option></select></div><div><label for="goal-setup" class="block text-sm font-medium text-slate-600">목표</label><select id="goal-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="loss">체중 감량</option><option value="maintain">체중 유지</option><option value="gain">체중 증가</option></select></div><div class="pt-4"><button type="submit" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition duration-300">시작하기</button></div>
                    </form>
                </div>
            </div>
        `;

        const MainAppPage = () => `
            <div id="app-view-content" class="max-w-4xl mx-auto p-4 md:p-6">
                <header class="flex justify-between items-center mb-8">
                    <h1 class="text-4xl font-jua text-green-600">피트밀 🥗</h1>
                    <div class="flex items-center gap-4">
                        <button id="stats-toggle-button" class="text-gray-400 hover:text-green-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg></button>
                        <button id="calendar-toggle-button" class="text-gray-400 hover:text-green-500">${calendarIconSVG}</button>
                        <button id="profile-button" class="text-gray-400 hover:text-green-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" /></svg></button>
                        <button id="logout-button" class="text-gray-400 hover:text-green-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg></button>
                    </div>
                </header>
                <main id="dashboard-view" class="space-y-8">
                    <section id="nutrition-progress" class="bg-white p-6 rounded-3xl custom-shadow">
                        <h2 class="text-xl font-jua text-green-600 mb-4">오늘의 영양 체크 📊</h2>
                        <div id="progress-content" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="flex flex-col items-center"><div id="calories-ring" class="nutrient-ring" style="--color: #f97316; --p: 0;"><span id="calories-current">0</span><small class="text-slate-400">/ <span id="calories-goal">0</span></small></div><p class="mt-2 font-semibold">칼로리 (kcal)</p></div><div class="flex flex-col items-center"><div id="carbs-ring" class="nutrient-ring" style="--color: #14b8a6; --p: 0;"><span id="carbs-current">0</span><small class="text-slate-400">/ <span id="carbs-goal">0</span></small></div><p class="mt-2 font-semibold">탄수화물 (g)</p></div><div class="flex flex-col items-center"><div id="protein-ring" class="nutrient-ring" style="--color: #f59e0b; --p: 0;"><span id="protein-current">0</span><small class="text-slate-400">/ <span id="protein-goal">0</span></small></div><p class="mt-2 font-semibold">단백질 (g)</p></div><div class="flex flex-col items-center"><div id="fat-ring" class="nutrient-ring" style="--color: #8b5cf6; --p: 0;"><span id="fat-current">0</span><small class="text-slate-400">/ <span id="fat-goal">0</span></small></div><p class="mt-2 font-semibold">지방 (g)</p></div>
                        </div>
                    </section>
                    <section id="daily-intake-log">
                        <h2 class="text-xl font-jua text-green-600 mb-4">오늘의 다이어트 기록 📝</h2>
                        <div id="daily-intake-list" class="space-y-3 mb-4"></div>
                        <div class="grid grid-cols-2 gap-3"><button id="add-food-button" class="w-full bg-white border-2 border-dashed border-green-200 text-green-500 py-3 rounded-2xl font-semibold hover:bg-green-50 hover:border-green-400 transition duration-300">+ 직접 입력</button><button id="add-photo-button" class="w-full bg-green-500 text-white py-3 rounded-2xl font-semibold hover:bg-green-600 transition duration-300 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>AI 카메라로 기록</button></div>
                    </section>
                    <section id="daily-exercise-log">
                        <h2 class="text-xl font-jua text-green-600 mb-4">오늘 운동 기록 🏋️‍♀️</h2>
                        <div id="daily-exercise-list" class="space-y-3 mb-4"></div>
                        <button id="add-exercise-button" class="w-full bg-white border-2 border-dashed border-teal-200 text-teal-500 py-3 rounded-2xl font-semibold hover:bg-teal-50 hover:border-teal-400 transition duration-300">+ 운동 추가하기</button>
                    </section>
                    <section id="meal-plan">
                        <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-jua text-green-600">AI 추천 식단 ✨</h2><button id="generate-plan-button" class="bg-green-500 text-white px-5 py-2 rounded-full font-semibold hover:bg-green-600 transition duration-300 disabled:bg-green-300 shadow-sm shadow-green-200">새 식단 받기</button></div>
                        <div id="meal-plan-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        <div id="loader" class="hidden text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div><p class="mt-4 text-slate-500">AI가 맞춤 식단을 생성 중입니다...</p></div>
                    </section>
                    <section id="water-tracker" class="bg-white p-6 rounded-3xl custom-shadow">
                        <h2 class="text-xl font-jua text-green-600 mb-4">수분 섭취 💧</h2>
                        <div class="flex items-center justify-between">
                            <div><p class="text-3xl font-bold text-sky-500"><span id="water-intake">0</span> / <span id="water-goal">8</span> 잔</p><p class="text-slate-400 text-sm">2L 목표 (1잔 = 250ml)</p></div>
                            <div class="flex space-x-2"><button id="add-water-button" class="bg-sky-400 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl font-bold hover:bg-sky-500 transition shadow-sm shadow-sky-200">+</button><button id="remove-water-button" class="bg-slate-100 text-slate-500 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 transition">-</button></div>
                        </div>
                    </section>
                    <section id="ad-banner-container" class="mt-8 flex justify-center items-center h-24 bg-slate-100 rounded-2xl"><p class="text-slate-400 text-sm">광고가 표시될 공간입니다.</p></section>
                    <footer class="text-center pt-8"><button id="withdraw-footer-btn" class="text-xs text-slate-400 hover:text-red-500 hover:underline transition">회원 탈퇴</button></footer>
                </main>
                <section id="calendar-view" class="hidden space-y-4">
                    <div class="bg-white p-6 rounded-3xl custom-shadow">
                        <div class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="p-2 rounded-full hover:bg-green-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><h2 id="calendar-month-year" class="text-xl font-jua text-green-600"></h2><button id="next-month-btn" class="p-2 rounded-full hover:bg-green-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button></div>
                        <div class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-slate-500 mb-2"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                    </div>
                    <div id="premium-section" class="bg-white p-6 rounded-3xl custom-shadow text-center"><h2 class="text-xl font-jua text-green-600 mb-4">💎 피트밀 프리미엄</h2><p class="text-slate-600 mb-4">프리미엄으로 업그레이드하고 광고 없이 더 상세한 리포트를 받아보세요!</p><button id="report-btn" class="w-full bg-amber-400 text-amber-900 py-3 rounded-full font-semibold hover:bg-amber-500 transition duration-300 flex items-center justify-center gap-2"><span class="premium-crown">👑</span> 상세 리포트 보기</button></div>
                </section>
                <section id="stats-view" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-3xl custom-shadow"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-jua text-green-600">통계 리포트</h2><div class="flex rounded-full bg-slate-100 p-1 text-sm font-semibold"><button id="weekly-report-btn" class="px-4 py-1 rounded-full bg-white text-green-600 shadow">주간</button><button id="monthly-report-btn" class="px-4 py-1 rounded-full text-slate-500">월간</button></div></div></div>
                    <div class="bg-white p-6 rounded-3xl custom-shadow"><h3 id="calorie-chart-title" class="text-lg font-jua text-green-600 mb-4">주간 칼로리 섭취량</h3><div class="chart-container"><canvas id="calorie-chart"></canvas></div></div>
                    <div class="grid md:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-3xl custom-shadow"><h3 id="macro-chart-title" class="text-lg font-jua text-green-600 mb-4">주간 영양소 비율</h3><div class="chart-container" style="height: 300px; max-width: 300px; margin: auto;"><canvas id="macro-chart"></canvas></div></div><div class="bg-white p-6 rounded-3xl custom-shadow"><h3 id="top-foods-title" class="text-lg font-jua text-green-600 mb-4">자주 먹은 음식 TOP 5</h3><div id="top-foods-list" class="space-y-2"></div></div></div>
                    <div class="bg-white p-6 rounded-3xl custom-shadow"><h3 id="average-intake-title" class="text-lg font-jua text-green-600 mb-4">일일 평균 섭취량</h3><div id="average-intake-content" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"></div></div>
                </section>
            </div>
        `;

        // --- 모달들 ---
        const passwordResetModal = document.getElementById('password-reset-modal');
        const withdrawModal = document.getElementById('withdraw-modal');
        const termsModal = document.getElementById('terms-modal');
        const privacyModal = document.getElementById('privacy-modal');
        const premiumModal = document.getElementById('premium-modal');
        const calendarDetailModal = document.getElementById('calendar-detail-modal');
        const photoAnalysisModal = document.getElementById('photo-analysis-modal');
        const addExerciseModal = document.getElementById('add-exercise-modal');
        const addFoodModal = document.getElementById('add-food-modal');
        const profileModal = document.getElementById('profile-modal');

        // --- 페이지 렌더링 및 상태 관리 ---
        function renderApp(page) {
            currentPage = page;
            appRoot.innerHTML = ''; // 이전 페이지 내용 삭제

            switch (page) {
                case 'auth':
                    appRoot.innerHTML = AuthPage();
                    attachAuthListeners();
                    break;
                case 'profileSetup':
                    appRoot.innerHTML = ProfileSetupPage();
                    attachProfileSetupListeners();
                    break;
                case 'main':
                    appRoot.innerHTML = MainAppPage();
                    attachMainAppListeners();
                    // 메인 앱이 렌더링된 후, 필요한 데이터를 불러옵니다.
                    loadInitialData();
                    break;
                default:
                    appRoot.innerHTML = `<div class="text-center p-8">로딩 중...</div>`;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                const docSnap = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/profile`)));
                if (docSnap.empty) {
                    renderApp('profileSetup');
                } else {
                    renderApp('main');
                }
            } else {
                userId = null;
                userProfile = null;
                renderApp('auth');
            }
        });

        // --- 이벤트 리스너 부착 함수들 ---
        function attachAuthListeners() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const goToRegisterBtn = document.getElementById('go-to-register-btn');
            const backToLoginBtn = document.getElementById('back-to-login-btn');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const termsLink = document.getElementById('terms-link');
            const privacyLink = document.getElementById('privacy-link');
            const passwordResetForm = document.getElementById('password-reset-form');
            const cancelResetPasswordBtn = document.getElementById('cancel-reset-password');

            // 회원가입/로그인 폼 전환
            goToRegisterBtn.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            });
            backToLoginBtn.addEventListener('click', () => {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });

            // 로그인
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showToast('로그인 성공!');
                } catch (error) {
                    showToast(`로그인 실패: ${error.message}`);
                }
            });

            // 회원가입
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const passwordError = document.getElementById('password-error');
                
                const passwordRegex = /^(?=.*[a-z])(?=.*\d)[a-z\d]{8,}$/;

                if (password !== confirmPassword) {
                    passwordError.textContent = '비밀번호가 일치하지 않습니다.';
                    passwordError.classList.remove('hidden');
                    return;
                }
                if (!passwordRegex.test(password)) {
                    passwordError.textContent = '비밀번호는 8자리 이상 영문 소문자와 숫자를 조합해야 합니다.';
                    passwordError.classList.remove('hidden');
                    return;
                }
                passwordError.classList.add('hidden');

                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showToast('회원가입 성공! 프로필을 설정해주세요.');
                } catch (error) {
                    showToast(`회원가입 실패: ${error.message}`);
                }
            });
            
            // 구글 로그인
            googleLoginBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    showToast('Google 로그인 성공!');
                } catch (error) {
                    showToast(`Google 로그인 실패: ${error.message}`);
                }
            });

            // 비밀번호 재설정
            forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); openModal(passwordResetModal); });
            passwordResetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('reset-email').value;
                try {
                    await sendPasswordResetEmail(auth, email);
                    showToast('비밀번호 재설정 이메일을 보냈습니다.');
                    closeModal(passwordResetModal);
                } catch (error) {
                    showToast(`이메일 전송 실패: ${error.message}`);
                }
            });
            cancelResetPasswordBtn.addEventListener('click', () => closeModal(passwordResetModal));
            
            // 약관
            termsLink.addEventListener('click', (e) => { e.preventDefault(); openModal(termsModal); });
            privacyLink.addEventListener('click', (e) => { e.preventDefault(); openModal(privacyModal); });
            document.getElementById('close-terms-modal').addEventListener('click', () => closeModal(termsModal));
            document.getElementById('close-privacy-modal').addEventListener('click', () => closeModal(privacyModal));
        }
        
        function attachProfileSetupListeners() {
            const profileSetupForm = document.getElementById('profile-setup-form');
            profileSetupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const profileData = {
                    gender: document.getElementById('gender-setup').value,
                    age: parseInt(document.getElementById('age-setup').value),
                    height: parseFloat(document.getElementById('height-setup').value),
                    weight: parseFloat(document.getElementById('weight-setup').value),
                    activity: parseFloat(document.getElementById('activity-setup').value),
                    goal: document.getElementById('goal-setup').value
                };

                if (Object.values(profileData).some(v => !v && v !== 0)) {
                    showToast('모든 항목을 입력해주세요.');
                    return;
                }
                
                const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                try {
                    await setDoc(userProfileRef, profileData);
                    showToast('프로필이 저장되었습니다. 앱을 시작합니다!');
                    renderApp('main');
                } catch (error) {
                    console.error("Error saving profile: ", error);
                    showToast('저장에 실패했습니다.');
                }
            });
        }
        
        function attachMainAppListeners() {
            // 헤더 버튼
            document.getElementById('logout-button').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showToast('로그아웃되었습니다.');
                } catch (error) {
                    showToast(`로그아웃 실패: ${error.message}`);
                }
            });
            document.getElementById('profile-button').addEventListener('click', openProfileModal);
            
            // 메인 기능 버튼
            document.getElementById('add-food-button').addEventListener('click', openAddFoodModal);
            document.getElementById('add-photo-button').addEventListener('click', openPhotoAnalysisModal);
            document.getElementById('add-exercise-button').addEventListener('click', () => openModal(addExerciseModal));
            document.getElementById('generate-plan-button').addEventListener('click', generateMealPlan);
            document.getElementById('withdraw-footer-btn').addEventListener('click', () => openModal(withdrawModal));

            // 네비게이션 (뷰 전환)
            const calendarToggleButton = document.getElementById('calendar-toggle-button');
            const statsToggleButton = document.getElementById('stats-toggle-button');
            const dashboardView = document.getElementById('dashboard-view');
            const calendarView = document.getElementById('calendar-view');
            const statsView = document.getElementById('stats-view');

            calendarToggleButton.addEventListener('click', () => {
                const isDashboardVisible = !dashboardView.classList.contains('hidden');
                dashboardView.classList.toggle('hidden');
                calendarView.classList.toggle('hidden');
                statsView.classList.add('hidden');
                if (isDashboardVisible) {
                    calendarToggleButton.innerHTML = homeIconSVG;
                    renderCalendar();
                } else {
                    calendarToggleButton.innerHTML = calendarIconSVG;
                }
            });

            statsToggleButton.addEventListener('click', () => {
                const isDashboardVisible = !dashboardView.classList.contains('hidden');
                dashboardView.classList.toggle('hidden');
                statsView.classList.toggle('hidden');
                calendarView.classList.add('hidden'); 
                 if (isDashboardVisible) {
                    statsToggleButton.innerHTML = homeIconSVG;
                    renderCharts(); 
                } else {
                    statsToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>`;
                }
            });

            // 모달 관련 리스너
            attachModalListeners();
        }

        function attachModalListeners() {
             // 공통 모달 닫기
            document.querySelectorAll('.modal-backdrop').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal);
                });
            });

            // 프로필 모달
            document.getElementById('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const profileData = { gender: document.getElementById('gender').value, age: parseInt(document.getElementById('age').value), height: parseFloat(document.getElementById('height').value), weight: parseFloat(document.getElementById('weight').value), activity: parseFloat(document.getElementById('activity').value), goal: document.getElementById('goal').value };
                if (Object.values(profileData).some(v => !v && v !== 0)) { showToast('모든 항목을 입력해주세요.'); return; }
                const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                try { await setDoc(userProfileRef, profileData); showToast('프로필이 저장되었습니다.'); closeModal(profileModal); } catch (error) { console.error("Error saving profile: ", error); showToast('저장에 실패했습니다.'); }
            });

            // 음식 추가 모달
            document.getElementById('add-food-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const foodName = document.getElementById('food-name').value;
                const foodWeight = document.getElementById('food-weight').value;
                const foodItem = { name: `${foodName} (${foodWeight}g)`, calories: parseInt(document.getElementById('food-calories').value), carbs: parseInt(document.getElementById('food-carbs').value), protein: parseInt(document.getElementById('food-protein').value), fat: parseInt(document.getElementById('food-fat').value), timestamp: Date.now(), photo: manualImageBase64 };
                if (Object.values(foodItem).some(v => (v !== null && v !== 0 && !v) || (typeof v === 'number' && isNaN(v)))) { showToast('모든 영양 정보를 올바르게 입력해주세요.'); return; }
                logFoodItem(foodItem);
                closeAddFoodModal();
            });
            document.getElementById('cancel-add-food').addEventListener('click', closeAddFoodModal);
            document.getElementById('manual-photo-input').addEventListener('change', (event) => handleImageSelection(event, document.getElementById('manual-image-preview'), (base64) => { manualImageBase64 = base64; }));
            document.getElementById('calculate-nutrients-btn').addEventListener('click', async () => {
                const foodName = document.getElementById('food-name').value;
                const foodWeight = document.getElementById('food-weight').value;
                if (!foodName || !foodWeight) { showToast('음식 이름과 양(g)을 모두 입력해주세요.'); return; }
                document.getElementById('nutrient-loader').classList.remove('hidden');
                try {
                    const resultText = await callGeminiNutritionAPI(`${foodName} ${foodWeight}g`);
                    const data = JSON.parse(resultText);
                    document.getElementById('food-calories').value = data.calories;
                    document.getElementById('food-carbs').value = data.carbs;
                    document.getElementById('food-protein').value = data.protein;
                    document.getElementById('food-fat').value = data.fat;
                } catch (error) { showToast('영양소 계산에 실패했어요.'); } finally { document.getElementById('nutrient-loader').classList.add('hidden'); }
            });

            // 운동 추가 모달
             const addExerciseForm = document.getElementById('add-exercise-form');
             addExerciseForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                 const exerciseItem = { name: document.getElementById('exercise-name').value, duration: parseInt(document.getElementById('exercise-duration').value), calories: parseInt(document.getElementById('calculated-calories').textContent), timestamp: Date.now() };
                 if (!exerciseItem.name || isNaN(exerciseItem.duration) || isNaN(exerciseItem.calories)) { showToast('모든 운동 정보를 올바르게 입력해주세요.'); return; }
                 logExerciseItem(exerciseItem);
                 closeModal(addExerciseModal);
                 addExerciseForm.reset();
                 document.getElementById('exercise-calorie-result').classList.add('hidden');
                 document.getElementById('submit-exercise-btn').disabled = true;
             });
             document.getElementById('cancel-add-exercise').addEventListener('click', () => closeModal(addExerciseModal));
             document.getElementById('calculate-exercise-calories-btn').addEventListener('click', async () => {
                 const exerciseName = document.getElementById('exercise-name').value;
                 const duration = document.getElementById('exercise-duration').value;
                 if (!exerciseName || !duration || !userProfile) { showToast('운동 이름, 시간, 프로필 정보를 모두 입력해주세요.'); return; }
                 document.getElementById('exercise-calorie-loader').classList.remove('hidden');
                 document.getElementById('exercise-calorie-result').classList.add('hidden');
                 try {
                     const prompt = `'${userProfile.weight}kg'인 사람이 '${exerciseName}' 운동을 '${duration}'분 했을 때 예상 소모 칼로리를 계산해서 JSON 형식으로 알려줘. 값은 정수로만 제공해야 해.`;
                     const schema = { type: "OBJECT", properties: { calories: { type: "NUMBER" } } };
                     const resultText = await callGeminiAPI(prompt, schema);
                     const data = JSON.parse(resultText);
                     document.getElementById('calculated-calories').textContent = data.calories;
                     document.getElementById('exercise-calorie-result').classList.remove('hidden');
                     document.getElementById('submit-exercise-btn').disabled = false;
                 } catch(e) { showToast('칼로리 계산에 실패했어요.'); } finally { document.getElementById('exercise-calorie-loader').classList.add('hidden'); }
             });

            // 사진 분석 모달
            document.getElementById('photo-input').addEventListener('change', (event) => handleImageSelection(event, document.getElementById('image-preview'), (base64) => { selectedImageBase64 = base64; document.getElementById('analyze-photo-button').disabled = false; }));
            document.getElementById('analyze-photo-button').addEventListener('click', async () => {
                if (!selectedImageBase64) { showToast('먼저 사진을 선택해주세요.'); return; }
                document.getElementById('photo-upload-view').classList.add('hidden');
                document.getElementById('photo-loading-view').classList.remove('hidden');
                try {
                    const resultText = await callGeminiVisionAPI(selectedImageBase64.split(',')[1]);
                    const resultData = JSON.parse(resultText);
                    renderPhotoAnalysisResult(resultData);
                    document.getElementById('photo-loading-view').classList.add('hidden');
                    document.getElementById('photo-result-view').classList.remove('hidden');
                } catch (error) {
                    showToast('사진 분석에 실패했어요.');
                    closePhotoAnalysisModal();
                }
            });
            document.getElementById('cancel-photo-analysis').addEventListener('click', closePhotoAnalysisModal);

            // 캘린더 상세 모달
            document.getElementById('close-calendar-detail').addEventListener('click', () => closeModal(calendarDetailModal));
            
             // 프리미엄 모달
            document.getElementById('close-premium-modal').addEventListener('click', () => closeModal(premiumModal));
            document.getElementById('subscribe-now-btn').addEventListener('click', async () => {
                const premiumRef = doc(db, `artifacts/${appId}/users/${userId}/premium`, 'status');
                try {
                    await setDoc(premiumRef, { active: true, subscribedAt: new Date() });
                    showToast('👑 프리미엄 구독이 시작되었습니다!');
                    closeModal(premiumModal);
                } catch (error) { showToast('구독 처리 중 오류가 발생했습니다.'); }
            });

             // 회원 탈퇴 모달
            document.getElementById('cancel-withdraw').addEventListener('click', () => closeModal(withdrawModal));
            document.getElementById('withdraw-confirm-text').addEventListener('input', (e) => {
                document.getElementById('confirm-withdraw-btn').disabled = e.target.value !== '탈퇴하겠습니다';
            });
            document.getElementById('confirm-withdraw-btn').addEventListener('click', async () => {
                try {
                    const user = auth.currentUser;
                    // Firestore 데이터 삭제 (Batch)
                    const batch = writeBatch(db);
                    const intakeRef = collection(db, `artifacts/${appId}/users/${userId}/dailyIntake`);
                    const exerciseRef = collection(db, `artifacts/${appId}/users/${userId}/dailyExercise`);
                    const waterRef = collection(db, `artifacts/${appId}/users/${userId}/water`);
                    const mealPlanRef = collection(db, `artifacts/${appId}/users/${userId}/mealPlans`);
                    const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);

                    // Batch에 삭제 작업 추가 (예시: 프로필만)
                    batch.delete(profileRef); // 실제로는 모든 컬렉션 문서를 삭제해야 함
                    
                    await batch.commit();
                    await deleteUser(user);
                    showToast('회원 탈퇴가 완료되었습니다.');
                    closeModal(withdrawModal);
                } catch (error) {
                    showToast(`탈퇴 처리 중 오류 발생: ${error.message}`);
                    console.error("Withdrawal error: ", error);
                }
            });
        }


        // --- 초기 데이터 로딩 함수 ---
        function loadInitialData() {
             const today = new Date().toISOString().slice(0, 10);
            
            // 프리미엄 상태
             const premiumRef = doc(db, `artifacts/${appId}/users/${userId}/premium`, 'status');
             onSnapshot(premiumRef, (docSnap) => {
                 isPremium = docSnap.exists() && docSnap.data().active === true;
                 updatePremiumUI();
             });

            // 프로필
            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
            onSnapshot(userProfileRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    updateNutritionGoalsUI(userProfile);
                    updateNutritionProgressUI(dailyIntake, userProfile.nutritionGoals); 
                }
            });

            // 식단 기록
            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, today);
            onSnapshot(dailyIntakeRef, (docSnap) => {
                dailyIntake = docSnap.exists() ? docSnap.data().foods : [];
                renderDailyIntake(dailyIntake);
                if (userProfile && userProfile.nutritionGoals) {
                    updateNutritionProgressUI(dailyIntake, userProfile.nutritionGoals);
                }
            });

             // 운동 기록
             const dailyExerciseRef = doc(db, `artifacts/${appId}/users/${userId}/dailyExercise`, today);
             onSnapshot(dailyExerciseRef, (docSnap) => {
                 dailyExercise = docSnap.exists() ? docSnap.data().exercises : [];
                 renderDailyExercise(dailyExercise);
             });

             // AI 추천 식단
             const mealPlanRef = doc(db, `artifacts/${appId}/users/${userId}/mealPlans`, today);
             onSnapshot(mealPlanRef, (docSnap) => {
                 const mealPlanContent = document.getElementById('meal-plan-content');
                 if (docSnap.exists()) { renderMealPlan(docSnap.data().plan); } 
                 else { mealPlanContent.innerHTML = '<p class="text-center text-slate-500 md:col-span-2 py-4">오늘의 추천 식단을 받아보세요.</p>'; }
             });
             
             // 물 섭취
             const waterRef = doc(db, `artifacts/${appId}/users/${userId}/water`, today);
             onSnapshot(waterRef, (docSnap) => {
                 updateWaterUI(docSnap.exists() ? docSnap.data().count : 0);
             });
        }
        
        // --- 나머지 함수들은 여기에 위치합니다 (renderMealPlan, logFoodItem 등) ---
        
        function updatePremiumUI() {
             const adBanner = document.getElementById('ad-banner-container');
             if(adBanner) adBanner.classList.toggle('hidden', isPremium);
        }

        function updateNutritionGoalsUI(profile) {
            if (!profile || !profile.weight || !profile.height || !profile.age) return;
            let bmr;
            if (profile.gender === 'male') { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) + 5; } 
            else if (profile.gender === 'female') { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) - 161; } 
            else { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) - 78; }
            
            const tdee = bmr * profile.activity;
            let finalCalories = tdee;
            if (profile.goal === 'loss') finalCalories -= 500;
            if (profile.goal === 'gain') finalCalories += 300;
            
            userProfile.nutritionGoals = { 
                calories: Math.round(finalCalories), 
                carbs: Math.round((finalCalories * 0.45) / 4), 
                protein: Math.round((finalCalories * 0.30) / 4), 
                fat: Math.round((finalCalories * 0.25) / 9) 
            };
            
            document.getElementById('calories-goal').textContent = userProfile.nutritionGoals.calories;
            document.getElementById('carbs-goal').textContent = userProfile.nutritionGoals.carbs;
            document.getElementById('protein-goal').textContent = userProfile.nutritionGoals.protein;
            document.getElementById('fat-goal').textContent = userProfile.nutritionGoals.fat;
        }

        function updateNutritionProgressUI(intake, goals) {
            if (!goals) return;
            const totals = intake.reduce((acc, food) => ({ 
                calories: acc.calories + (food.calories || 0), 
                carbs: acc.carbs + (food.carbs || 0), 
                protein: acc.protein + (food.protein || 0), 
                fat: acc.fat + (food.fat || 0) 
            }), { calories: 0, carbs: 0, protein: 0, fat: 0 });

            const updateRing = (type, current, goal) => {
                const currentEl = document.getElementById(`${type}-current`);
                const ringEl = document.getElementById(`${type}-ring`);
                if(currentEl && ringEl) {
                    currentEl.textContent = Math.round(current);
                    const percentage = goal > 0 ? Math.min(Math.round((current / goal) * 100), 100) : 0;
                    ringEl.style.setProperty('--p', percentage);
                }
            };
            
            updateRing('calories', totals.calories, goals.calories); 
            updateRing('carbs', totals.carbs, goals.carbs); 
            updateRing('protein', totals.protein, goals.protein); 
            updateRing('fat', totals.fat, goals.fat);
        }

        function renderMealPlan(plan) {
            const mealPlanContent = document.getElementById('meal-plan-content');
            mealPlanContent.innerHTML = '';
            const mealTypes = { breakfast: '아침', lunch: '점심', dinner: '저녁', snack: '간식' };
            const orderedMealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];

            orderedMealTypes.forEach(mealType => {
                if (plan[mealType] && plan[mealType].name) {
                    const meal = plan[mealType];
                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-2xl custom-shadow meal-card';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-jua text-green-500">${mealTypes[mealType]}</h3>
                                <p class="text-xl font-semibold my-2 text-slate-800">${meal.name}</p>
                            </div>
                            <button class="log-ai-meal-btn bg-green-100 text-green-600 w-10 h-10 rounded-full text-xl font-semibold hover:bg-green-200 flex items-center justify-center">+</button>
                        </div>
                        <div class="flex justify-between text-sm text-slate-500 border-t border-slate-100 pt-3 mt-3">
                            <span>🔥 ${meal.calories} kcal</span>
                            <span>🍞 ${meal.carbs}g</span>
                            <span>🍗 ${meal.protein}g</span>
                            <span>🥑 ${meal.fat}g</span>
                        </div>`;
                    card.querySelector('.log-ai-meal-btn').addEventListener('click', () => logFoodItem({ name: `(AI) ${meal.name}`, ...meal, timestamp: Date.now() }));
                    mealPlanContent.appendChild(card);
                }
            });
        }

        function renderDailyIntake(foods) {
            const dailyIntakeList = document.getElementById('daily-intake-list');
            dailyIntakeList.innerHTML = '';
            if (foods.length === 0) { dailyIntakeList.innerHTML = '<p class="text-center text-slate-400 py-4">아직 기록된 음식이 없습니다.</p>'; return; }
            foods.forEach((food) => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-2xl custom-shadow flex justify-between items-center';
                const imageHtml = food.photo ? `<img src="${food.photo}" class="w-12 h-12 rounded-lg object-cover mr-4">` : `<div class="w-12 h-12 rounded-lg bg-green-50 flex-shrink-0 mr-4"></div>`;
                item.innerHTML = `
                    <div class="flex items-center flex-grow">
                        ${imageHtml}
                        <div class="flex-grow">
                            <p class="font-semibold text-slate-800">${food.name}</p>
                            <p class="text-sm text-slate-500">${food.calories}kcal | 탄 ${food.carbs}g, 단 ${food.protein}g, 지 ${food.fat}g</p>
                        </div>
                    </div>
                    <button class="remove-intake-btn text-rose-300 hover:text-rose-500 text-2xl font-bold flex-shrink-0 ml-2">&times;</button>
                `;
                item.querySelector('.remove-intake-btn').addEventListener('click', () => removeFoodItem(food));
                dailyIntakeList.appendChild(item);
            });
        }

        function renderDailyExercise(exercises) {
            const dailyExerciseList = document.getElementById('daily-exercise-list');
            dailyExerciseList.innerHTML = '';
            if (exercises.length === 0) { dailyExerciseList.innerHTML = '<p class="text-center text-slate-400 py-4">아직 기록된 운동이 없습니다.</p>'; return; }
            exercises.forEach((ex) => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-2xl custom-shadow flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-slate-800">${ex.name}</p>
                        <p class="text-sm text-slate-500">${ex.duration}분 | ${ex.calories}kcal 소모</p>
                    </div>
                    <button class="remove-exercise-btn text-rose-300 hover:text-rose-500 text-2xl font-bold">&times;</button>
                `;
                item.querySelector('.remove-exercise-btn').addEventListener('click', () => removeExerciseItem(ex));
                dailyExerciseList.appendChild(item);
            });
        }
        
        async function logFoodItem(foodItem) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, today);
            try { await updateDoc(dailyIntakeRef, { foods: arrayUnion(foodItem) }); showToast(`${foodItem.name} 기록 완료!`); } 
            catch (error) { 
                if (error.code === 'not-found') { await setDoc(dailyIntakeRef, { foods: [foodItem] }); showToast(`${foodItem.name} 기록 완료!`); } 
                else { showToast('기록에 실패했습니다.'); } 
            }
            renderCalendar();
        }
        
        async function removeFoodItem(foodToRemove) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, today);
            try { await updateDoc(dailyIntakeRef, { foods: arrayRemove(foodToRemove) }); showToast(`${foodToRemove.name} 삭제 완료!`); renderCalendar(); } 
            catch (error) { showToast('삭제에 실패했습니다.'); }
        }
        
        async function logExerciseItem(exerciseItem) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyExerciseRef = doc(db, `artifacts/${appId}/users/${userId}/dailyExercise`, today);
            try { await updateDoc(dailyExerciseRef, { exercises: arrayUnion(exerciseItem) }); showToast(`${exerciseItem.name} 운동 기록 완료!`); } 
            catch (error) {
                if (error.code === 'not-found') { await setDoc(dailyExerciseRef, { exercises: [exerciseItem] }); showToast(`${exerciseItem.name} 운동 기록 완료!`); } 
                else { showToast('운동 기록에 실패했습니다.'); }
            }
            renderCalendar();
        }

        async function removeExerciseItem(exerciseToRemove) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyExerciseRef = doc(db, `artifacts/${appId}/users/${userId}/dailyExercise`, today);
            try { await updateDoc(dailyExerciseRef, { exercises: arrayRemove(exerciseToRemove) }); showToast(`${exerciseToRemove.name} 운동 기록 삭제 완료!`); renderCalendar(); } 
            catch (error) { showToast('삭제에 실패했습니다.'); }
        }

        async function generateMealPlan() {
            if (!userProfile || !userProfile.nutritionGoals) { showToast('먼저 프로필을 저장해주세요.'); openProfileModal(); return; }
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('meal-plan-content').innerHTML = '';
            document.getElementById('generate-plan-button').disabled = true;
            const userInfoParts = [ `나이: ${userProfile.age}세`, userProfile.gender !== 'unspecified' ? `성별: ${userProfile.gender === 'male' ? '남성' : '여성'}` : '', `목표: ${userProfile.goal === 'loss' ? '체중 감량' : (userProfile.goal === 'gain' ? '체중 증가' : '체중 유지')}` ].filter(part => part).join(', ');
            const prompt = `당신은 전문 영양사입니다. 다음 사용자 정보와 영양 목표에 맞춰, 맛과 영양을 모두 고려한 한국식 위주의 하루 식단(아침, 점심, 저녁, 간식)을 추천해주세요. 사용자 정보: ${userInfoParts}. 일일 영양 목표: 칼로리 ${userProfile.nutritionGoals.calories}kcal, 탄수화물 ${userProfile.nutritionGoals.carbs}g, 단백질 ${userProfile.nutritionGoals.protein}g, 지방 ${userProfile.nutritionGoals.fat}g. 각 식사의 음식 이름과 예상 영양성분(칼로리,탄수화물,단백질,지방)을 계산하여 제공해주세요. 전체 식단의 영양소 총합이 목표치에 최대한 근접해야 합니다.`;
            try {
                const schema = { type: "OBJECT", properties: { breakfast: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, lunch: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, dinner: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, snack: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } } } };
                const responseText = await callGeminiAPI(prompt, schema);
                const plan = JSON.parse(responseText);
                const today = new Date().toISOString().slice(0, 10);
                const mealPlanRef = doc(db, `artifacts/${appId}/users/${userId}/mealPlans`, today);
                await setDoc(mealPlanRef, { plan: plan, createdAt: new Date() });
                showToast('AI 맞춤 식단이 생성되었습니다!');
            } catch (error) { showToast('식단 생성에 실패했습니다.'); } 
            finally { 
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('generate-plan-button').disabled = false;
            }
        }
        
        async function renderCalendar() {
            if (!userId) return;
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('calendar-month-year').textContent = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
            
            const mealQuery = query(collection(db, `artifacts/${appId}/users/${userId}/dailyIntake`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const mealSnapshot = await getDocs(mealQuery);
            const monthMealData = {};
            mealSnapshot.forEach(doc => { monthMealData[doc.id] = doc.data(); });

            const waterQuery = query(collection(db, `artifacts/${appId}/users/${userId}/water`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const waterSnapshot = await getDocs(waterQuery);
            const monthWaterData = {};
            waterSnapshot.forEach(doc => { monthWaterData[doc.id] = doc.data(); });
            
            const exerciseQuery = query(collection(db, `artifacts/${appId}/users/${userId}/dailyExercise`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const exerciseSnapshot = await getDocs(exerciseQuery);
            const monthExerciseData = {};
            exerciseSnapshot.forEach(doc => { monthExerciseData[doc.id] = doc.data(); });

            for (let i = 0; i < firstDay; i++) { calendarGrid.innerHTML += '<div></div>'; }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasMealData = monthMealData[dayStr] && monthMealData[dayStr].foods.length > 0;
                const hasWaterData = monthWaterData[dayStr] && monthWaterData[dayStr].count > 0;
                const hasExerciseData = monthExerciseData[dayStr] && monthExerciseData[dayStr].exercises.length > 0;
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                
                const dayCell = document.createElement('div');
                dayCell.className = 'h-16 flex flex-col items-center justify-center rounded-2xl calendar-day';
                
                let iconsHTML = '';
                if (hasMealData) iconsHTML += '<span class="text-xs">🍽️</span>';
                if (hasWaterData) iconsHTML += '<span class="text-xs">💧</span>';
                if (hasExerciseData) iconsHTML += '<span class="text-xs">🏋️‍♀️</span>';
                
                dayCell.innerHTML = `<span class="text-sm">${day}</span><div class="flex">${iconsHTML}</div>`;
                
                if (isToday) dayCell.classList.add('bg-green-100', 'font-bold', 'text-green-600');
                
                if (hasMealData || hasWaterData || hasExerciseData) {
                    dayCell.classList.add('cursor-pointer', 'hover:bg-green-50');
                    dayCell.addEventListener('click', () => openCalendarDetailModal(dayStr, monthMealData[dayStr]?.foods || [], monthWaterData[dayStr]?.count || 0, monthExerciseData[dayStr]?.exercises || []));
                }
                calendarGrid.appendChild(dayCell);
            }
        }

        function openCalendarDetailModal(dateStr, foods, waterCount, exercises) {
            document.getElementById('calendar-detail-title').textContent = `${dateStr} 기록`;
            const listEl = document.getElementById('calendar-detail-list');
            listEl.innerHTML = '';
            
            const waterItem = document.createElement('div');
            waterItem.className = 'bg-sky-50 p-4 rounded-2xl flex items-center';
            waterItem.innerHTML = `<span class="text-2xl mr-4">💧</span><div class="flex-grow"><p class="font-semibold text-sky-800">총 수분 섭취</p><p class="text-sm text-sky-600">${waterCount} 잔 (${waterCount * 250}ml)</p></div>`;
            listEl.appendChild(waterItem);

            const exerciseTitle = document.createElement('h3');
            exerciseTitle.className = 'text-lg font-jua text-green-600 mt-4 mb-2';
            exerciseTitle.textContent = '운동 기록';
            listEl.appendChild(exerciseTitle);

            if (exercises.length === 0) { listEl.innerHTML += '<p class="text-center text-slate-400 py-4">기록된 운동이 없습니다.</p>'; } 
            else { exercises.forEach(ex => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl custom-shadow flex items-center';
                    item.innerHTML = `<span class="text-2xl mr-4">🏋️‍♀️</span><div class="flex-grow"><p class="font-semibold text-slate-800">${ex.name}</p><p class="text-sm text-slate-500">${ex.duration}분 | ${ex.calories}kcal 소모</p></div>`;
                    listEl.appendChild(item);
                });
            }

            const foodTitle = document.createElement('h3');
            foodTitle.className = 'text-lg font-jua text-green-600 mt-4 mb-2';
            foodTitle.textContent = '식단 기록';
            listEl.appendChild(foodTitle);

            if (foods.length === 0) { listEl.innerHTML += '<p class="text-center text-slate-400 py-4">기록된 음식이 없습니다.</p>'; } 
            else { foods.forEach(food => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl custom-shadow flex items-center';
                    const imageHtml = food.photo ? `<img src="${food.photo}" class="w-12 h-12 rounded-lg object-cover mr-4">` : `<div class="w-12 h-12 rounded-lg bg-green-50 flex-shrink-0 mr-4"></div>`;
                    item.innerHTML = `${imageHtml}<div class="flex-grow"><p class="font-semibold text-slate-800">${food.name}</p><p class="text-sm text-slate-500">${food.calories}kcal | 탄 ${food.carbs}g, 단 ${food.protein}g, 지 ${food.fat}g</p></div>`;
                    listEl.appendChild(item);
                });
            }
            openModal(calendarDetailModal);
        }

        async function callGeminiAPI(prompt, schema) {
            try { const result = await callGeminiAPI_server({ prompt, schema }); return result.data.result; } 
            catch (error) { console.error("Firebase Function 호출 실패:", error); throw error; }
        }
        
        async function callGeminiNutritionAPI(foodString) {
            const prompt = `'${foodString}'의 예상 칼로리, 탄수화물, 단백질, 지방 함량을 계산해서 JSON 형식으로 알려줘. 값은 소수점 없이 정수로만 제공해야 해.`;
            const schema = { type: "OBJECT", properties: { calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } };
             try { const result = await callGeminiAPI_server({ prompt, schema }); return result.data.result; } 
             catch (error) { console.error("Firebase Function 호출 실패 (Nutrition):", error); throw error; }
        }
        
        async function callGeminiVisionAPI(base64ImageData) {
            const prompt = "이 음식 사진을 분석해서, 음식 이름, 예상 칼로리, 탄수화물, 단백질, 지방 함량, 그리고 이 음식에 대한 간단한 영양학적 조언이나 팁을 JSON 형식으로 알려줘.";
            const schema = { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" }, tip: { type: "STRING" } } };
            try { const result = await callGeminiVisionAPI_server({ base64ImageData, prompt, schema }); return result.data.result; } 
            catch (error) { console.error("Firebase Function 호출 실패 (Vision):", error); throw error; }
        }
        
        function renderPhotoAnalysisResult(data) {
            const resultView = document.getElementById('photo-result-view');
            resultView.innerHTML = `<div class="text-center"><p class="text-sm text-slate-500">AI 분석 결과</p><p class="text-2xl font-jua text-green-600 my-2">${data.name}</p></div><div class="my-4 bg-green-50 p-4 rounded-2xl space-y-2 text-sm"><div class="flex justify-between"><span>🔥 칼로리</span><span class="font-semibold">${data.calories} kcal</span></div><div class="flex justify-between"><span>🍞 탄수화물</span><span class="font-semibold">${data.carbs} g</span></div><div class="flex justify-between"><span>🍗 단백질</span><span class="font-semibold">${data.protein} g</span></div><div class="flex justify-between"><span>🥑 지방</span><span class="font-semibold">${data.fat} g</span></div></div><div class="my-4 text-center text-sm bg-sky-50 text-sky-700 p-3 rounded-2xl"><p>💡 <strong>영양 팁:</strong> ${data.tip}</p></div><button id="log-photo-result" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition">기록하기</button>`;
            document.getElementById('log-photo-result').addEventListener('click', () => { logFoodItem({ name: `(사진) ${data.name}`, ...data, timestamp: Date.now(), photo: selectedImageBase64 }); closePhotoAnalysisModal(); });
        }

        function handleImageSelection(event, previewElement, callback) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                callback(reader.result);
                previewElement.style.backgroundImage = `url('${reader.result}')`;
                previewElement.style.backgroundSize = 'cover';
                previewElement.style.backgroundPosition = 'center';
                previewElement.innerHTML = '';
            };
            reader.readAsDataURL(file);
        }

        function openModal(modal) { modal.classList.remove('pointer-events-none', 'opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }
        function closeModal(modal) { modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('scale-95'); setTimeout(() => modal.classList.add('pointer-events-none'), 300); }
        function openProfileModal() { if(userProfile) { document.getElementById('gender').value = userProfile.gender || 'female'; document.getElementById('age').value = userProfile.age || ''; document.getElementById('height').value = userProfile.height || ''; document.getElementById('weight').value = userProfile.weight || ''; document.getElementById('activity').value = userProfile.activity || '1.55'; document.getElementById('goal').value = userProfile.goal || 'maintain'; } openModal(profileModal); }
        function openAddFoodModal() { openModal(addFoodModal); }
        function closeAddFoodModal() { 
            closeModal(addFoodModal);
            setTimeout(() => {
                document.getElementById('add-food-form').reset();
                manualImageBase64 = null;
                const manualImagePreview = document.getElementById('manual-image-preview');
                manualImagePreview.style.backgroundImage = '';
                manualImagePreview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg><p class="mt-2 text-sm font-semibold">사진 첨부 (선택)</p>';
            }, 300);
        }
        function openPhotoAnalysisModal() { openModal(photoAnalysisModal); }
        function closePhotoAnalysisModal() { 
            closeModal(photoAnalysisModal);
            setTimeout(() => {
                document.getElementById('photo-upload-view').classList.remove('hidden');
                document.getElementById('photo-loading-view').classList.add('hidden');
                document.getElementById('photo-result-view').classList.add('hidden');
                const imagePreview = document.getElementById('image-preview');
                imagePreview.style.backgroundImage = '';
                imagePreview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><p class="mt-2 font-semibold">사진을 여기에 올려주세요</p>';
                document.getElementById('photo-input').value = '';
                selectedImageBase64 = null;
                document.getElementById('analyze-photo-button').disabled = true;
            }, 300);
        }
        
        let toastTimer;
        function showToast(message) { const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); toastMessage.textContent = message; toast.classList.remove('opacity-0', 'translate-y-2'); clearTimeout(toastTimer); toastTimer = setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-2'); }, 3000); }

        let currentWaterIntake = 0;
        function updateWaterUI(count) { currentWaterIntake = count; document.getElementById('water-intake').textContent = count; }
        async function updateWaterInDB(newCount) { 
            if (newCount < 0) newCount = 0; 
            const today = new Date().toISOString().slice(0, 10); 
            const waterRef = doc(db, `artifacts/${appId}/users/${userId}/water`, today); 
            try { await setDoc(waterRef, { count: newCount }); renderCalendar(); } 
            catch (error) { showToast('물 섭취량 기록 실패.'); } 
        }
        document.getElementById('add-water-button').addEventListener('click', () => updateWaterInDB(currentWaterIntake + 1));
        document.getElementById('remove-water-button').addEventListener('click', () => updateWaterInDB(currentWaterIntake - 1));

    </script>
</body>
</html>
