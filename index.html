<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”¼íŠ¸ë°€ - ë‚˜ë§Œì˜ AI ì˜ì–‘ì‚¬</title>
    <meta name="google-adsense-account" content="ca-pub-8389343171492169">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8389343171492169"
     crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0fdf4;
        }
        .font-jua {
            font-family: 'Jua', sans-serif;
        }
        .meal-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .meal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(34, 197, 94, 0.15);
        }
        .nutrient-ring {
            --size: 80px;
            --thickness: 8px;
            width: var(--size);
            height: var(--size);
            position: relative;
            display: inline-grid;
            place-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .nutrient-ring::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: conic-gradient(var(--color, #22c55e) calc(var(--p, 0) * 1%), #dcfce7 0);
            border-radius: 50%;
            mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            -webkit-mask: radial-gradient(farthest-side, transparent calc(99% - var(--thickness)), #fff calc(100% - var(--thickness)));
            transition: background 0.5s ease-in-out;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .custom-shadow {
            box-shadow: 0 4px 12px 0 rgba(34, 197, 94, 0.1);
        }
        .dashed-border {
             background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%23bbf7d0' stroke-width='3' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .calendar-day {
            transition: background-color 0.2s ease-in-out;
        }
        .premium-crown {
            filter: drop-shadow(0 2px 4px rgba(252, 211, 77, 0.6));
        }
        .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.1em; font-weight: 600; }
        .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="text-slate-700">

    <div id="app-root">
        </div>

    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">ë‚´ ì •ë³´ ìˆ˜ì •</h2>
            <form id="profile-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4"><div><label for="gender" class="block text-sm font-medium text-slate-600">ì„±ë³„</label><select id="gender" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="female">ì—¬ì„±</option><option value="male">ë‚¨ì„±</option><option value="unspecified">ì„ íƒ ì•ˆí•¨</option></select></div><div><label for="age" class="block text-sm font-medium text-slate-600">ë‚˜ì´</label><input type="number" id="age" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="ì„¸"></div></div><div class="grid grid-cols-2 gap-4"><div><label for="height" class="block text-sm font-medium text-slate-600">ì‹ ì¥</label><input type="number" id="height" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="cm"></div><div><label for="weight" class="block text-sm font-medium text-slate-600">ì²´ì¤‘</label><input type="number" id="weight" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="kg"></div></div><div><label for="activity" class="block text-sm font-medium text-slate-600">í™œë™ëŸ‰</label><select id="activity" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="1.2">ê±°ì˜ ì—†ìŒ</option><option value="1.375">ê°€ë²¼ìš´ í™œë™</option><option value="1.55">ë³´í†µ í™œë™</option><option value="1.725">ë†’ì€ í™œë™</option><option value="1.9">ë§¤ìš° ë†’ì€ í™œë™</option></select></div><div><label for="goal" class="block text-sm font-medium text-slate-600">ëª©í‘œ</label><select id="goal" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="loss">ì²´ì¤‘ ê°ëŸ‰</option><option value="maintain">ì²´ì¤‘ ìœ ì§€</option><option value="gain">ì²´ì¤‘ ì¦ê°€</option></select></div><div class="pt-4"><button type="submit" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition duration-300">ì €ì¥í•˜ê¸°</button></div>
            </form>
        </div>
    </div>
    
    <div id="add-food-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">ìŒì‹ ê¸°ë¡í•˜ê¸°</h2>
            <form id="add-food-form" class="space-y-4">
                <label for="manual-photo-input" class="cursor-pointer">
                    <div id="manual-image-preview" class="w-full h-32 bg-green-50 rounded-2xl flex flex-col items-center justify-center text-green-400 dashed-border">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        <p class="mt-2 text-sm font-semibold">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</p>
                    </div>
                </label>
                <input type="file" id="manual-photo-input" accept="image/*" class="hidden">
                
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-2">
                        <label for="food-name" class="block text-sm font-medium text-slate-600">ìŒì‹ ì´ë¦„</label>
                        <input type="text" id="food-name" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label for="food-weight" class="block text-sm font-medium text-slate-600">ì–‘ (g)</label>
                        <input type="number" id="food-weight" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required>
                    </div>
                </div>
                 <button type="button" id="calculate-nutrients-btn" class="w-full bg-green-100 text-green-600 py-2.5 rounded-lg text-sm font-semibold hover:bg-green-200">AI ì˜ì–‘ì†Œ ìë™ ê³„ì‚°</button>
                
                <div id="nutrient-loader" class="hidden text-center py-2">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="food-calories" class="block text-sm font-medium text-slate-600">ì¹¼ë¡œë¦¬ (kcal)</label><input type="number" id="food-calories" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                    <div><label for="food-protein" class="block text-sm font-medium text-slate-600">ë‹¨ë°±ì§ˆ (g)</label><input type="number" id="food-protein" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="food-carbs" class="block text-sm font-medium text-slate-600">íƒ„ìˆ˜í™”ë¬¼ (g)</label><input type="number" id="food-carbs" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                    <div><label for="food-fat" class="block text-sm font-medium text-slate-600">ì§€ë°© (g)</label><input type="number" id="food-fat" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required></div>
                </div>
                <div class="pt-4 flex space-x-3">
                    <button type="button" id="cancel-add-food" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ì·¨ì†Œ</button>
                    <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition duration-300">ê¸°ë¡í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-exercise-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">ìš´ë™ ê¸°ë¡í•˜ê¸°</h2>
            <form id="add-exercise-form" class="space-y-4">
                <div>
                    <label for="exercise-name" class="block text-sm font-medium text-slate-600">ìš´ë™ ì´ë¦„</label>
                    <input type="text" id="exercise-name" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required placeholder="ì˜ˆ: ë‹¬ë¦¬ê¸°, ìš”ê°€">
                </div>
                <div>
                    <label for="exercise-duration" class="block text-sm font-medium text-slate-600">ìš´ë™ ì‹œê°„ (ë¶„)</label>
                    <input type="number" id="exercise-duration" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" required>
                </div>
                <button type="button" id="calculate-exercise-calories-btn" class="w-full bg-teal-100 text-teal-600 py-2.5 rounded-lg text-sm font-semibold hover:bg-teal-200">AI ì˜ˆìƒ ì†Œëª¨ ì¹¼ë¡œë¦¬ ê³„ì‚°</button>
                <div id="exercise-calorie-loader" class="hidden text-center py-2">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                </div>
                <div id="exercise-calorie-result" class="hidden text-center bg-green-50 p-3 rounded-lg">
                    <p class="text-slate-600">ì˜ˆìƒ ì†Œëª¨ ì¹¼ë¡œë¦¬: <span id="calculated-calories" class="font-bold text-green-600">0</span> kcal</p>
                </div>
                <div class="pt-4 flex space-x-3">
                    <button type="button" id="cancel-add-exercise" class="w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ì·¨ì†Œ</button>
                    <button type="submit" id="submit-exercise-btn" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition disabled:bg-green-300" disabled>ê¸°ë¡í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <div id="photo-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">AI ìŒì‹ ë¶„ì„</h2>
            <div id="photo-upload-view">
                <label for="photo-input" class="cursor-pointer">
                    <div id="image-preview" class="w-full h-48 bg-green-50 rounded-2xl flex flex-col items-center justify-center text-green-400 dashed-border">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="mt-2 font-semibold">ì‚¬ì§„ì„ ì—¬ê¸°ì— ì˜¬ë ¤ì£¼ì„¸ìš”</p>
                    </div>
                </label>
                <input type="file" id="photo-input" accept="image/*" class="hidden">
                <button id="analyze-photo-button" class="mt-4 w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition duration-300 disabled:bg-green-300">
                    ë¶„ì„ ì‹œì‘í•˜ê¸°
                </button>
            </div>
            <div id="photo-loading-view" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
                <p class="mt-4 text-slate-500">AIê°€ ì‚¬ì§„ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</p>
            </div>
            <div id="photo-result-view" class="hidden">
            </div>
             <button type="button" id="cancel-photo-analysis" class="mt-4 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="calendar-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 id="calendar-detail-title" class="text-2xl font-jua text-green-600 mb-6 text-center"></h2>
            <div id="calendar-detail-list" class="space-y-3 max-h-96 overflow-y-auto">
            </div>
            <button type="button" id="close-calendar-detail" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ë‹«ê¸°</button>
        </div>
    </div>
    
    <div id="premium-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300 text-center">
            <h2 class="text-2xl font-jua text-green-600 mb-4">ğŸ’ í”¼íŠ¸ë°€ í”„ë¦¬ë¯¸ì—„</h2>
            <p class="text-slate-600 mb-6">ìƒì„¸ ë¦¬í¬íŠ¸ ê¸°ëŠ¥ì€ í”„ë¦¬ë¯¸ì—„ êµ¬ë…ì ì „ìš©ì…ë‹ˆë‹¤. ì§€ê¸ˆ êµ¬ë…í•˜ê³  ëª¨ë“  ê¸°ëŠ¥ì„ ì œí•œ ì—†ì´ ì´ìš©í•´ ë³´ì„¸ìš”!</p>
            <button id="subscribe-now-btn" class="w-full bg-amber-400 text-amber-900 py-3 rounded-full font-semibold hover:bg-amber-500 transition duration-300">
                í”„ë¦¬ë¯¸ì—„ êµ¬ë…í•˜ê¸°
            </button>
             <button type="button" id="close-premium-modal" class="mt-4 w-full text-slate-500 py-2 rounded-full font-semibold hover:bg-slate-100 transition duration-300">ë‚˜ì¤‘ì— í• ê²Œìš”</button>
        </div>
    </div>

    <div id="terms-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-2xl p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">ì´ìš©ì•½ê´€</h2>
            <div class="prose prose-sm max-h-96 overflow-y-auto text-slate-600">
                <h3>ì œ1ì¡° (ëª©ì )</h3>
                <p>ë³¸ ì•½ê´€ì€ ì—í”„ì•¤ì•¤(ì´í•˜ "íšŒì‚¬")ê°€ ì œê³µí•˜ëŠ” í”¼íŠ¸ë°€ ì•±(ì´í•˜ "ì„œë¹„ìŠ¤")ì˜ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬, íšŒì‚¬ì™€ ì´ìš©ì ê°„ì˜ ê¶Œë¦¬ì™€ ì˜ë¬´, ì±…ì„ì‚¬í•­ ë“±ì„ ì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
                <h3>ì œ2ì¡° (ì •ì˜)</h3>
                <p>"ì´ìš©ì"ë€ í”¼íŠ¸ë°€ ì•±ì— ì ‘ì†í•˜ì—¬ ë³¸ ì•½ê´€ì— ë”°ë¼ íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ëª¨ë“  ë¶„ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
                <p>"í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤"ëŠ” ì„œë¹„ìŠ¤ ë‚´ ìœ ë£Œ ê²°ì œë¥¼ í†µí•´ ì´ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ê´‘ê³  ì œê±°, ìº˜ë¦°ë” ìƒ ìƒì„¸ ë¦¬í¬íŠ¸ ì—´ëŒ ë“±ì˜ ê¸°ëŠ¥ì„ í¬í•¨í•©ë‹ˆë‹¤.</p>
                <p>"ì½˜í…ì¸ "ë€ í”¼íŠ¸ë°€ì—ì„œ ì œê³µí•˜ëŠ” AI ì‹ë‹¨ ì¶”ì²œ, ì˜ì–‘ ì •ë³´, í…ìŠ¤íŠ¸, ì´ë¯¸ì§€ ë° ê¸°íƒ€ ìë£Œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.</p>
                <h3>ì œ7ì¡° (ì½˜í…ì¸  ë° ì •ë³´ì˜ í•œê³„)</h3>
                <p>í”¼íŠ¸ë°€ ì•±ì—ì„œ ì œê³µë˜ëŠ” AI ì‹ë‹¨ ì¶”ì²œ ë° ì˜ì–‘ ì •ë³´ ì½˜í…ì¸ ëŠ” ì¸ê³µì§€ëŠ¥(AI) ê¸°ìˆ ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±ë˜ëŠ” ì •ë³´ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ì •ë³´ëŠ” ê±´ê°• ê´€ë¦¬ë¥¼ ìœ„í•œ ì°¸ê³ ìš©ìœ¼ë¡œ ì œê³µë˜ëŠ” ê²ƒìœ¼ë¡œ, ì˜í•™ì  ì§„ë‹¨ì´ë‚˜ ë²•ì  íš¨ë ¥ì„ ë³´ì¥í•˜ëŠ” í•´ì„ì€ ì•„ë‹™ë‹ˆë‹¤. AIëŠ” ì´ìš©ìê°€ ì…ë ¥í•œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í†µê³„ì  ì•Œê³ ë¦¬ì¦˜ì— ë”°ë¼ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ë¯€ë¡œ, ì‹¤ì œ ì „ë¬¸ê°€ì˜ ì§„ë‹¨ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íšŒì‚¬ëŠ” í•´ë‹¹ ì½˜í…ì¸ ì— ë”°ë¥¸ ì´ìš©ìì˜ í•´ì„ì´ë‚˜ íŒë‹¨, í–‰ë™ ê²°ê³¼ì— ëŒ€í•´ ë²•ì  ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                <h3>ì œ10ì¡° (ì±…ì„ì˜ ì œí•œ)</h3>
                <p>ì´ìš©ìì˜ ë‹¨ë§ê¸° í™˜ê²½, ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ë“± ì™¸ë¶€ ìš”ì¸ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ì„œë¹„ìŠ¤ ì´ìš©ì˜ ì–´ë ¤ì›€ì— ëŒ€í•´ì„œëŠ” íšŒì‚¬ê°€ ì§ì ‘ì ìœ¼ë¡œ ì±…ì„ì§€ê¸° ì–´ë µìŠµë‹ˆë‹¤. ì•± ë‚´ ì œê³µë˜ëŠ” ì½˜í…ì¸ ëŠ” ì°¸ê³ ìš© ì •ë³´ì´ë©°, ì´ì— ë”°ë¥¸ íŒë‹¨ì´ë‚˜ í–‰ìœ„ì˜ ê²°ê³¼ì— ëŒ€í•´ì„œëŠ” íšŒì‚¬ê°€ ë²•ì  ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                <hr>
                <p><strong>ë¶€ì¹™</strong><br>ì´ ì•½ê´€ì€ 2025ë…„ 8ì›” 27ì¼ë¶€í„° ì‹œí–‰ë©ë‹ˆë‹¤.</p>
            </div>
            <button type="button" id="close-terms-modal" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-2xl p-6 md:p-8 transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-jua text-green-600 mb-6 text-center">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</h2>
            <div class="prose prose-sm max-h-96 overflow-y-auto text-slate-600">
                <h3>1. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ í•­ëª©</h3>
                <p>íšŒì‚¬ëŠ” ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.<br>
                - í”„ë¡œí•„ ì„¤ì • ì‹œ (ì„ íƒ): ì„±ë³„, ë‚˜ì´, í‚¤, ì²´ì¤‘, í™œë™ëŸ‰, ëª©í‘œ<br>
                - ì„œë¹„ìŠ¤ ì´ìš© ì‹œ ìë™ ìˆ˜ì§‘: ê¸°ê¸° ì •ë³´, IP ì£¼ì†Œ, ì ‘ì† ê¸°ë¡, ì¿ í‚¤ ë“±<br>
                - ìœ ë£Œ ì„œë¹„ìŠ¤ ì´ìš© ì‹œ: ê²°ì œ ê¸°ë¡ (ê²°ì œ ìˆ˜ë‹¨ ì •ë³´ëŠ” ìˆ˜ì§‘í•˜ì§€ ì•ŠìŒ)</p>
                <h3>2. ê°œì¸ì •ë³´ì˜ ì´ìš© ëª©ì </h3>
                <p>íšŒì‚¬ëŠ” ìˆ˜ì§‘í•œ ê°œì¸ì •ë³´ë¥¼ ë‹¤ìŒì˜ ëª©ì ì„ ìœ„í•´ í™œìš©í•©ë‹ˆë‹¤.<br>
                - AI ê¸°ë°˜ ë§ì¶¤í˜• ì‹ë‹¨ ë° ìš´ë™ ì¶”ì²œ ì„œë¹„ìŠ¤ ì œê³µ<br>
                - ìœ ë£Œ ì„œë¹„ìŠ¤ ì œê³µ ë° ê²°ì œ ì²˜ë¦¬<br>
                - ì„œë¹„ìŠ¤ ì•ˆì •ì„± í™•ë³´</p>
                <h3>3. ê°œì¸ì •ë³´ ë³´ìœ  ë° ì´ìš© ê¸°ê°„</h3>
                <p>ê°œì¸ì •ë³´ëŠ” ëª©ì  ë‹¬ì„± í›„ ì§€ì²´ ì—†ì´ íŒŒê¸°í•˜ë©°, ê´€ê³„ ë²•ë ¹ì— ë”°ë¼ ì¼ì • ê¸°ê°„ ë³´ì¡´ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <h3>4. ê°œì¸ì •ë³´ì˜ ì œ3ì ì œê³µ ë° ì²˜ë¦¬ ìœ„íƒ</h3>
                <p>íšŒì‚¬ëŠ” ì›ì¹™ì ìœ¼ë¡œ ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì™¸ë¶€ì— ì œê³µí•˜ì§€ ì•Šìœ¼ë©°, ê²°ì œ ì²˜ë¦¬ ë° ì„œë¹„ìŠ¤ ì•ˆì •ì„± í™•ë³´ë¥¼ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì´ ê°œì¸ì •ë³´ ì²˜ë¦¬ë¥¼ ìœ„íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - ìˆ˜íƒì—…ì²´: Google (Firebase), Apple (App Store)<br>
                - ìœ„íƒì—…ë¬´: ë°ì´í„° ì €ì¥ ë° ë¶„ì„, ì¸ì•± ê²°ì œ ì²˜ë¦¬</p>
                <h3>5. ê°œì¸ì •ë³´ ë³´í˜¸ì±…ì„ì</h3>
                <p>ì„±ëª…: í™©ê·œì°¬<br>
                ì†Œì†/ì§ì±…: ì—í”„ì•¤ì•¤ / ëŒ€í‘œ<br>
                ì´ë©”ì¼: wgchan247@gmail.com<br>
                ì „í™”ë²ˆí˜¸: 010-9567-6114</p>
                <hr>
                <p><strong>ê³µê³ ì¼ì:</strong> 2025ë…„ 8ì›” 25ì¼<br>
                <strong>ì‹œí–‰ì¼ì:</strong> 2025ë…„ 8ì›” 27ì¼</p>
            </div>
            <button type="button" id="close-privacy-modal" class="mt-6 w-full bg-slate-100 text-slate-600 py-3 rounded-full font-semibold hover:bg-slate-200 transition duration-300">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 transform translate-y-2 transition-all duration-300 font-semibold">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        // Firebase SDK ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAuth, ... } // ì¸ì¦ ê´€ë ¨ SDK ì œê±°
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, collection, query, where, getDocs, documentId } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCRax6rd1rlBIc3kVgg5OkHmSIQyzJmC8A",
            authDomain: "fitmeal-app-d1a97.firebaseapp.com",
            projectId: "fitmeal-app-d1a97",
            storageBucket: "fitmeal-app-d1a97.appspot.com",
            messagingSenderId: "968711774677",
            appId: "1:968711774677:web:b3d3cb9ccc2388c3ba5d5c"
        };
        const appId = firebaseConfig.appId || 'default-diet-app';

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        // const auth = getAuth(app); // ì¸ì¦ ê°ì²´ ì œê±°
        const db = getFirestore(app);
        const functions = getFunctions(app);

        // Firebase Functions ì°¸ì¡°
        const callGeminiAPI_server = httpsCallable(functions, 'callGeminiAPI');
        const callGeminiVisionAPI_server = httpsCallable(functions, 'callGeminiVisionAPI');

        // ìƒíƒœ ê´€ë¦¬
        const MOCK_USER_ID = 'local-user'; // ì¸ì¦ì„ ëŒ€ì‹ í•  ê³ ì • ID
        let userProfile = null;
        let dailyIntake = [];
        let dailyExercise = [];
        let selectedImageBase64 = null;
        let manualImageBase64 = null;
        let currentDate = new Date();
        let isPremium = false;
        let calorieChartInstance = null;
        let macroChartInstance = null;
        let currentPage = 'loading';

        const appRoot = document.getElementById('app-root');

        const calendarIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>`;
        const homeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>`;
        
        // --- í˜ì´ì§€ í…œí”Œë¦¿ ---
        const ProfileSetupPage = () => `
            <div class="fixed inset-0 bg-green-50 flex items-center justify-center z-40 p-4">
                 <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 md:p-8">
                    <h2 class="text-2xl font-jua text-green-600 mb-2 text-center">í”¼íŠ¸ë°€ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                    <p class="text-slate-600 mb-6 text-center">ì •í™•í•œ AI ì¶”ì²œì„ ìœ„í•´ í”„ë¡œí•„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
                    <form id="profile-setup-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4"><div><label for="gender-setup" class="block text-sm font-medium text-slate-600">ì„±ë³„</label><select id="gender-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="female">ì—¬ì„±</option><option value="male">ë‚¨ì„±</option><option value="unspecified">ì„ íƒ ì•ˆí•¨</option></select></div><div><label for="age-setup" class="block text-sm font-medium text-slate-600">ë‚˜ì´</label><input type="number" id="age-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="ì„¸" required></div></div><div class="grid grid-cols-2 gap-4"><div><label for="height-setup" class="block text-sm font-medium text-slate-600">ì‹ ì¥</label><input type="number" id="height-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="cm" required></div><div><label for="weight-setup" class="block text-sm font-medium text-slate-600">ì²´ì¤‘</label><input type="number" id="weight-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="kg" required></div></div><div><label for="activity-setup" class="block text-sm font-medium text-slate-600">í™œë™ëŸ‰</label><select id="activity-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="1.2">ê±°ì˜ ì—†ìŒ</option><option value="1.375">ê°€ë²¼ìš´ í™œë™</option><option value="1.55">ë³´í†µ í™œë™</option><option value="1.725">ë†’ì€ í™œë™</option><option value="1.9">ë§¤ìš° ë†’ì€ í™œë™</option></select></div><div><label for="goal-setup" class="block text-sm font-medium text-slate-600">ëª©í‘œ</label><select id="goal-setup" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="loss">ì²´ì¤‘ ê°ëŸ‰</option><option value="maintain">ì²´ì¤‘ ìœ ì§€</option><option value="gain">ì²´ì¤‘ ì¦ê°€</option></select></div><div class="pt-4"><button type="submit" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition duration-300">ì‹œì‘í•˜ê¸°</button></div>
                    </form>
                </div>
            </div>
        `;

        const MainAppPage = () => `
            <div id="app-view-content" class="max-w-4xl mx-auto p-4 md:p-6">
                <header class="flex justify-between items-center mb-8">
                    <h1 class="text-4xl font-jua text-green-600">í”¼íŠ¸ë°€ ğŸ¥—</h1>
                    <div class="flex items-center gap-4">
                        <button id="stats-toggle-button" class="text-gray-400 hover:text-green-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg></button>
                        <button id="calendar-toggle-button" class="text-gray-400 hover:text-green-500">${calendarIconSVG}</button>
                        <button id="profile-button" class="text-gray-400 hover:text-green-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" /></svg></button>
                        </div>
                </header>
                <main id="dashboard-view" class="space-y-8">
                    <section id="nutrition-progress" class="bg-white p-6 rounded-3xl custom-shadow">
                        <h2 class="text-xl font-jua text-green-600 mb-4">ì˜¤ëŠ˜ì˜ ì˜ì–‘ ì²´í¬ ğŸ“Š</h2>
                        <div id="progress-content" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="flex flex-col items-center"><div id="calories-ring" class="nutrient-ring" style="--color: #f97316; --p: 0;"><span id="calories-current">0</span><small class="text-slate-400">/ <span id="calories-goal">0</span></small></div><p class="mt-2 font-semibold">ì¹¼ë¡œë¦¬ (kcal)</p></div><div class="flex flex-col items-center"><div id="carbs-ring" class="nutrient-ring" style="--color: #14b8a6; --p: 0;"><span id="carbs-current">0</span><small class="text-slate-400">/ <span id="carbs-goal">0</span></small></div><p class="mt-2 font-semibold">íƒ„ìˆ˜í™”ë¬¼ (g)</p></div><div class="flex flex-col items-center"><div id="protein-ring" class="nutrient-ring" style="--color: #f59e0b; --p: 0;"><span id="protein-current">0</span><small class="text-slate-400">/ <span id="protein-goal">0</span></small></div><p class="mt-2 font-semibold">ë‹¨ë°±ì§ˆ (g)</p></div><div class="flex flex-col items-center"><div id="fat-ring" class="nutrient-ring" style="--color: #8b5cf6; --p: 0;"><span id="fat-current">0</span><small class="text-slate-400">/ <span id="fat-goal">0</span></small></div><p class="mt-2 font-semibold">ì§€ë°© (g)</p></div>
                        </div>
                    </section>
                    <section id="daily-intake-log">
                        <h2 class="text-xl font-jua text-green-600 mb-4">ì˜¤ëŠ˜ì˜ ë‹¤ì´ì–´íŠ¸ ê¸°ë¡ ğŸ“</h2>
                        <div id="daily-intake-list" class="space-y-3 mb-4"></div>
                        <div class="grid grid-cols-2 gap-3"><button id="add-food-button" class="w-full bg-white border-2 border-dashed border-green-200 text-green-500 py-3 rounded-2xl font-semibold hover:bg-green-50 hover:border-green-400 transition duration-300">+ ì§ì ‘ ì…ë ¥</button><button id="add-photo-button" class="w-full bg-green-500 text-white py-3 rounded-2xl font-semibold hover:bg-green-600 transition duration-300 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>AI ì¹´ë©”ë¼ë¡œ ê¸°ë¡</button></div>
                    </section>
                    <section id="daily-exercise-log">
                        <h2 class="text-xl font-jua text-green-600 mb-4">ì˜¤ëŠ˜ ìš´ë™ ê¸°ë¡ ğŸ‹ï¸â€â™€ï¸</h2>
                        <div id="daily-exercise-list" class="space-y-3 mb-4"></div>
                        <button id="add-exercise-button" class="w-full bg-white border-2 border-dashed border-teal-200 text-teal-500 py-3 rounded-2xl font-semibold hover:bg-teal-50 hover:border-teal-400 transition duration-300">+ ìš´ë™ ì¶”ê°€í•˜ê¸°</button>
                    </section>
                    <section id="meal-plan">
                        <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-jua text-green-600">AI ì¶”ì²œ ì‹ë‹¨ âœ¨</h2><button id="generate-plan-button" class="bg-green-500 text-white px-5 py-2 rounded-full font-semibold hover:bg-green-600 transition duration-300 disabled:bg-green-300 shadow-sm shadow-green-200">ìƒˆ ì‹ë‹¨ ë°›ê¸°</button></div>
                        <div id="meal-plan-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        <div id="loader" class="hidden text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div><p class="mt-4 text-slate-500">AIê°€ ë§ì¶¤ ì‹ë‹¨ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p></div>
                    </section>
                    <section id="water-tracker" class="bg-white p-6 rounded-3xl custom-shadow">
                        <h2 class="text-xl font-jua text-green-600 mb-4">ìˆ˜ë¶„ ì„­ì·¨ ğŸ’§</h2>
                        <div class="flex items-center justify-between">
                            <div><p class="text-3xl font-bold text-sky-500"><span id="water-intake">0</span> / <span id="water-goal">8</span> ì”</p><p class="text-slate-400 text-sm">2L ëª©í‘œ (1ì” = 250ml)</p></div>
                            <div class="flex space-x-2"><button id="add-water-button" class="bg-sky-400 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl font-bold hover:bg-sky-500 transition shadow-sm shadow-sky-200">+</button><button id="remove-water-button" class="bg-slate-100 text-slate-500 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 transition">-</button></div>
                        </div>
                    </section>
                    <section id="ad-banner-container" class="mt-8 flex justify-center items-center h-24 bg-slate-100 rounded-2xl"><p class="text-slate-400 text-sm">ê´‘ê³ ê°€ í‘œì‹œë  ê³µê°„ì…ë‹ˆë‹¤.</p></section>
                    <footer class="text-center pt-8">
                        <a href="#" id="terms-link" class="text-xs text-slate-400 hover:text-slate-600 hover:underline transition">ì´ìš©ì•½ê´€</a>
                        <span class="mx-2 text-slate-400">|</span>
                        <a href="#" id="privacy-link" class="text-xs text-slate-400 hover:text-slate-600 hover:underline transition">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a>
                    </footer>
                </main>
                <section id="calendar-view" class="hidden space-y-4">
                    <div class="bg-white p-6 rounded-3xl custom-shadow">
                        <div class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="p-2 rounded-full hover:bg-green-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><h2 id="calendar-month-year" class="text-xl font-jua text-green-600"></h2><button id="next-month-btn" class="p-2 rounded-full hover:bg-green-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button></div>
                        <div class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-slate-500 mb-2"><div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div></div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                    </div>
                    <div id="premium-section" class="bg-white p-6 rounded-3xl custom-shadow text-center"><h2 class="text-xl font-jua text-green-600 mb-4">ğŸ’ í”¼íŠ¸ë°€ í”„ë¦¬ë¯¸ì—„</h2><p class="text-slate-600 mb-4">í”„ë¦¬ë¯¸ì—„ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ê³  ê´‘ê³  ì—†ì´ ë” ìƒì„¸í•œ ë¦¬í¬íŠ¸ë¥¼ ë°›ì•„ë³´ì„¸ìš”!</p><button id="report-btn" class="w-full bg-amber-400 text-amber-900 py-3 rounded-full font-semibold hover:bg-amber-500 transition duration-300 flex items-center justify-center gap-2"><span class="premium-crown">ğŸ‘‘</span> ìƒì„¸ ë¦¬í¬íŠ¸ ë³´ê¸°</button></div>
                </section>
                <section id="stats-view" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-3xl custom-shadow"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-jua text-green-600">í†µê³„ ë¦¬í¬íŠ¸</h2><div class="flex rounded-full bg-slate-100 p-1 text-sm font-semibold"><button id="weekly-report-btn" class="px-4 py-1 rounded-full bg-white text-green-600 shadow">ì£¼ê°„</button><button id="monthly-report-btn" class="px-4 py-1 rounded-full text-slate-500">ì›”ê°„</button></div></div></div>
                    <div class="bg-white p-6 rounded-3xl custom-shadow"><h3 id="calorie-chart-title" class="text-lg font-jua text-green-600 mb-4">ì£¼ê°„ ì¹¼ë¡œë¦¬ ì„­ì·¨ëŸ‰</h3><div class="chart-container"><canvas id="calorie-chart"></canvas></div></div>
                    <div class="grid md:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-3xl custom-shadow"><h3 id="macro-chart-title" class="text-lg font-jua text-green-600 mb-4">ì£¼ê°„ ì˜ì–‘ì†Œ ë¹„ìœ¨</h3><div class="chart-container" style="height: 300px; max-width: 300px; margin: auto;"><canvas id="macro-chart"></canvas></div></div><div class="bg-white p-6 rounded-3xl custom-shadow"><h3 id="top-foods-title" class="text-lg font-jua text-green-600 mb-4">ìì£¼ ë¨¹ì€ ìŒì‹ TOP 5</h3><div id="top-foods-list" class="space-y-2"></div></div></div>
                    <div class="bg-white p-6 rounded-3xl custom-shadow"><h3 id="average-intake-title" class="text-lg font-jua text-green-600 mb-4">ì¼ì¼ í‰ê·  ì„­ì·¨ëŸ‰</h3><div id="average-intake-content" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"></div></div>
                </section>
            </div>
        `;

        // --- í˜ì´ì§€ ë Œë”ë§ ë° ìƒíƒœ ê´€ë¦¬ ---
        function renderApp(page) {
            currentPage = page;
            appRoot.innerHTML = ''; 

            switch (page) {
                case 'profileSetup':
                    appRoot.innerHTML = ProfileSetupPage();
                    attachProfileSetupListeners();
                    break;
                case 'main':
                    appRoot.innerHTML = MainAppPage();
                    attachMainAppListeners();
                    loadInitialData();
                    break;
                default:
                    appRoot.innerHTML = `<div class="text-center p-8">ë¡œë”© ì¤‘...</div>`;
            }
        }
        
        // --- ì•± ì‹œì‘ ë¡œì§ (ì¸ì¦ ëŒ€ì‹ ) ---
        (async () => {
            const profileRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/profile`, 'data');
            const profileSnap = await getDocs(query(collection(db, `artifacts/${appId}/users/${MOCK_USER_ID}/profile`)));

            if (profileSnap.empty) {
                renderApp('profileSetup'); // í”„ë¡œí•„ ì—†ìœ¼ë©´ ì„¤ì • í˜ì´ì§€ë¡œ
            } else {
                renderApp('main'); // í”„ë¡œí•„ ìˆìœ¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ
            }
        })();


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¶€ì°© í•¨ìˆ˜ë“¤ ---
        function attachProfileSetupListeners() {
            const profileSetupForm = document.getElementById('profile-setup-form');
            profileSetupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const profileData = {
                    gender: document.getElementById('gender-setup').value,
                    age: parseInt(document.getElementById('age-setup').value),
                    height: parseFloat(document.getElementById('height-setup').value),
                    weight: parseFloat(document.getElementById('weight-setup').value),
                    activity: parseFloat(document.getElementById('activity-setup').value),
                    goal: document.getElementById('goal-setup').value
                };

                if (Object.values(profileData).some(v => !v && v !== 0)) {
                    showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const userProfileRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/profile`, 'data');
                try {
                    await setDoc(userProfileRef, profileData);
                    showToast('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì„ ì‹œì‘í•©ë‹ˆë‹¤!');
                    renderApp('main');
                } catch (error) {
                    console.error("Error saving profile: ", error);
                    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
        
        function attachMainAppListeners() {
            // í—¤ë” ë²„íŠ¼
            document.getElementById('profile-button').addEventListener('click', openProfileModal);
            
            // ë©”ì¸ ê¸°ëŠ¥ ë²„íŠ¼
            document.getElementById('add-food-button').addEventListener('click', openAddFoodModal);
            document.getElementById('add-photo-button').addEventListener('click', openPhotoAnalysisModal);
            document.getElementById('add-exercise-button').addEventListener('click', () => openModal(addExerciseModal));
            document.getElementById('generate-plan-button').addEventListener('click', generateMealPlan);
            
            // í‘¸í„° ë§í¬
            document.getElementById('terms-link').addEventListener('click', (e) => { e.preventDefault(); openModal(document.getElementById('terms-modal')); });
            document.getElementById('privacy-link').addEventListener('click', (e) => { e.preventDefault(); openModal(document.getElementById('privacy-modal')); });


            // ë„¤ë¹„ê²Œì´ì…˜ (ë·° ì „í™˜)
            const calendarToggleButton = document.getElementById('calendar-toggle-button');
            const statsToggleButton = document.getElementById('stats-toggle-button');
            const dashboardView = document.getElementById('dashboard-view');
            const calendarView = document.getElementById('calendar-view');
            const statsView = document.getElementById('stats-view');

            calendarToggleButton.addEventListener('click', () => {
                const isDashboardVisible = !dashboardView.classList.contains('hidden');
                dashboardView.classList.toggle('hidden');
                calendarView.classList.toggle('hidden');
                statsView.classList.add('hidden');
                if (isDashboardVisible) {
                    calendarToggleButton.innerHTML = homeIconSVG;
                    renderCalendar();
                } else {
                    calendarToggleButton.innerHTML = calendarIconSVG;
                }
            });

            statsToggleButton.addEventListener('click', () => {
                const isDashboardVisible = !dashboardView.classList.contains('hidden');
                dashboardView.classList.toggle('hidden');
                statsView.classList.toggle('hidden');
                calendarView.classList.add('hidden'); 
                 if (isDashboardVisible) {
                    statsToggleButton.innerHTML = homeIconSVG;
                    // renderCharts(); // ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ (í•„ìš” ì‹œ êµ¬í˜„)
                } else {
                    statsToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>`;
                }
            });
            
             // ë¬¼ ì„­ì·¨
            document.getElementById('add-water-button').addEventListener('click', () => updateWaterInDB(currentWaterIntake + 1));
            document.getElementById('remove-water-button').addEventListener('click', () => updateWaterInDB(currentWaterIntake - 1));

            // ëª¨ë‹¬ ê´€ë ¨ ë¦¬ìŠ¤ë„ˆ
            attachModalListeners();
        }

        function attachModalListeners() {
            const profileModal = document.getElementById('profile-modal');
            const addFoodModal = document.getElementById('add-food-modal');
            const addExerciseModal = document.getElementById('add-exercise-modal');
            const photoAnalysisModal = document.getElementById('photo-analysis-modal');
            const calendarDetailModal = document.getElementById('calendar-detail-modal');
            const premiumModal = document.getElementById('premium-modal');
            const termsModal = document.getElementById('terms-modal');
            const privacyModal = document.getElementById('privacy-modal');

             // ê³µí†µ ëª¨ë‹¬ ë‹«ê¸°
            document.querySelectorAll('.modal-backdrop').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
            });
            document.getElementById('close-terms-modal').addEventListener('click', () => closeModal(termsModal));
            document.getElementById('close-privacy-modal').addEventListener('click', () => closeModal(privacyModal));

            // í”„ë¡œí•„ ëª¨ë‹¬
            document.getElementById('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const profileData = { gender: document.getElementById('gender').value, age: parseInt(document.getElementById('age').value), height: parseFloat(document.getElementById('height').value), weight: parseFloat(document.getElementById('weight').value), activity: parseFloat(document.getElementById('activity').value), goal: document.getElementById('goal').value };
                if (Object.values(profileData).some(v => !v && v !== 0)) { showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                const userProfileRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/profile`, 'data');
                try { await setDoc(userProfileRef, profileData); showToast('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); closeModal(profileModal); } catch (error) { console.error("Error saving profile: ", error); showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
            });

            // ìŒì‹ ì¶”ê°€ ëª¨ë‹¬
            document.getElementById('add-food-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const foodName = document.getElementById('food-name').value;
                const foodWeight = document.getElementById('food-weight').value;
                const foodItem = { name: `${foodName} (${foodWeight}g)`, calories: parseInt(document.getElementById('food-calories').value), carbs: parseInt(document.getElementById('food-carbs').value), protein: parseInt(document.getElementById('food-protein').value), fat: parseInt(document.getElementById('food-fat').value), timestamp: Date.now(), photo: manualImageBase64 };
                if (Object.values(foodItem).some(v => (v !== null && v !== 0 && !v) || (typeof v === 'number' && isNaN(v)))) { showToast('ëª¨ë“  ì˜ì–‘ ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                logFoodItem(foodItem);
                closeAddFoodModal();
            });
            document.getElementById('cancel-add-food').addEventListener('click', closeAddFoodModal);
            document.getElementById('manual-photo-input').addEventListener('change', (event) => handleImageSelection(event, document.getElementById('manual-image-preview'), (base64) => { manualImageBase64 = base64; }));
            document.getElementById('calculate-nutrients-btn').addEventListener('click', async () => {
                const foodName = document.getElementById('food-name').value;
                const foodWeight = document.getElementById('food-weight').value;
                if (!foodName || !foodWeight) { showToast('ìŒì‹ ì´ë¦„ê³¼ ì–‘(g)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                document.getElementById('nutrient-loader').classList.remove('hidden');
                try {
                    const resultText = await callGeminiNutritionAPI(`${foodName} ${foodWeight}g`);
                    const data = JSON.parse(resultText);
                    document.getElementById('food-calories').value = data.calories;
                    document.getElementById('food-carbs').value = data.carbs;
                    document.getElementById('food-protein').value = data.protein;
                    document.getElementById('food-fat').value = data.fat;
                } catch (error) { showToast('ì˜ì–‘ì†Œ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆì–´ìš”.'); } finally { document.getElementById('nutrient-loader').classList.add('hidden'); }
            });

            // ìš´ë™ ì¶”ê°€ ëª¨ë‹¬
             const addExerciseForm = document.getElementById('add-exercise-form');
             addExerciseForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                 const exerciseItem = { name: document.getElementById('exercise-name').value, duration: parseInt(document.getElementById('exercise-duration').value), calories: parseInt(document.getElementById('calculated-calories').textContent), timestamp: Date.now() };
                 if (!exerciseItem.name || isNaN(exerciseItem.duration) || isNaN(exerciseItem.calories)) { showToast('ëª¨ë“  ìš´ë™ ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                 logExerciseItem(exerciseItem);
                 closeModal(addExerciseModal);
                 addExerciseForm.reset();
                 document.getElementById('exercise-calorie-result').classList.add('hidden');
                 document.getElementById('submit-exercise-btn').disabled = true;
             });
             document.getElementById('cancel-add-exercise').addEventListener('click', () => closeModal(addExerciseModal));
             document.getElementById('calculate-exercise-calories-btn').addEventListener('click', async () => {
                 const exerciseName = document.getElementById('exercise-name').value;
                 const duration = document.getElementById('exercise-duration').value;
                 if (!exerciseName || !duration || !userProfile) { showToast('ìš´ë™ ì´ë¦„, ì‹œê°„, í”„ë¡œí•„ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                 document.getElementById('exercise-calorie-loader').classList.remove('hidden');
                 document.getElementById('exercise-calorie-result').classList.add('hidden');
                 try {
                     const prompt = `'${userProfile.weight}kg'ì¸ ì‚¬ëŒì´ '${exerciseName}' ìš´ë™ì„ '${duration}'ë¶„ í–ˆì„ ë•Œ ì˜ˆìƒ ì†Œëª¨ ì¹¼ë¡œë¦¬ë¥¼ ê³„ì‚°í•´ì„œ JSON í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì¤˜. ê°’ì€ ì •ìˆ˜ë¡œë§Œ ì œê³µí•´ì•¼ í•´.`;
                     const schema = { type: "OBJECT", properties: { calories: { type: "NUMBER" } } };
                     const resultText = await callGeminiAPI(prompt, schema);
                     const data = JSON.parse(resultText);
                     document.getElementById('calculated-calories').textContent = data.calories;
                     document.getElementById('exercise-calorie-result').classList.remove('hidden');
                     document.getElementById('submit-exercise-btn').disabled = false;
                 } catch(e) { showToast('ì¹¼ë¡œë¦¬ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆì–´ìš”.'); } finally { document.getElementById('exercise-calorie-loader').classList.add('hidden'); }
             });

            // ì‚¬ì§„ ë¶„ì„ ëª¨ë‹¬
            document.getElementById('photo-input').addEventListener('change', (event) => handleImageSelection(event, document.getElementById('image-preview'), (base64) => { selectedImageBase64 = base64; document.getElementById('analyze-photo-button').disabled = false; }));
            document.getElementById('analyze-photo-button').addEventListener('click', async () => {
                if (!selectedImageBase64) { showToast('ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
                document.getElementById('photo-upload-view').classList.add('hidden');
                document.getElementById('photo-loading-view').classList.remove('hidden');
                try {
                    const resultText = await callGeminiVisionAPI(selectedImageBase64.split(',')[1]);
                    const resultData = JSON.parse(resultText);
                    renderPhotoAnalysisResult(resultData);
                    document.getElementById('photo-loading-view').classList.add('hidden');
                    document.getElementById('photo-result-view').classList.remove('hidden');
                } catch (error) {
                    showToast('ì‚¬ì§„ ë¶„ì„ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
                    closePhotoAnalysisModal();
                }
            });
            document.getElementById('cancel-photo-analysis').addEventListener('click', closePhotoAnalysisModal);

            // ìº˜ë¦°ë” ìƒì„¸ ëª¨ë‹¬
            document.getElementById('close-calendar-detail').addEventListener('click', () => closeModal(calendarDetailModal));
            
             // í”„ë¦¬ë¯¸ì—„ ëª¨ë‹¬
            document.getElementById('close-premium-modal').addEventListener('click', () => closeModal(premiumModal));
            document.getElementById('subscribe-now-btn').addEventListener('click', async () => {
                const premiumRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/premium`, 'status');
                try {
                    await setDoc(premiumRef, { active: true, subscribedAt: new Date() });
                    showToast('ğŸ‘‘ í”„ë¦¬ë¯¸ì—„ êµ¬ë…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closeModal(premiumModal);
                } catch (error) { showToast('êµ¬ë… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
            });
        }


        // --- ì´ˆê¸° ë°ì´í„° ë¡œë”© í•¨ìˆ˜ ---
        function loadInitialData() {
             const today = new Date().toISOString().slice(0, 10);
            
             const premiumRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/premium`, 'status');
             onSnapshot(premiumRef, (docSnap) => {
                 isPremium = docSnap.exists() && docSnap.data().active === true;
                 updatePremiumUI();
             });

            const userProfileRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/profile`, 'data');
            onSnapshot(userProfileRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    updateNutritionGoalsUI(userProfile);
                    updateNutritionProgressUI(dailyIntake, userProfile.nutritionGoals); 
                }
            });

            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/dailyIntake`, today);
            onSnapshot(dailyIntakeRef, (docSnap) => {
                dailyIntake = docSnap.exists() ? docSnap.data().foods : [];
                renderDailyIntake(dailyIntake);
                if (userProfile && userProfile.nutritionGoals) {
                    updateNutritionProgressUI(dailyIntake, userProfile.nutritionGoals);
                }
            });

             const dailyExerciseRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/dailyExercise`, today);
             onSnapshot(dailyExerciseRef, (docSnap) => {
                 dailyExercise = docSnap.exists() ? docSnap.data().exercises : [];
                 renderDailyExercise(dailyExercise);
             });

             const mealPlanRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/mealPlans`, today);
             onSnapshot(mealPlanRef, (docSnap) => {
                 const mealPlanContent = document.getElementById('meal-plan-content');
                 if (docSnap.exists()) { renderMealPlan(docSnap.data().plan); } 
                 else { mealPlanContent.innerHTML = '<p class="text-center text-slate-500 md:col-span-2 py-4">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì‹ë‹¨ì„ ë°›ì•„ë³´ì„¸ìš”.</p>'; }
             });
             
             const waterRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/water`, today);
             onSnapshot(waterRef, (docSnap) => {
                 updateWaterUI(docSnap.exists() ? docSnap.data().count : 0);
             });
        }
        
        // --- í•µì‹¬ ê¸°ëŠ¥ ë° UI ë Œë”ë§ í•¨ìˆ˜ ---
        function updatePremiumUI() {
             const adBanner = document.getElementById('ad-banner-container');
             if(adBanner) adBanner.classList.toggle('hidden', isPremium);
        }

        function updateNutritionGoalsUI(profile) {
            if (!profile || !profile.weight || !profile.height || !profile.age) return;
            let bmr;
            if (profile.gender === 'male') { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) + 5; } 
            else if (profile.gender === 'female') { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) - 161; } 
            else { bmr = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) - 78; }
            
            const tdee = bmr * profile.activity;
            let finalCalories = tdee;
            if (profile.goal === 'loss') finalCalories -= 500;
            if (profile.goal === 'gain') finalCalories += 300;
            
            userProfile.nutritionGoals = { 
                calories: Math.round(finalCalories), 
                carbs: Math.round((finalCalories * 0.45) / 4), 
                protein: Math.round((finalCalories * 0.30) / 4), 
                fat: Math.round((finalCalories * 0.25) / 9) 
            };
            
            document.getElementById('calories-goal').textContent = userProfile.nutritionGoals.calories;
            document.getElementById('carbs-goal').textContent = userProfile.nutritionGoals.carbs;
            document.getElementById('protein-goal').textContent = userProfile.nutritionGoals.protein;
            document.getElementById('fat-goal').textContent = userProfile.nutritionGoals.fat;
        }

        function updateNutritionProgressUI(intake, goals) {
            if (!goals) return;
            const totals = intake.reduce((acc, food) => ({ 
                calories: acc.calories + (food.calories || 0), 
                carbs: acc.carbs + (food.carbs || 0), 
                protein: acc.protein + (food.protein || 0), 
                fat: acc.fat + (food.fat || 0) 
            }), { calories: 0, carbs: 0, protein: 0, fat: 0 });

            const updateRing = (type, current, goal) => {
                const currentEl = document.getElementById(`${type}-current`);
                const ringEl = document.getElementById(`${type}-ring`);
                if(currentEl && ringEl) {
                    currentEl.textContent = Math.round(current);
                    const percentage = goal > 0 ? Math.min(Math.round((current / goal) * 100), 100) : 0;
                    ringEl.style.setProperty('--p', percentage);
                }
            };
            
            updateRing('calories', totals.calories, goals.calories); 
            updateRing('carbs', totals.carbs, goals.carbs); 
            updateRing('protein', totals.protein, goals.protein); 
            updateRing('fat', totals.fat, goals.fat);
        }

        function renderMealPlan(plan) {
            const mealPlanContent = document.getElementById('meal-plan-content');
            mealPlanContent.innerHTML = '';
            const mealTypes = { breakfast: 'ì•„ì¹¨', lunch: 'ì ì‹¬', dinner: 'ì €ë…', snack: 'ê°„ì‹' };
            const orderedMealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];

            orderedMealTypes.forEach(mealType => {
                if (plan[mealType] && plan[mealType].name) {
                    const meal = plan[mealType];
                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-2xl custom-shadow meal-card';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-jua text-green-500">${mealTypes[mealType]}</h3>
                                <p class="text-xl font-semibold my-2 text-slate-800">${meal.name}</p>
                            </div>
                            <button class="log-ai-meal-btn bg-green-100 text-green-600 w-10 h-10 rounded-full text-xl font-semibold hover:bg-green-200 flex items-center justify-center">+</button>
                        </div>
                        <div class="flex justify-between text-sm text-slate-500 border-t border-slate-100 pt-3 mt-3">
                            <span>ğŸ”¥ ${meal.calories} kcal</span>
                            <span>ğŸ ${meal.carbs}g</span>
                            <span>ğŸ— ${meal.protein}g</span>
                            <span>ğŸ¥‘ ${meal.fat}g</span>
                        </div>`;
                    card.querySelector('.log-ai-meal-btn').addEventListener('click', () => logFoodItem({ name: `(AI) ${meal.name}`, ...meal, timestamp: Date.now() }));
                    mealPlanContent.appendChild(card);
                }
            });
        }

        function renderDailyIntake(foods) {
            const dailyIntakeList = document.getElementById('daily-intake-list');
            dailyIntakeList.innerHTML = '';
            if (foods.length === 0) { dailyIntakeList.innerHTML = '<p class="text-center text-slate-400 py-4">ì•„ì§ ê¸°ë¡ëœ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            foods.forEach((food) => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-2xl custom-shadow flex justify-between items-center';
                const imageHtml = food.photo ? `<img src="${food.photo}" class="w-12 h-12 rounded-lg object-cover mr-4">` : `<div class="w-12 h-12 rounded-lg bg-green-50 flex-shrink-0 mr-4"></div>`;
                item.innerHTML = `
                    <div class="flex items-center flex-grow">
                        ${imageHtml}
                        <div class="flex-grow">
                            <p class="font-semibold text-slate-800">${food.name}</p>
                            <p class="text-sm text-slate-500">${food.calories}kcal | íƒ„ ${food.carbs}g, ë‹¨ ${food.protein}g, ì§€ ${food.fat}g</p>
                        </div>
                    </div>
                    <button class="remove-intake-btn text-rose-300 hover:text-rose-500 text-2xl font-bold flex-shrink-0 ml-2">&times;</button>
                `;
                item.querySelector('.remove-intake-btn').addEventListener('click', () => removeFoodItem(food));
                dailyIntakeList.appendChild(item);
            });
        }

        function renderDailyExercise(exercises) {
            const dailyExerciseList = document.getElementById('daily-exercise-list');
            dailyExerciseList.innerHTML = '';
            if (exercises.length === 0) { dailyExerciseList.innerHTML = '<p class="text-center text-slate-400 py-4">ì•„ì§ ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            exercises.forEach((ex) => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-2xl custom-shadow flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-slate-800">${ex.name}</p>
                        <p class="text-sm text-slate-500">${ex.duration}ë¶„ | ${ex.calories}kcal ì†Œëª¨</p>
                    </div>
                    <button class="remove-exercise-btn text-rose-300 hover:text-rose-500 text-2xl font-bold">&times;</button>
                `;
                item.querySelector('.remove-exercise-btn').addEventListener('click', () => removeExerciseItem(ex));
                dailyExerciseList.appendChild(item);
            });
        }
        
        async function logFoodItem(foodItem) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/dailyIntake`, today);
            try { await updateDoc(dailyIntakeRef, { foods: arrayUnion(foodItem) }); showToast(`${foodItem.name} ê¸°ë¡ ì™„ë£Œ!`); } 
            catch (error) { 
                if (error.code === 'not-found') { await setDoc(dailyIntakeRef, { foods: [foodItem] }); showToast(`${foodItem.name} ê¸°ë¡ ì™„ë£Œ!`); } 
                else { showToast('ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } 
            }
            renderCalendar();
        }
        
        async function removeFoodItem(foodToRemove) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyIntakeRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/dailyIntake`, today);
            try { await updateDoc(dailyIntakeRef, { foods: arrayRemove(foodToRemove) }); showToast(`${foodToRemove.name} ì‚­ì œ ì™„ë£Œ!`); renderCalendar(); } 
            catch (error) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        }
        
        async function logExerciseItem(exerciseItem) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyExerciseRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/dailyExercise`, today);
            try { await updateDoc(dailyExerciseRef, { exercises: arrayUnion(exerciseItem) }); showToast(`${exerciseItem.name} ìš´ë™ ê¸°ë¡ ì™„ë£Œ!`); } 
            catch (error) {
                if (error.code === 'not-found') { await setDoc(dailyExerciseRef, { exercises: [exerciseItem] }); showToast(`${exerciseItem.name} ìš´ë™ ê¸°ë¡ ì™„ë£Œ!`); } 
                else { showToast('ìš´ë™ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
            }
            renderCalendar();
        }

        async function removeExerciseItem(exerciseToRemove) {
            const today = new Date().toISOString().slice(0, 10);
            const dailyExerciseRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/dailyExercise`, today);
            try { await updateDoc(dailyExerciseRef, { exercises: arrayRemove(exerciseToRemove) }); showToast(`${exerciseToRemove.name} ìš´ë™ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ!`); renderCalendar(); } 
            catch (error) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        }

        async function generateMealPlan() {
            if (!userProfile || !userProfile.nutritionGoals) { showToast('ë¨¼ì € í”„ë¡œí•„ì„ ì €ì¥í•´ì£¼ì„¸ìš”.'); openProfileModal(); return; }
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('meal-plan-content').innerHTML = '';
            document.getElementById('generate-plan-button').disabled = true;
            const userInfoParts = [ `ë‚˜ì´: ${userProfile.age}ì„¸`, userProfile.gender !== 'unspecified' ? `ì„±ë³„: ${userProfile.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}` : '', `ëª©í‘œ: ${userProfile.goal === 'loss' ? 'ì²´ì¤‘ ê°ëŸ‰' : (userProfile.goal === 'gain' ? 'ì²´ì¤‘ ì¦ê°€' : 'ì²´ì¤‘ ìœ ì§€')}` ].filter(part => part).join(', ');
            const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ì‚¬ìš©ì ì •ë³´ì™€ ì˜ì–‘ ëª©í‘œì— ë§ì¶°, ë§›ê³¼ ì˜ì–‘ì„ ëª¨ë‘ ê³ ë ¤í•œ í•œêµ­ì‹ ìœ„ì£¼ì˜ í•˜ë£¨ ì‹ë‹¨(ì•„ì¹¨, ì ì‹¬, ì €ë…, ê°„ì‹)ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”. ì‚¬ìš©ì ì •ë³´: ${userInfoParts}. ì¼ì¼ ì˜ì–‘ ëª©í‘œ: ì¹¼ë¡œë¦¬ ${userProfile.nutritionGoals.calories}kcal, íƒ„ìˆ˜í™”ë¬¼ ${userProfile.nutritionGoals.carbs}g, ë‹¨ë°±ì§ˆ ${userProfile.nutritionGoals.protein}g, ì§€ë°© ${userProfile.nutritionGoals.fat}g. ê° ì‹ì‚¬ì˜ ìŒì‹ ì´ë¦„ê³¼ ì˜ˆìƒ ì˜ì–‘ì„±ë¶„(ì¹¼ë¡œë¦¬,íƒ„ìˆ˜í™”ë¬¼,ë‹¨ë°±ì§ˆ,ì§€ë°©)ì„ ê³„ì‚°í•˜ì—¬ ì œê³µí•´ì£¼ì„¸ìš”. ì „ì²´ ì‹ë‹¨ì˜ ì˜ì–‘ì†Œ ì´í•©ì´ ëª©í‘œì¹˜ì— ìµœëŒ€í•œ ê·¼ì ‘í•´ì•¼ í•©ë‹ˆë‹¤.`;
            try {
                const schema = { type: "OBJECT", properties: { breakfast: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, lunch: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, dinner: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } }, snack: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } } } };
                const responseText = await callGeminiAPI(prompt, schema);
                const plan = JSON.parse(responseText);
                const today = new Date().toISOString().slice(0, 10);
                const mealPlanRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/mealPlans`, today);
                await setDoc(mealPlanRef, { plan: plan, createdAt: new Date() });
                showToast('AI ë§ì¶¤ ì‹ë‹¨ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) { showToast('ì‹ë‹¨ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } 
            finally { 
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('generate-plan-button').disabled = false;
            }
        }
        
        async function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            if(!calendarGrid) return;
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('calendar-month-year').textContent = `${year}ë…„ ${month + 1}ì›”`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
            
            const mealQuery = query(collection(db, `artifacts/${appId}/users/${MOCK_USER_ID}/dailyIntake`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const mealSnapshot = await getDocs(mealQuery);
            const monthMealData = {};
            mealSnapshot.forEach(doc => { monthMealData[doc.id] = doc.data(); });

            const waterQuery = query(collection(db, `artifacts/${appId}/users/${MOCK_USER_ID}/water`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const waterSnapshot = await getDocs(waterQuery);
            const monthWaterData = {};
            waterSnapshot.forEach(doc => { monthWaterData[doc.id] = doc.data(); });
            
            const exerciseQuery = query(collection(db, `artifacts/${appId}/users/${MOCK_USER_ID}/dailyExercise`), where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
            const exerciseSnapshot = await getDocs(exerciseQuery);
            const monthExerciseData = {};
            exerciseSnapshot.forEach(doc => { monthExerciseData[doc.id] = doc.data(); });

            for (let i = 0; i < firstDay; i++) { calendarGrid.innerHTML += '<div></div>'; }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasMealData = monthMealData[dayStr] && monthMealData[dayStr].foods.length > 0;
                const hasWaterData = monthWaterData[dayStr] && monthWaterData[dayStr].count > 0;
                const hasExerciseData = monthExerciseData[dayStr] && monthExerciseData[dayStr].exercises.length > 0;
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                
                const dayCell = document.createElement('div');
                dayCell.className = 'h-16 flex flex-col items-center justify-center rounded-2xl calendar-day';
                
                let iconsHTML = '';
                if (hasMealData) iconsHTML += '<span class="text-xs">ğŸ½ï¸</span>';
                if (hasWaterData) iconsHTML += '<span class="text-xs">ğŸ’§</span>';
                if (hasExerciseData) iconsHTML += '<span class="text-xs">ğŸ‹ï¸â€â™€ï¸</span>';
                
                dayCell.innerHTML = `<span class="text-sm">${day}</span><div class="flex">${iconsHTML}</div>`;
                
                if (isToday) dayCell.classList.add('bg-green-100', 'font-bold', 'text-green-600');
                
                if (hasMealData || hasWaterData || hasExerciseData) {
                    dayCell.classList.add('cursor-pointer', 'hover:bg-green-50');
                    dayCell.addEventListener('click', () => openCalendarDetailModal(dayStr, monthMealData[dayStr]?.foods || [], monthWaterData[dayStr]?.count || 0, monthExerciseData[dayStr]?.exercises || []));
                }
                calendarGrid.appendChild(dayCell);
            }
        }

        function openCalendarDetailModal(dateStr, foods, waterCount, exercises) {
            document.getElementById('calendar-detail-title').textContent = `${dateStr} ê¸°ë¡`;
            const listEl = document.getElementById('calendar-detail-list');
            listEl.innerHTML = '';
            
            const waterItem = document.createElement('div');
            waterItem.className = 'bg-sky-50 p-4 rounded-2xl flex items-center';
            waterItem.innerHTML = `<span class="text-2xl mr-4">ğŸ’§</span><div class="flex-grow"><p class="font-semibold text-sky-800">ì´ ìˆ˜ë¶„ ì„­ì·¨</p><p class="text-sm text-sky-600">${waterCount} ì” (${waterCount * 250}ml)</p></div>`;
            listEl.appendChild(waterItem);

            const exerciseTitle = document.createElement('h3');
            exerciseTitle.className = 'text-lg font-jua text-green-600 mt-4 mb-2';
            exerciseTitle.textContent = 'ìš´ë™ ê¸°ë¡';
            listEl.appendChild(exerciseTitle);

            if (exercises.length === 0) { listEl.innerHTML += '<p class="text-center text-slate-400 py-4">ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; } 
            else { exercises.forEach(ex => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl custom-shadow flex items-center';
                    item.innerHTML = `<span class="text-2xl mr-4">ğŸ‹ï¸â€â™€ï¸</span><div class="flex-grow"><p class="font-semibold text-slate-800">${ex.name}</p><p class="text-sm text-slate-500">${ex.duration}ë¶„ | ${ex.calories}kcal ì†Œëª¨</p></div>`;
                    listEl.appendChild(item);
                });
            }

            const foodTitle = document.createElement('h3');
            foodTitle.className = 'text-lg font-jua text-green-600 mt-4 mb-2';
            foodTitle.textContent = 'ì‹ë‹¨ ê¸°ë¡';
            listEl.appendChild(foodTitle);

            if (foods.length === 0) { listEl.innerHTML += '<p class="text-center text-slate-400 py-4">ê¸°ë¡ëœ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; } 
            else { foods.forEach(food => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl custom-shadow flex items-center';
                    const imageHtml = food.photo ? `<img src="${food.photo}" class="w-12 h-12 rounded-lg object-cover mr-4">` : `<div class="w-12 h-12 rounded-lg bg-green-50 flex-shrink-0 mr-4"></div>`;
                    item.innerHTML = `${imageHtml}<div class="flex-grow"><p class="font-semibold text-slate-800">${food.name}</p><p class="text-sm text-slate-500">${food.calories}kcal | íƒ„ ${food.carbs}g, ë‹¨ ${food.protein}g, ì§€ ${food.fat}g</p></div>`;
                    listEl.appendChild(item);
                });
            }
            openModal(document.getElementById('calendar-detail-modal'));
        }

        async function callGeminiAPI(prompt, schema) {
            try { const result = await callGeminiAPI_server({ prompt, schema }); return result.data.result; } 
            catch (error) { console.error("Firebase Function í˜¸ì¶œ ì‹¤íŒ¨:", error); throw error; }
        }
        
        async function callGeminiNutritionAPI(foodString) {
            const prompt = `'${foodString}'ì˜ ì˜ˆìƒ ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© í•¨ëŸ‰ì„ ê³„ì‚°í•´ì„œ JSON í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì¤˜. ê°’ì€ ì†Œìˆ˜ì  ì—†ì´ ì •ìˆ˜ë¡œë§Œ ì œê³µí•´ì•¼ í•´.`;
            const schema = { type: "OBJECT", properties: { calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" } } };
             try { const result = await callGeminiAPI_server({ prompt, schema }); return result.data.result; } 
             catch (error) { console.error("Firebase Function í˜¸ì¶œ ì‹¤íŒ¨ (Nutrition):", error); throw error; }
        }
        
        async function callGeminiVisionAPI(base64ImageData) {
            const prompt = "ì´ ìŒì‹ ì‚¬ì§„ì„ ë¶„ì„í•´ì„œ, ìŒì‹ ì´ë¦„, ì˜ˆìƒ ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© í•¨ëŸ‰, ê·¸ë¦¬ê³  ì´ ìŒì‹ì— ëŒ€í•œ ê°„ë‹¨í•œ ì˜ì–‘í•™ì  ì¡°ì–¸ì´ë‚˜ íŒì„ JSON í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì¤˜.";
            const schema = { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, carbs: { type: "NUMBER" }, protein: { type: "NUMBER" }, fat: { type: "NUMBER" }, tip: { type: "STRING" } } };
            try { const result = await callGeminiVisionAPI_server({ base64ImageData, prompt, schema }); return result.data.result; } 
            catch (error) { console.error("Firebase Function í˜¸ì¶œ ì‹¤íŒ¨ (Vision):", error); throw error; }
        }
        
        function renderPhotoAnalysisResult(data) {
            const resultView = document.getElementById('photo-result-view');
            resultView.innerHTML = `<div class="text-center"><p class="text-sm text-slate-500">AI ë¶„ì„ ê²°ê³¼</p><p class="text-2xl font-jua text-green-600 my-2">${data.name}</p></div><div class="my-4 bg-green-50 p-4 rounded-2xl space-y-2 text-sm"><div class="flex justify-between"><span>ğŸ”¥ ì¹¼ë¡œë¦¬</span><span class="font-semibold">${data.calories} kcal</span></div><div class="flex justify-between"><span>ğŸ íƒ„ìˆ˜í™”ë¬¼</span><span class="font-semibold">${data.carbs} g</span></div><div class="flex justify-between"><span>ğŸ— ë‹¨ë°±ì§ˆ</span><span class="font-semibold">${data.protein} g</span></div><div class="flex justify-between"><span>ğŸ¥‘ ì§€ë°©</span><span class="font-semibold">${data.fat} g</span></div></div><div class="my-4 text-center text-sm bg-sky-50 text-sky-700 p-3 rounded-2xl"><p>ğŸ’¡ <strong>ì˜ì–‘ íŒ:</strong> ${data.tip}</p></div><button id="log-photo-result" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition">ê¸°ë¡í•˜ê¸°</button>`;
            document.getElementById('log-photo-result').addEventListener('click', () => { logFoodItem({ name: `(ì‚¬ì§„) ${data.name}`, ...data, timestamp: Date.now(), photo: selectedImageBase64 }); closePhotoAnalysisModal(); });
        }

        function handleImageSelection(event, previewElement, callback) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                callback(reader.result);
                previewElement.style.backgroundImage = `url('${reader.result}')`;
                previewElement.style.backgroundSize = 'cover';
                previewElement.style.backgroundPosition = 'center';
                previewElement.innerHTML = '';
            };
            reader.readAsDataURL(file);
        }

        function openModal(modal) { modal.classList.remove('pointer-events-none', 'opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }
        function closeModal(modal) { modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('scale-95'); setTimeout(() => modal.classList.add('pointer-events-none'), 300); }
        function openProfileModal() { if(userProfile) { document.getElementById('gender').value = userProfile.gender || 'female'; document.getElementById('age').value = userProfile.age || ''; document.getElementById('height').value = userProfile.height || ''; document.getElementById('weight').value = userProfile.weight || ''; document.getElementById('activity').value = userProfile.activity || '1.55'; document.getElementById('goal').value = userProfile.goal || 'maintain'; } openModal(document.getElementById('profile-modal')); }
        function openAddFoodModal() { openModal(document.getElementById('add-food-modal')); }
        function closeAddFoodModal() { 
            const addFoodModal = document.getElementById('add-food-modal');
            closeModal(addFoodModal);
            setTimeout(() => {
                document.getElementById('add-food-form').reset();
                manualImageBase64 = null;
                const manualImagePreview = document.getElementById('manual-image-preview');
                manualImagePreview.style.backgroundImage = '';
                manualImagePreview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg><p class="mt-2 text-sm font-semibold">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</p>';
            }, 300);
        }
        function openPhotoAnalysisModal() { openModal(document.getElementById('photo-analysis-modal')); }
        function closePhotoAnalysisModal() { 
            const photoAnalysisModal = document.getElementById('photo-analysis-modal');
            closeModal(photoAnalysisModal);
            setTimeout(() => {
                document.getElementById('photo-upload-view').classList.remove('hidden');
                document.getElementById('photo-loading-view').classList.add('hidden');
                document.getElementById('photo-result-view').classList.add('hidden');
                const imagePreview = document.getElementById('image-preview');
                imagePreview.style.backgroundImage = '';
                imagePreview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><p class="mt-2 font-semibold">ì‚¬ì§„ì„ ì—¬ê¸°ì— ì˜¬ë ¤ì£¼ì„¸ìš”</p>';
                document.getElementById('photo-input').value = '';
                selectedImageBase64 = null;
                document.getElementById('analyze-photo-button').disabled = true;
            }, 300);
        }
        
        let toastTimer;
        function showToast(message) { const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); toastMessage.textContent = message; toast.classList.remove('opacity-0', 'translate-y-2'); clearTimeout(toastTimer); toastTimer = setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-2'); }, 3000); }

        let currentWaterIntake = 0;
        function updateWaterUI(count) { 
            const waterIntakeEl = document.getElementById('water-intake');
            if(waterIntakeEl) {
                currentWaterIntake = count;
                waterIntakeEl.textContent = count; 
            }
        }
        async function updateWaterInDB(newCount) { 
            if (newCount < 0) newCount = 0; 
            const today = new Date().toISOString().slice(0, 10); 
            const waterRef = doc(db, `artifacts/${appId}/users/${MOCK_USER_ID}/water`, today); 
            try { await setDoc(waterRef, { count: newCount }); renderCalendar(); } 
            catch (error) { showToast('ë¬¼ ì„­ì·¨ëŸ‰ ê¸°ë¡ ì‹¤íŒ¨.'); } 
        }

    </script>
</body>
</html>
