<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitMeal - AI 식단 관리</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 기본 폰트 및 부드러운 스크롤 적용 */
        html {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* 커스텀 스크롤바 (선택 사항) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* 간단한 페이드인 애니메이션 */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
    </style>
    <!-- Google Fonts (Inter) 로드 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">

    <!-- 이 div가 전체 앱의 컨테이너 역할을 합니다. -->
    <div id="app-container"></div>

    <script>
        // --- 앱 상태 관리 ---
        let state = {
            currentPage: 'login', // 현재 보여줄 페이지 (login, register, onboarding, dashboard)
            isLoggedIn: false,
            user: null, // { name, goal, carbsGoal, proteinGoal, fatGoal }
            foodEntries: {}, // { 'YYYY-MM-DD': [...] }
            currentDate: new Date().toISOString().split('T')[0], // 날짜를 문자열로 관리
        };

        // --- 데이터베이스 시뮬레이션 ---
        const mockDB = {
            users: {
                'test@fitmeal.com': {
                    password: 'password123',
                    name: '피트밀',
                    goal: 2000,
                    carbsGoal: 250,
                    proteinGoal: 120,
                    fatGoal: 67,
                }
            }
        };
        
        // --- 데이터 영속성 (LocalStorage) ---
        const saveState = () => {
            localStorage.setItem('fitmealState', JSON.stringify(state));
        };

        const loadState = () => {
            const savedState = localStorage.getItem('fitmealState');
            if (savedState) {
                state = JSON.parse(savedState);
            }
        };

        // --- 템플릿 (HTML 조각) ---
        
        const LoginPage = () => `
            <div class="flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
                <div class="w-full max-w-sm">
                    <h1 class="text-4xl font-bold text-center text-teal-500 mb-2">FitMeal</h1>
                    <p class="text-center text-gray-600 mb-8">AI 식단 관리, 피트밀과 함께</p>
                    <form id="login-form" class="bg-white shadow-lg rounded-lg px-8 pt-6 pb-8 mb-4">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">이메일</label>
                            <input class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" id="email" type="email" value="test@fitmeal.com" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="password">비밀번호</label>
                            <input class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" id="password" type="password" value="password123" required>
                        </div>
                        <button class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300" type="submit">로그인</button>
                    </form>
                    <p class="text-center text-gray-500 text-sm">계정이 없으신가요? <button onclick="navigate('register')" class="font-bold text-teal-500 hover:text-teal-700">회원가입</button></p>
                </div>
            </div>
        `;

        const RegisterPage = () => `
            <div class="flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
                <div class="w-full max-w-sm">
                    <h1 class="text-4xl font-bold text-center text-teal-500 mb-8">회원가입</h1>
                    <form id="register-form" class="bg-white shadow-lg rounded-lg px-8 pt-6 pb-8 mb-4">
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">이메일</label><input class="w-full p-3 border border-gray-300 rounded-lg" id="email" type="email" required></div>
                        <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label><input class="w-full p-3 border border-gray-300 rounded-lg" id="password" type="password" required></div>
                        <button class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg" type="submit">다음</button>
                    </form>
                    <p class="text-center text-gray-500 text-sm">이미 계정이 있으신가요? <button onclick="navigate('login')" class="font-bold text-teal-500 hover:text-teal-700">로그인</button></p>
                </div>
            </div>
        `;

        const OnboardingPage = () => `
            <div class="flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
                <div class="w-full max-w-md text-center">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">FitMeal에 오신 것을 환영합니다!</h1>
                    <p class="text-gray-600 mb-8">정확한 추천을 위해 목표를 알려주세요.</p>
                    <form id="onboarding-form" class="bg-white shadow-lg rounded-lg p-8">
                        <div class="mb-6">
                            <label class="block text-gray-700 text-lg font-bold mb-4">가장 중요한 목표는 무엇인가요?</label>
                            <div id="goal-options" class="flex flex-col sm:flex-row justify-center gap-4">
                                <button type="button" data-goal="체중 감량" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition bg-teal-500 border-teal-500 text-white">체중 감량</button>
                                <button type="button" data-goal="체중 유지" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition border-gray-300 text-gray-700">체중 유지</button>
                                <button type="button" data-goal="근육 증가" class="goal-btn w-full p-4 border-2 rounded-lg font-semibold transition border-gray-300 text-gray-700">근육 증가</button>
                            </div>
                        </div>
                        <button class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg" type="submit">피트밀 시작하기</button>
                    </form>
                </div>
            </div>
        `;

        const DashboardPage = () => {
            const dateKey = state.currentDate;
            const todaysEntries = state.foodEntries[dateKey] || [];
            
            const totals = todaysEntries.reduce((acc, entry) => {
                acc.calories += entry.calories;
                acc.carbs += entry.carbs;
                acc.protein += entry.protein;
                acc.fat += entry.fat;
                return acc;
            }, { calories: 0, carbs: 0, protein: 0, fat: 0 });

            const meals = { '아침': [], '점심': [], '저녁': [], '간식': [] };
            todaysEntries.forEach(entry => meals[entry.mealType].push(entry));

            const caloriePercentage = state.user.goal > 0 ? Math.min((totals.calories / state.user.goal) * 100, 100) : 0;
            const circumference = 2 * Math.PI * 50;
            const strokeDashoffset = circumference - (caloriePercentage / 100) * circumference;

            return `
                <div class="min-h-screen bg-gray-50 animate-fade-in">
                    <header class="bg-white shadow-sm sticky top-0 z-10">
                        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-teal-500">FitMeal</h1>
                            <button onclick="handleLogout()" class="text-sm text-gray-600 hover:text-teal-500">로그아웃</button>
                        </div>
                    </header>
                    
                    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="changeDate(-1)" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold">&lt;</button>
                            <h2 class="text-xl font-semibold text-gray-800">${new Date(dateKey).toLocaleDateString('ko-KR')}</h2>
                            <button onclick="changeDate(1)" class="p-2 rounded-full hover:bg-gray-200 text-xl font-bold">&gt;</button>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                            <div class="flex flex-col md:flex-row items-center justify-around gap-8">
                                <!-- Calorie Chart -->
                                <div class="relative flex items-center justify-center w-48 h-48">
                                    <svg class="w-full h-full" viewBox="0 0 120 120">
                                        <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60"/>
                                        <circle class="text-teal-500" stroke-width="10" stroke-dasharray="${circumference}" stroke-dashoffset="${strokeDashoffset}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60" transform="rotate(-90 60 60)"/>
                                    </svg>
                                    <div class="absolute flex flex-col items-center">
                                        <span class="text-3xl font-bold text-gray-800">${totals.calories}</span>
                                        <span class="text-sm text-gray-500">/ ${state.user.goal} kcal</span>
                                    </div>
                                </div>
                                <!-- Nutrient Bars -->
                                <div class="w-full md:w-1/2 space-y-4">
                                    ${NutrientBar('탄수화물', totals.carbs, state.user.carbsGoal, 'bg-orange-500')}
                                    ${NutrientBar('단백질', totals.protein, state.user.proteinGoal, 'bg-sky-500')}
                                    ${NutrientBar('지방', totals.fat, state.user.fatGoal, 'bg-amber-400')}
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            ${Object.entries(meals).map(([mealType, entries]) => MealCard(mealType, entries)).join('')}
                        </div>
                    </main>

                    <div class="fixed bottom-6 right-6">
                        <button onclick="openModal()" class="bg-teal-500 text-white w-16 h-16 flex items-center justify-center text-3xl rounded-full shadow-lg hover:bg-teal-600 transition duration-300">+</button>
                    </div>

                    <div id="add-food-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        ${AddFoodModal()}
                    </div>
                </div>
            `;
        };

        const NutrientBar = (label, consumed, goal, color) => {
            const percentage = goal > 0 ? Math.min((consumed / goal) * 100, 100) : 0;
            return `
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700">${label}</span>
                        <span class="text-xs text-gray-500">${consumed}g / ${goal}g</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="${color} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        };

        const MealCard = (mealType, entries) => `
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800 mb-4">${mealType}</h3>
                ${entries.length > 0 ? `
                    <ul class="divide-y divide-gray-200">
                        ${entries.map(entry => `
                            <li class="py-3 flex justify-between items-center">
                                <div>
                                    <p class="font-semibold text-gray-700">${entry.name}</p>
                                    <p class="text-sm text-gray-500">${entry.calories} kcal</p>
                                </div>
                                <button onclick="deleteFood(${entry.id})" class="text-red-500 hover:text-red-700 font-bold text-xl">×</button>
                            </li>
                        `).join('')}
                    </ul>
                ` : `<p class="text-gray-500 text-sm">기록된 식단이 없어요.</p>`}
            </div>
        `;

        const AddFoodModal = () => `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative animate-fade-in">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 font-bold text-xl">×</button>
                <h2 class="text-2xl font-bold mb-4 text-gray-800">식단 기록하기</h2>
                <form id="add-food-form">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">식사 종류</label>
                        <select id="mealType" class="w-full p-3 border rounded-lg bg-gray-50">
                            <option>아침</option><option>점심</option><option>저녁</option><option>간식</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">음식 이름</label>
                        <input id="foodName" type="text" placeholder="예: 닭가슴살 샐러드" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold mb-2">칼로리 (kcal)</label>
                        <input id="calories" type="number" placeholder="예: 350" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-teal-500 text-white font-bold py-3 rounded-lg hover:bg-teal-600 transition">기록 추가</button>
                </form>
            </div>
        `;

        // --- 렌더링 및 이벤트 핸들러 ---
        const appContainer = document.getElementById('app-container');

        const render = () => {
            if (state.isLoggedIn) {
                state.currentPage = 'dashboard';
            }
            
            if (state.currentPage === 'login') appContainer.innerHTML = LoginPage();
            else if (state.currentPage === 'register') appContainer.innerHTML = RegisterPage();
            else if (state.currentPage === 'onboarding') appContainer.innerHTML = OnboardingPage();
            else if (state.currentPage === 'dashboard') appContainer.innerHTML = DashboardPage();
            
            addEventListeners();
            saveState(); // 모든 렌더링 후에 상태를 저장
        };

        const navigate = (page) => {
            state.currentPage = page;
            render();
        };

        const addEventListeners = () => {
            if (state.currentPage === 'login') {
                document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            }
            if (state.currentPage === 'register') {
                document.getElementById('register-form')?.addEventListener('submit', handleRegister);
            }
            if (state.currentPage === 'onboarding') {
                document.getElementById('onboarding-form')?.addEventListener('submit', handleOnboarding);
                document.querySelectorAll('.goal-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.goal-btn').forEach(b => b.classList.remove('bg-teal-500', 'text-white', 'border-teal-500'));
                        e.currentTarget.classList.add('bg-teal-500', 'text-white', 'border-teal-500');
                    });
                });
            }
            if (state.currentPage === 'dashboard') {
                 document.getElementById('add-food-form')?.addEventListener('submit', handleAddFood);
            }
        };
        
        // --- 기능 로직 ---
        const handleLogin = (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            if (mockDB.users[email] && mockDB.users[email].password === password) {
                state.isLoggedIn = true;
                state.user = mockDB.users[email];
                navigate('dashboard');
            } else {
                alert('이메일 또는 비밀번호가 일치하지 않습니다.');
            }
        };

        const handleRegister = (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            if (mockDB.users[email]) {
                alert('이미 가입된 이메일입니다.');
                return;
            }
            // 새 사용자 정보를 mockDB에 추가 (시뮬레이션)
            mockDB.users[email] = { password, name: '새 사용자' };
            navigate('onboarding');
        };

        const handleOnboarding = (e) => {
            e.preventDefault();
            const selectedGoal = document.querySelector('.goal-btn.bg-teal-500').dataset.goal;
            let calorieGoal = 2000;
            if (selectedGoal === '체중 감량') calorieGoal = 1800;
            if (selectedGoal === '근육 증가') calorieGoal = 2500;
            
            state.isLoggedIn = true;
            state.user = {
                ...state.user,
                goal: calorieGoal,
                carbsGoal: Math.round(calorieGoal * 0.5 / 4),
                proteinGoal: Math.round(calorieGoal * 0.3 / 4),
                fatGoal: Math.round(calorieGoal * 0.2 / 9)
            };
            navigate('dashboard');
        };

        const handleLogout = () => {
            state.isLoggedIn = false;
            state.user = null;
            // 로그아웃 시 저장된 상태의 일부만 초기화
            state.currentPage = 'login';
            render();
        };

        const changeDate = (amount) => {
            const currentDateObj = new Date(state.currentDate);
            currentDateObj.setDate(currentDateObj.getDate() + amount);
            state.currentDate = currentDateObj.toISOString().split('T')[0];
            render();
        };

        const openModal = () => document.getElementById('add-food-modal').classList.remove('hidden');
        const closeModal = () => document.getElementById('add-food-modal').classList.add('hidden');

        const handleAddFood = (e) => {
            e.preventDefault();
            const newEntry = {
                id: Date.now(),
                name: e.target.foodName.value,
                calories: parseInt(e.target.calories.value),
                mealType: e.target.mealType.value,
                carbs: Math.round(parseInt(e.target.calories.value) * 0.5 / 4),
                protein: Math.round(parseInt(e.target.calories.value) * 0.2 / 4),
                fat: Math.round(parseInt(e.target.calories.value) * 0.3 / 9),
            };

            const dateKey = state.currentDate;
            if (!state.foodEntries[dateKey]) {
                state.foodEntries[dateKey] = [];
            }
            state.foodEntries[dateKey].push(newEntry);
            
            closeModal();
            render();
        };

        const deleteFood = (id) => {
            const dateKey = state.currentDate;
            state.foodEntries[dateKey] = state.foodEntries[dateKey].filter(entry => entry.id !== id);
            render();
        };


        // --- 앱 시작 ---
        window.onload = () => {
            loadState(); // 앱이 시작될 때 저장된 상태를 불러옵니다.
            render();
        };

    </script>
</body>
</html>
