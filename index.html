<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitMeal - AI ì‹ë‹¨ ê´€ë¦¬ (Final Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        html { font-family: 'Inter', sans-serif; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .btn-interactive { transition: transform 0.1s ease; }
        .btn-interactive:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app-container"></div>
<script>
    const App = {
        config: {
            firebase: { apiKey: "AIzaSyCRax6rd1rlBIc3kVgg5OkHmSIQyzJmC8A", authDomain: "fitmeal-app-d1a97.firebaseapp.com", projectId: "fitmeal-app-d1a97", storageBucket: "fitmeal-app-d1a97.appspot.com", messagingSenderId: "968711774677", appId: "1:968711774677:web:b3d3cb9ccc2388c3ba5d5c" },
            geminiKey: "AIzaSyDI3SsZ3cLDWdAfoVVeMe1NplZxhB91wCk"
        },
        
        state: {
            currentPage: 'loading',
            isLoading: true,
            user: null,
            foodEntries: {},
            currentDate: new Date().toISOString().split('T')[0]
        },

        init() {
            firebase.initializeApp(this.config.firebase);
            this.auth = firebase.auth();
            this.db = firebase.firestore();
            this.auth.onAuthStateChanged(this.handlers.onAuthStateChanged.bind(this));
            this.render();
        },

        setState(newState) {
            this.state = { ...this.state, ...newState };
            window.requestAnimationFrame(() => this.render());
        },

        render() {
            const { currentPage, isLoading } = this.state;
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            if (isLoading) {
                appContainer.innerHTML = `<div class="flex items-center justify-center min-h-screen"><p class="text-gray-500">FitMealì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p></div>`;
                return;
            }

            let pageHtml = '';
            switch(currentPage) {
                case 'login': pageHtml = this.components.LoginPage(); break;
                case 'register': pageHtml = this.components.RegisterPage(); break;
                case 'onboarding': pageHtml = this.components.OnboardingPage(); break;
                case 'dashboard': pageHtml = this.components.DashboardPage(this.state); break;
                default: pageHtml = `<div class="p-4 text-center">í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
            appContainer.innerHTML = pageHtml;
            this.addEventListeners();
        },

        addEventListeners() {
            const { currentPage } = this.state;
            if (currentPage === 'login') document.getElementById('login-form')?.addEventListener('submit', this.handlers.handleLogin.bind(this));
            if (currentPage === 'register') document.getElementById('register-form')?.addEventListener('submit', this.handlers.handleRegister.bind(this));
            if (currentPage === 'onboarding') {
                document.getElementById('onboarding-form')?.addEventListener('submit', this.handlers.handleOnboarding.bind(this));
                document.querySelectorAll('.goal-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.goal-btn').forEach(b => b.classList.remove('bg-teal-500', 'text-white', 'border-teal-500'));
                    e.currentTarget.classList.add('bg-teal-500', 'text-white', 'border-teal-500');
                }));
            }
            if (currentPage === 'dashboard') {
                document.getElementById('food-image-input')?.addEventListener('change', this.handlers.handleImagePreview);
                document.getElementById('ai-analyze-btn')?.addEventListener('click', this.handlers.handlePhotoAnalysis.bind(this));
                document.getElementById('record-selected-btn')?.addEventListener('click', this.handlers.handleAddSelectedFoods.bind(this));
                window.openModal = this.handlers.openModal;
                window.closeModal = this.handlers.closeModal;
                window.deleteFood = this.handlers.deleteFood.bind(this);
                window.changeDate = this.handlers.changeDate.bind(this);
            }
            window.navigate = this.handlers.navigateTo;
        },

        handlers: {
            async onAuthStateChanged(firebaseUser) {
                try {
                    if (firebaseUser) {
                        const userProfile = await App.api.getUserProfile(firebaseUser.uid);
                        const user = userProfile 
                            ? { uid: firebaseUser.uid, email: firebaseUser.email, ...userProfile }
                            : { uid: firebaseUser.uid, email: firebaseUser.email };

                        const foodEntries = await App.api.getFoodEntries(user.uid, App.state.currentDate);
                        App.setState({ 
                            user, 
                            foodEntries: { [App.state.currentDate]: foodEntries }, 
                            isLoading: false, 
                            currentPage: user.goal ? 'dashboard' : 'onboarding' 
                        });
                    } else {
                        App.setState({ user: null, isLoading: false, currentPage: 'login' });
                    }
                } catch (error) {
                    console.error("ì¸ì¦ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:", error);
                    document.getElementById('app-container').innerHTML = `<div class="p-4 text-center text-red-500">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</div>`;
                }
            },
            navigateTo(page) { App.setState({ currentPage: page }); },
            handleImagePreview(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); const preview = document.getElementById('image-preview'); if (preview) { reader.onload = (event) => { preview.src = event.target.result; preview.classList.remove('hidden'); }; reader.readAsDataURL(file); } },
            async handleLogin(e) { e.preventDefault(); const btn = document.getElementById('login-btn'); btn.disabled = true; btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...'; try { await App.api.signIn(e.target.email.value, e.target.password.value); } catch (error) { alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`); btn.disabled = false; btn.textContent = 'ë¡œê·¸ì¸'; } },
            async handleRegister(e) { e.preventDefault(); const btn = e.target.querySelector('button'); btn.disabled = true; try { await App.api.register(e.target.email.value, e.target.password.value); } catch (error) { alert(error.message); btn.disabled = false; } },
            handleLogout() { App.auth.signOut(); },
            async handleOnboarding(e) { e.preventDefault(); const el = document.querySelector('.goal-btn.bg-teal-500'); if (!el) return alert('ëª©í‘œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); let goal = 2000; if (el.dataset.goal === 'ì²´ì¤‘ ê°ëŸ‰') goal = 1800; if (el.dataset.goal === 'ê·¼ìœ¡ ì¦ê°€') goal = 2500; const userData = { goal, carbsGoal: Math.round(goal*0.5/4), proteinGoal: Math.round(goal*0.3/4), fatGoal: Math.round(goal*0.2/9) }; await App.api.updateUserProfile(this.state.user.uid, userData); },
            async handlePhotoAnalysis() {
                const fileInput = document.getElementById('food-image-input'); if (!fileInput.files.length) return alert('ë¶„ì„í•  ìŒì‹ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                const analyzeBtn = document.getElementById('ai-analyze-btn'); analyzeBtn.disabled = true; analyzeBtn.textContent = 'ë¶„ì„ ì¤‘...';
                const resultsContainer = document.getElementById('ai-results-container'); resultsContainer.innerHTML = '<p class="text-center text-gray-500">AIê°€ ì‚¬ì§„ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ¤–</p>';
                try {
                    const foodItems = await App.api.analyzePhoto(fileInput.files[0]);
                    const recordBtn = document.getElementById('record-selected-btn');
                    if (!foodItems || !foodItems.length) { resultsContainer.innerHTML = '<p class="text-center text-gray-500">ë¶„ì„ëœ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; recordBtn.classList.add('hidden'); return; }
                    resultsContainer.innerHTML = App.components.AIResultList(foodItems);
                    recordBtn.classList.remove('hidden');
                } catch (error) { resultsContainer.innerHTML = `<p class="text-center text-red-500">ì‚¬ì§„ ë¶„ì„ ì‹¤íŒ¨: ${error.message}</p>`; } finally { analyzeBtn.disabled = false; analyzeBtn.textContent = 'AIë¡œ ë¶„ì„í•˜ê¸°'; }
            },
            async handleAddSelectedFoods() { const sel = document.querySelectorAll('#ai-results-container input:checked'); if (!sel.length) return alert('ê¸°ë¡í•  ìŒì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); const btn = document.getElementById('record-selected-btn'); btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...'; const entries = Array.from(sel).map(cb => ({ name: cb.dataset.name, calories: parseInt(cb.dataset.calories), carbs: parseInt(cb.dataset.carbs), protein: parseInt(cb.dataset.protein), fat: parseInt(cb.dataset.fat), mealType: document.getElementById('mealType').value })); try { await App.api.addFoodEntries(this.state.user.uid, this.state.currentDate, entries); } catch(e) { alert('ì €ì¥ ì‹¤íŒ¨: '+e.message); btn.disabled = false; btn.textContent = 'ì„ íƒ í•­ëª© ê¸°ë¡í•˜ê¸°'; } },
            async deleteFood(id) { if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await App.api.deleteFoodEntry(this.state.user.uid, this.state.currentDate, id); const newEntries = await this.api.getFoodEntries(this.state.user.uid, this.state.currentDate); this.setState({ foodEntries: { ...this.state.foodEntries, [this.state.currentDate]: newEntries } }); }},
            async changeDate(amount) { const d = new Date(this.state.currentDate); d.setDate(d.getDate() + amount); const newDate = d.toISOString().split('T')[0]; const newEntries = await this.api.getFoodEntries(this.state.user.uid, newDate); this.setState({ currentDate: newDate, foodEntries: { ...this.state.foodEntries, [newDate]: newEntries } }); },
            openModal() { document.getElementById('add-food-modal')?.classList.remove('hidden'); },
            closeModal() { document.getElementById('add-food-modal')?.classList.add('hidden'); },
        },

        api: {
            fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = reject; }); },
            async signIn(email, password) { return App.auth.signInWithEmailAndPassword(email, password); },
            async register(email, password) { const cred = await App.auth.createUserWithEmailAndPassword(email, password); return App.db.collection('users').doc(cred.user.uid).set({ email: cred.user.email, name: 'ìƒˆ ì‚¬ìš©ì' }); },
            async getUserProfile(uid) { const doc = await App.db.collection('users').doc(uid).get(); return doc.exists ? doc.data() : null; },
            async updateUserProfile(uid, data) { return App.db.collection('users').doc(uid).set(data, { merge: true }); },
            async getFoodEntries(uid, date) { const snapshot = await App.db.collection('users').doc(uid).collection(date).orderBy('createdAt').get(); return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); },
            async analyzePhoto(file) { const base64Image = await this.fileToBase64(file); const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${App.config.geminiKey}`; const prompt = "ì´ ì‚¬ì§„ì— ìˆëŠ” ëª¨ë“  ìŒì‹ ê°ê°ì— ëŒ€í•´ ì´ë¦„, ì˜ˆìƒ ì¹¼ë¡œë¦¬(kcal), íƒ„ìˆ˜í™”ë¬¼(g), ë‹¨ë°±ì§ˆ(g), ì§€ë°©(g)ì„ ì¶”ì¶œí•´ì„œ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì¤˜. ìŒì‹ê³¼ ê´€ë ¨ì—†ëŠ” ê°ì²´ëŠ” ì œì™¸í•´ì¤˜. ìˆ«ìëŠ” ì •ìˆ˜ë¡œ ë°˜ì˜¬ë¦¼í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ìˆœìˆ˜ JSON ë°°ì—´ë§Œ ì‘ë‹µí•´ì¤˜."; const requestBody = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: file.type, data: base64Image } }] }] }; const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) }); if (!response.ok) throw new Error(`API ì˜¤ë¥˜: ${response.status}`); const data = await response.json(); let jsonString = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]'; try { return JSON.parse(jsonString.replace(/```json|```/g, '').trim()); } catch(e) { console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e, "ì›ë³¸:", jsonString); throw new Error("AI ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }},
            async addFoodEntries(uid, date, entries) { const batch = App.db.batch(); const ref = App.db.collection('users').doc(uid).collection(date); entries.forEach(entry => { entry.createdAt = firebase.firestore.FieldValue.serverTimestamp(); batch.set(ref.doc(), entry); }); await batch.commit(); App.handlers.closeModal(); const newEntries = await App.api.getFoodEntries(uid, date); App.setState({ foodEntries: { ...App.state.foodEntries, [date]: newEntries } }); },
            async deleteFoodEntry(uid, date, entryId) { return App.db.collection('users').doc(uid).collection(date).doc(entryId).delete(); },
        },

        components: {
            Logo, LoginPage, RegisterPage, OnboardingPage, DashboardPage, NutrientBar, MealCard, AddFoodModal,
            AIResultList(foodItems) { return `<h4 class="font-bold mb-2 text-gray-700">ë¶„ì„ ê²°ê³¼</h4><ul class="space-y-2">${foodItems.map((item, index) => `<li class="flex items-center p-3 bg-gray-50 rounded-lg"><input id="food-${index}" type="checkbox" class="h-5 w-5 rounded" data-name="${item.name||''}" data-calories="${item.calories||0}" data-carbs="${item.carbs||0}" data-protein="${item.protein||0}" data-fat="${item.fat||0}" checked><label for="food-${index}" class="ml-3"><span class="font-semibold">${item.name||'ì´ë¦„ì—†ìŒ'}</span><span class="text-sm text-gray-500"> - ${item.calories||0} kcal</span></label></li>`).join('')}</ul>`; }
        }
    };
    
    App.init();
</script>
</body>
</html>
